<!DOCTYPE html>  
<html lang="en">  
<head>  
  <meta charset="UTF-8">  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">  
  <title>Workout Detail: {{workout_id}}</title>  
  <style>  
  :root {  
    --atlas-green: #00ED64;         /* MongoDB Green */  
    --atlas-green-darker: #00A343;  /* Darker Green for hover/accents */  
    --atlas-dark-blue: #132A38;     /* Main container background */  
    --atlas-bg: #0C1822;            /* Deep background */  
    --atlas-light-text: #E4EAF0;    /* Primary text color - Lighter */  
    --atlas-mid-text: #A7B6C2;      /* Secondary text color - Lighter */  
    --atlas-border: #2A506F;        /* Border color - More contrast */  
    --atlas-hover-bg: #1C3A50;      /* Background for hover/items */  
    --atlas-delete-red: #FF6868;    /* Lighter red for delete */  
    --atlas-delete-border: #B34949; /* Darker red border */  
    --button-text-dark: #0C1822;    /* Text color for green button */  
    --accent-red: #FF6868;          /* Use lighter red */  
    --accent-blue: #58AEFF;         /* Use lighter blue */  
    --accent-green-viz: #34c759;    /* Specific green for viz */  
    --accent-orange: #FFA554;       /* Use lighter orange */  
    --accent-purple: #C792EA;       /* Lighter purple for pipeline */  
  }  
  
  *, *::before, *::after {  
    box-sizing: border-box;  
  }  
  
  body {  
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;  
    margin: 0;  
    padding: 0;  
    background-color: var(--atlas-bg);  
    color: var(--atlas-light-text);  
    line-height: 1.6;  
  }  
  
  #particle-canvas {  
    position: fixed;  
    top: 0;  
    left: 0;  
    width: 100%;  
    height: 100%;  
    z-index: -1;  
  }  
  
  .container {  
    max-width: 1200px;  
    margin: 30px auto;  
    padding: 25px 30px;  
    background-color: var(--atlas-dark-blue);  
    border-radius: 12px;  
    border: 1px solid var(--atlas-border);  
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3), 0 0 20px rgba(0, 237, 100, 0.15);  
    position: relative;  
    z-index: 1;  
  }  
  
  h1 {  
    color: var(--atlas-light-text);  
    border-bottom: 2px solid var(--atlas-border);  
    padding-bottom: 15px;  
    margin-top: 0;  
    font-size: 2.2em;  
  }  
  h2 {  
    color: var(--atlas-light-text);  
    border-bottom: 1px solid var(--atlas-border);  
    padding-bottom: 10px;  
    margin-top: 40px;   
    margin-bottom: 20px;  
    display: flex;  
    align-items: center;  
    gap: 12px;  
    font-size: 1.6em;  
    font-weight: 600;  
  }  
  h3 {  
    color: var(--atlas-light-text);  
    text-align: left;  
    margin-bottom: 10px;  
    margin-top: 0;  
    font-size: 1.2em;  
    font-weight: 600;  
  }  
  h4 {  
    color: var(--atlas-mid-text);  
    margin-top: 0;  
    margin-bottom: 15px;  
    font-weight: 500;  
  }  
  p, ul, li {  
    color: var(--atlas-mid-text);  
    font-size: 1.05em;   
  }  
  ul { padding-left: 25px; }  
  li { margin-bottom: 10px; }  
  a {  
    color: var(--atlas-green);  
    text-decoration: none;  
    transition: color 0.2s ease;  
  }  
  a:hover {  
    color: #fff;  
    text-decoration: underline;  
  }  
  
  /* --- Navigation & Buttons --- */  
  .control-btn,  
  .nav-link {  
    display: inline-flex;  
    align-items: center;  
    justify-content: center;  
    gap: 8px;  
    margin-bottom: 20px;  
    padding: 10px 18px;  
    background-color: var(--atlas-green);  
    color: var(--button-text-dark);  
    text-decoration: none;  
    border-radius: 8px;  
    font-weight: 600;  
    border: none;  
    cursor: pointer;  
    transition: all 0.2s ease-in-out;  
  }  
  .nav-link:hover,  
  .control-btn:hover {  
    background-color: #fff;  
    color: #000;  
    box-shadow: 0 0 15px var(--atlas-green);  
    transform: translateY(-2px);  
  }  
  .nav-link {  
    background-color: var(--atlas-hover-bg);  
    color: var(--atlas-light-text);  
    border: 1px solid var(--atlas-border);  
  }  
  .nav-link:hover {  
    border-color: var(--atlas-green);  
    color: var(--atlas-green);  
    background-color: var(--atlas-hover-bg);  
    box-shadow: 0 0 10px rgba(0, 237, 100, 0.3);  
  }  

  /* --- Channel Selectors --- */
  .channel-selectors {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    align-items: center;
    background-color: var(--atlas-hover-bg);
    padding: 15px 20px;
    border-radius: 8px;
    border: 1px solid var(--atlas-border);
    margin-bottom: 30px;
  }
  .selector-group {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .selector-group label {
    font-weight: 600;
    font-size: 1.05em;
    color: var(--atlas-light-text);
  }
  .selector-group select {
    background-color: var(--atlas-bg);
    color: var(--atlas-light-text);
    border: 1px solid var(--atlas-border);
    border-radius: 6px;
    padding: 8px 10px;
    font-size: 1em;
    font-family: inherit;
    font-weight: 500;
  }
  .channel-selectors .control-btn {
    background-color: var(--atlas-green);
    color: var(--button-text-dark);
    margin: 0; /* Reset margin for buttons inside this container */
  }
  .channel-selectors .control-btn:hover {
    background-color: #fff;
  }
  /* NEW: Style for the revert button */
  .channel-selectors .btn-revert {
    background-color: var(--atlas-hover-bg);
    color: var(--atlas-light-text);
    border: 1px solid var(--atlas-border);
    margin-left: -10px; /* Pull it closer to the other buttons */
  }
  .channel-selectors .btn-revert:hover {
    border-color: var(--atlas-green);
    color: var(--atlas-green);
    background-color: var(--atlas-hover-bg);
    box-shadow: 0 0 10px rgba(0, 237, 100, 0.3);
  }
  .channel-selectors .control-btn:disabled {
      background-color: var(--atlas-orange);
      cursor: wait;
  }
  
  /* --- Main Content Grid --- */  
  .content-grid {  
    display: grid;  
    grid-template-columns: 320px 1fr;  
    gap: 30px;   
    align-items: flex-start;  
    margin-bottom: 30px;  
  }  
  @media (max-width: 900px) {  
    .content-grid {  
      grid-template-columns: 1fr;  
    }  
    .image-box {  
      order: 1;   
      position: relative;   
      top: 0;  
    }  
    .json-box {  
      order: 2;  
    }  
  }  
  
  .image-box {  
    text-align: center;  
    position: sticky;  
    top: 25px;  
  }  
  .json-box {  
    min-width: 0;   
  }  
  
  img.main-img {  
    width: 100%;  
    max-width: 320px;  
    height: auto;  
    aspect-ratio: 1 / 1;  
    image-rendering: pixelated;  
    border: 2px solid var(--atlas-border);  
    border-radius: 8px;  
    background-color: #000;  
  }  
  
  img.channel-img {  
    width: 128px;  
    height: 128px;  
    image-rendering: pixelated;  
    display: block;  
    margin: 10px auto;  
    background-color: #000;  
    border: 1px solid var(--atlas-border);  
    border-radius: 4px;  
  }  
  
  img.chart-img {  
    width: 100%;  
    height: auto;  
    border: 1px solid var(--atlas-border);  
    border-radius: 4px;  
    margin-top: 10px;  
    background-color: var(--atlas-dark-blue);  
  }  
  
  pre {  
    background-color: var(--atlas-bg);  
    color: #CDD8E3;   
    border: 1px solid var(--atlas-border);  
    padding: 15px;  
    border-radius: 8px;  
    max-height: 450px;   
    overflow-y: auto;  
    white-space: pre-wrap;  
    word-wrap: break-word;  
    font-size: 0.95em;   
    line-height: 1.5;  
  }  
  
  .caption {  
    font-style: italic;  
    color: var(--atlas-mid-text);  
    font-size: 0.95em;  
  }  
  .caption b {  
    font-style: normal;  
    color: var(--atlas-light-text);  
  }  
  
  code {  
    background-color: var(--atlas-bg);  
    padding: 3px 6px;  
    border-radius: 4px;  
    font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;  
    color: var(--atlas-green);  
    border: 1px solid var(--atlas-border);  
    font-size: 0.9em;  
  }  
  pre code {  
    background-color: transparent;  
    color: inherit;  
    padding: 0;  
    border: none;  
    font-size: 1em;  
  }  
  
  /* --- Box Styles --- */  
  .guide-box, .ai-summary-box, .explanation-box {  
    background-color: var(--atlas-hover-bg);   
    border: 1px solid var(--atlas-border);  
    border-radius: 8px;  
    padding: 20px 30px;   
    margin-top: 40px;  
  }  
  .ai-summary-box { border-top: 4px solid var(--accent-blue); }  
  .guide-box-knn { border-top: 4px solid var(--atlas-green); }  
  .guide-box-radiologist { border-top: 4px solid var(--accent-orange); }  
  .explanation-box { border-top: 4px solid var(--accent-purple); padding-bottom: 30px; }  
  .polymorphic-box { border-top: 4px solid var(--accent-red); }  
  
  /* --- AI Summary Box --- */  
  .ai-header {  
    display: flex;  
    justify-content: space-between;  
    align-items: center;  
    flex-wrap: wrap;  
    gap: 15px;  
  }  
  .ai-summary-text {  
    font-size: 1.15em;   
    font-weight: 500;  
    color: var(--atlas-light-text);  
    border-left: 4px solid var(--accent-blue);  
    padding-left: 15px;  
    margin-top: 20px;  
    padding-top: 8px;  
    padding-bottom: 8px;  
    background-color: var(--atlas-dark-blue);  
  }  
  .ai-summary-box .control-btn,  
  .ai-summary-box .nav-link {  
    margin: 0;  
    padding: 8px 15px;  
  }  
  .ai-summary-box #analyzeBtn {  
    background-color: var(--accent-blue);  
    color: white;  
  }  
  .ai-summary-box #analyzeBtn:hover {  
    background-color: #58AEFF;  
    color: var(--button-text-dark);  
    box-shadow: 0 0 10px var(--accent-blue);  
  }  
  .ai-summary-box #analyzeBtn[disabled] {  
    background-color: var(--accent-orange);  
    color: var(--button-text-dark);  
    cursor: default;  
  }  
  .ai-summary-box #analyzeBtn[disabled]:hover {  
    box-shadow: none;  
    transform: none;  
  }  
  .ai-summary-box .btn-prompt {  
    background-color: var(--atlas-green-darker);  
    color: var(--atlas-light-text);  
  }  
  .ai-summary-box .btn-prompt:hover {  
    background-color: var(--atlas-green);  
    color: var(--button-text-dark);  
    box-shadow: 0 0 10px var(--atlas-green);  
  }  
  .ai-summary-box .button-group {  
    display: flex;  
    gap: 10px;  
  }  
  
  /* --- Modal Styles (Improved Layout & Readability) --- */  
  .modal {  
    display: none;  
    position: fixed;  
    z-index: 1000;  
    left: 0;  
    top: 0;  
    width: 100%;  
    height: 100%;  
    overflow: auto;  
    background-color: rgba(12, 24, 34, 0.8);   
    backdrop-filter: blur(8px);  
    animation: fadeIn 0.3s ease;  
  }  
  .modal-content {  
    background-color: var(--atlas-dark-blue);  
    color: var(--atlas-light-text);  
    margin: 8% auto;   
    padding: 30px 35px;   
    border: 1px solid var(--atlas-green);  
    width: 90%;  
    max-width: 850px;   
    border-radius: 12px;  
    box-shadow: 0 0 40px rgba(0, 237, 100, 0.4);   
    animation: slideIn 0.3s ease-out;  
  }  
  .modal-content h2 {  
    margin-top: 0;  
    color: var(--atlas-green);  
    font-size: 1.8em;  
    margin-bottom: 25px;   
  }  
  .modal-content p,  
  .modal-content ul,  
  .modal-content li {  
    font-size: 1.1em;   
    color: var(--atlas-light-text);  
  }  
  .modal-content li {  
    margin-bottom: 15px;  
  }  
  
  @keyframes fadeIn {  
    from { opacity: 0; }  
    to { opacity: 1; }  
  }  
  @keyframes slideIn {  
    from { transform: translateY(-50px); opacity: 0; }  
    to { transform: translateY(0); opacity: 1; }  
  }  
  
  .close-btn {  
    color: var(--atlas-mid-text);  
    float: right;  
    font-size: 35px;  
    font-weight: bold;  
    line-height: 0.8;  
  }  
  .close-btn:hover, .close-btn:focus {  
    color: var(--atlas-light-text);  
    text-decoration: none;  
    cursor: pointer;  
  }  
  .prompt-code {  
    background-color: var(--atlas-bg);  
    color: #CDD8E3;  
    padding: 15px;  
    border-radius: 5px;  
    overflow-x: auto;  
    font-family: monospace;  
    white-space: pre;  
    border: 1px solid var(--atlas-border);  
    font-size: 0.9em;  
  }  
  
  /* --- REFINED: Encoding Pipeline Story --- */  
  .encoding-pipeline {  
    margin-top: 30px;  
    padding: 25px;  
    background: var(--atlas-bg);  
    border-radius: 8px;  
    border: 1px solid var(--atlas-border);  
  }  
  .pipeline-header {  
    display: flex;  
    justify-content: space-between;  
    align-items: center;  
    flex-wrap: wrap;  
    gap: 15px;  
    margin-bottom: 25px;  
  }  
  .btn-why-cool {  
    background: transparent;  
    border: 1px solid var(--accent-orange);  
    color: var(--accent-orange);  
    padding: 8px 15px;  
    font-weight: 600;  
  }  
  .btn-why-cool:hover {  
    background: var(--accent-orange);  
    color: var(--button-text-dark);  
    box-shadow: 0 0 15px var(--accent-orange);  
    transform: translateY(-2px);  
  }  
  .pipeline-steps {  
    display: flex;  
    flex-direction: column;  
    gap: 25px;   
  }  
  .pipeline-step {  
    background: var(--atlas-dark-blue);  
    border: 1px solid var(--atlas-border);  
    padding: 25px;   
    border-radius: 8px;  
  }  
  .pipeline-step h3 {  
    margin-top: 0;  
    margin-bottom: 15px;   
    color: var(--atlas-light-text);  
    display: flex;  
    align-items: center;  
    font-size: 1.3em;  
  }  
  .step-number {  
    display: inline-flex;  
    align-items: center;  
    justify-content: center;  
    width: 30px;  
    height: 30px;  
    border-radius: 50%;  
    background: var(--atlas-green);  
    color: var(--button-text-dark);  
    font-size: 1em;  
    font-weight: 700;  
    margin-right: 15px;  
    flex-shrink: 0;  
  }  
  /* Step 1: Charts (UPDATED) */  
  .step-1-charts {  
    display: grid;  
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));   
    gap: 25px;  
    width: 100%;  
  }  
  .step-1-charts div { text-align: center; }  
  .step-1-charts h4 {  
    text-align: center;  
    margin-bottom: 10px;  
    font-size: 1.1em;  
  }  
  .step-1-charts .red { color: var(--accent-red); }  
  .step-1-charts .green { color: var(--accent-green-viz); }  
  .step-1-charts .blue { color: var(--accent-blue); }  
  .step-1-charts .orange { color: var(--accent-orange); } /* NEW */
  .step-1-charts .purple { color: var(--accent-purple); } /* NEW */
  
  /* Step 2: Fold Visualization */  
  .fold-visualization {  
    display: flex;  
    gap: 20px;  
    align-items: center;  
    flex-wrap: wrap;   
    margin-top: 15px;  
    justify-content: center;  
    background: var(--atlas-bg);  
    padding: 15px;  
    border-radius: 6px;  
  }  
  .fold-text-block {  
    font-family: "SFMono-Regular", Consolas, monospace;  
    font-size: 1.1em;   
    color: var(--atlas-mid-text);  
    line-height: 1.4;  
    max-width: 400px;   
    word-break: break-all;  
  }  
  .fold-text-block .highlight {  
    color: var(--atlas-green);  
    background: #00ed641a;   
    padding: 1px 3px;  
    border-radius: 3px;  
    font-weight: 600;  
  }  
  .fold-text-block .dim {  
    opacity: 0.6;  
  }  
  .fold-grid {  
    display: grid;  
    grid-template-columns: repeat(8, 1fr);  
    gap: 4px;  
    font-family: "SFMono-Regular", Consolas, monospace;  
    font-size: 1em;   
    background: var(--atlas-bg);  
    padding: 10px;   
    border-radius: 4px;  
    border: 1px solid var(--atlas-border);  
    min-width: 260px;  
  }  
  .fold-grid span {  
    display: inline-flex;   
    align-items: center;  
    justify-content: center;  
    width: 28px;   
    height: 28px;  
    color: var(--atlas-mid-text);  
    background: #102331;  
    border-radius: 3px;  
    border: 1px solid #1c3a50;  
  }  
  .fold-grid .highlight {  
    color: var(--atlas-green);  
    background: #00ed641a;  
    border: 1px solid var(--atlas-green);  
    font-weight: 600;  
  }  
  
  /* Step 3: Stack (Sub-steps) */  
  .step-3-substeps {  
    display: flex;  
    flex-direction: column;  
    gap: 20px;  
    margin-top: 15px;  
  }  
  .substep {  
    display: flex;  
    align-items: center;  
    gap: 20px;  
    background: var(--atlas-bg);   
    padding: 15px;  
    border-radius: 6px;  
    border: 1px solid var(--atlas-border);  
  }  
  .substep img {  
    width: 80px;   
    height: 80px;  
    margin: 0;  
    flex-shrink: 0;  
  }  
  .substep p {  
    margin: 0;  
    flex-grow: 1;  
    color: var(--atlas-light-text);  
  }  
  .substep strong {  
    color: var(--atlas-light-text);  
  }  
  .red-label { color: var(--accent-red); font-weight: 600; }  
  .green-label { color: var(--accent-green-viz); font-weight: 600; }  
  .blue-label { color: var(--accent-blue); font-weight: 600; }
  .alpha-label { color: var(--atlas-mid-text); font-weight: 600; }  
  
  .pipeline-arrow {  
    font-size: 2.5em;  
    color: var(--atlas-green);  
    font-weight: 300;  
    animation: pulse 2s infinite ease-in-out;  
    text-align: center;  
    margin: 15px 0;  
  }  
  @keyframes pulse {  
    0% { transform: scale(1); opacity: 0.7; }  
    50% { transform: scale(1.1); opacity: 1; }  
    100% { transform: scale(1); opacity: 0.7; }  
  }  
  
  /* Step 4: Flatten */  
  .step-4-content pre {  
    margin-top: 15px;  
    font-size: 0.9em;  
  }  
  
  /* Link styling within boxes */  
  .guide-box a,  
  .ai-summary-box a,  
  .explanation-box a,  
  .polymorphic-box a {  
    font-weight: 500;  
    color: var(--atlas-green);  
  }  
  .guide-box a:hover,  
  .ai-summary-box a:hover,  
  .explanation-box a:hover,  
  .polymorphic-box a:hover {  
    color: #fff;  
  }  
  
  /* Specific styling for neighbor links */  
  .guide-box-knn ul {  
    list-style-type: none;  
    padding-left: 0;  
  }  
  .guide-box-knn li {  
    background: var(--atlas-dark-blue);  
    padding: 10px 15px;  
    border-radius: 6px;  
    border: 1px solid var(--atlas-border);  
    transition: background-color 0.2s ease;  
    line-height: 1.5;  
  }  
  .guide-box-knn li:hover {  
    background-color: #1a3a53;  
  }  
  .guide-box-knn li a {  
    font-weight: 600;  
  }  
  .guide-box-knn li span {  
    color: var(--atlas-mid-text);  
    font-size: 0.9em;  
    margin-left: 8px;  
    display: inline-block;  
  }  
  
  </style>  
</head>  
<body>  
<canvas id="particle-canvas"></canvas>  
  
<div class="container">  
  
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
    <a href="/experiments/data_imaging/" class="nav-link">  
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"  
           fill="currentColor" viewBox="0 0 16 16">  
        <path fill-rule="evenodd"  
              d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5  
                   0 1 0-.708-.708l-4 4a.5.5 0 0 0 0  
                   .708l4 4a.5.5 0 0 0 .708-.708L2.707  
                   8.5H14.5A.5.5 0 0 0 15 8z"/>  
      </svg>  
      Back to Workout Gallery  
    </a>
    <a href="https://github.com/ranfysvalle02/mdb-data-imaging" target="_blank" rel="noopener noreferrer" 
       style="color: var(--atlas-green); text-decoration: none; font-size: 0.95em; font-weight: 500; transition: color 0.2s ease; display: inline-flex; align-items: center; gap: 6px;">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
      </svg>
      View on Github
    </a>
  </div>
  
  <h1>Workout Detail: {{workout_id}}</h1>  

  <div class="channel-selectors" style="border: 2px solid var(--atlas-border);">
    <div style="flex-basis: 100%; margin-bottom: 10px;">
      <p style="margin: 0; color: var(--atlas-light-text); font-size: 1.05em; font-weight: 600;">
        üîç <strong>Feature Engineering Playground</strong>
      </p>
      <p style="margin: 5px 0 0 0; color: var(--atlas-mid-text); font-size: 0.95em;">
        Mix and match different time-series metrics as RGB channels to discover hidden patterns. 
        The same workout data reveals different "fingerprints" from different perspectives!
        <strong style="color: var(--atlas-green);">NEW:</strong> Use the Alpha channel to encode a fourth metric (like Cadence), 
        data quality/confidence, or global RPE (Rated Perceived Exertion)!
      </p>
    </div>
    <div class="selector-group">
      <label for="r_key" style="color: var(--accent-red);">R Channel:</label>
      <select name="r_key" id="r_key">
        {% for metric in all_metrics %}
        <option value="{{ metric }}" {% if metric == selected_r_key %}selected{% endif %}>
          {{ metric.replace('_', ' ')|title }}
        </option>
        {% endfor %}
      </select>
    </div>
    
    <div class="selector-group">
      <label for="g_key" style="color: var(--accent-green-viz);">G Channel:</label>
      <select name="g_key" id="g_key">
        {% for metric in all_metrics %}
        <option value="{{ metric }}" {% if metric == selected_g_key %}selected{% endif %}>
          {{ metric.replace('_', ' ')|title }}
        </option>
        {% endfor %}
      </select>
    </div>
    
    <div class="selector-group">
      <label for="b_key" style="color: var(--accent-blue);">B Channel:</label>
      <select name="b_key" id="b_key">
        {% for metric in all_metrics %}
        <option value="{{ metric }}" {% if metric == selected_b_key %}selected{% endif %}>
          {{ metric.replace('_', ' ')|title }}
        </option>
        {% endfor %}
      </select>
    </div>
    
    <div class="selector-group" style="flex-basis: 100%; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--atlas-border);">
      <div style="flex-basis: 100%; margin-bottom: 10px;">
        <label for="alpha_mode" style="color: var(--atlas-light-text); font-weight: 600; display: flex; align-items: center; gap: 8px;">
          <span>Alpha Channel Mode:</span>
          <button type="button" id="alphaInfoBtn" style="background: transparent; border: 1px solid var(--atlas-border); color: var(--atlas-green); padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.85em; display: inline-flex; align-items: center; gap: 4px;" title="Learn about Alpha Channel">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
              <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.206 2.057v1.133h1.241c.303 0 .524-.246.524-.575 0-.37-.22-.598-.524-.598H5.423c-.35 0-.53.21-.53.34 0 .084.042.147.174.194.376.121 1.075.24 1.853.413.788.176 1.572.418 2.118.736.546.318.91.805.91 1.594 0 1.196-1.059 2.001-2.5 2.001-.936 0-1.803-.334-2.486-1.069-.73-.78-1.12-1.806-1.12-2.898V5.786z"/>
            </svg>
            Why Alpha?
          </button>
        </label>
      </div>
      <select name="alpha_mode" id="alpha_mode" style="flex: 1;">
        <option value="none" {% if alpha_mode == "none" or not alpha_mode %}selected{% endif %}>None (RGB Mode)</option>
        <option value="fourth_metric" {% if alpha_mode == "fourth_metric" %}selected{% endif %}>Fourth Metric (e.g., Cadence)</option>
        <option value="data_quality" {% if alpha_mode == "data_quality" %}selected{% endif %}>Data Quality (255=Good, 0=Bad)</option>
        <option value="global_rpe" {% if alpha_mode == "global_rpe" %}selected{% endif %}>Global RPE (Rated Perceived Exertion)</option>
      </select>
    </div>
    
    <div class="selector-group" id="alpha_key_group" style="{% if alpha_mode != 'fourth_metric' %}display: none;{% endif %}">
      <label for="alpha_key" style="color: var(--atlas-mid-text);">Alpha Metric:</label>
      <select name="alpha_key" id="alpha_key">
        {% for metric in all_metrics %}
        <option value="{{ metric }}" {% if metric == alpha_key or (not alpha_key and metric == 'cadence') %}selected{% endif %}>
          {{ metric.replace('_', ' ')|title }}
        </option>
        {% endfor %}
      </select>
    </div>
    
    <button type="button" id="updateViewBtn" class="control-btn" style="padding: 10px 18px; margin-bottom: 0;">Update View & Find Similar</button>
    
    <button type="button" id="revertViewBtn" class="control-btn btn-revert" style="padding: 10px 18px; margin-bottom: 0; display: none;">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2v1z"/>
        <path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466z"/>
      </svg>
      Revert
    </button>
  </div>
  
  <div class="content-grid">  
    <div class="image-box">  
      <h2>Workout Fingerprint</h2>  
      <img src="data:image/png;base64,{{b64_combined}}"  
           alt="Generated feature image from JSON data"  
           class="main-img" id="main-fingerprint-img">  
      <div style="background-color: var(--atlas-hover-bg); padding: 15px; border-radius: 8px; border: 2px solid var(--atlas-green); margin-bottom: 15px;">
        <p style="margin: 0 0 10px 0; color: var(--atlas-light-text); font-weight: 600; font-size: 1.1em;">
          üéØ <strong>The Feature Engineering Magic</strong>
        </p>
        <p style="margin: 0; color: var(--atlas-mid-text); font-size: 0.95em; line-height: 1.5;">
          This 8x8 "visual fingerprint" transforms <strong>64 minutes of time-series data</strong> into a 
          <strong style="color: var(--atlas-green);">192-element searchable vector</strong>. 
          The same workout can reveal <strong>completely different patterns</strong> when viewed through different 
          RGB channel combinations. Common combinations (like Power/Cadence/HR) are pre-indexed for blazing-fast searches, 
          while others use intelligent pre-filtering. <strong style="color: var(--accent-purple);">Try changing the channels above 
          to discover hidden similarities!</strong>
        </p>
      </div>
      <p class="caption" style="font-style: normal; font-size: 0.9em;">  
        <span id="caption-r">{{ label_r_full_html|safe }}</span><br>  
        <span id="caption-g">{{ label_g_full_html|safe }}</span><br>  
        <span id="caption-b">{{ label_b_full_html|safe }}</span>
        {% if b64_a %}
        <br><span id="caption-a">{{ label_a_full_html|safe }}</span>
        {% endif %}
      </p>
      {% if b64_a %}
      <div style="margin-top: 15px; text-align: center;">
        <h4 style="color: var(--atlas-mid-text); margin-bottom: 10px; font-size: 1em;">Alpha Channel</h4>
        <img src="data:image/png;base64,{{b64_a}}" alt="Alpha channel" class="channel-img" id="img-channel-a" style="width: 128px; height: 128px;">
        <p style="margin-top: 10px; color: var(--atlas-mid-text); font-size: 0.9em;" id="text-channel-a">{{ label_a_short_html|safe }}</p>
      </div>
      {% endif %}  
    </div>  
  
    <div class="json-box">  
      <h2>Original JSON Data</h2>  
      <p class="caption">  
        Note the <code>workout_vector</code> field was added automatically during generation.
        (And <code>power</code>/<code>cadence</code> are now included!)
      </p>  
      <pre><code>{{json_data_pretty}}</code></pre>  
    </div>  
  </div>  
  
  <div class="ai-summary-box">  
    <div class="ai-header">  
      <h2>  
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"  
             fill="currentColor" viewBox="0 0 16 16"  
             style="color: var(--accent-blue);">  
          <path  
            d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0  
               14zm-5.467 4.14C7.02 12.637 7.558 13 8  
               13c.448 0 .89-.37 1.341-.758.384-.33  
               1.164-.98 1.956-1.579.529-.396.958-.87  
               1.253-1.412.308-.567.452-1.217.452-1.921  
               0-.663-.122-1.284-.367-1.841-.247-.568-  
               .62-1.11-1.12-1.583-.497-.47-1.127-.866  
               -1.87-1.171C9.697 5.093 8.87 4.75 8  
               4.75c-.878 0-1.688.354-2.457.784-.735.41  
               -1.353.94-1.854 1.572-.497.625-.873  
               1.342-1.124 2.144-.25.808-.372 1.68  
               -.372 2.616 0 .666.126 1.298.375  
               1.879.248.568.618 1.107 1.117  
               1.582.497.47 1.127.865 1.87  
               1.171z"/>  
          <path fill-rule="evenodd"  
            d="M8 15A7 7 0 1 0 8 1a7 7 0  
               0 0 0 14zM8 2A6 6 0 1 1  
               8 14 6 6 0 0 1 8 2z"/>  
        </svg>  
        AI Radiologist Summary ({{ai_classification}})  
      </h2>  
      <div class="button-group">  
        {{ai_analysis_button_html | safe}}  
        <button id="inspectPromptBtn" class="control-btn nav-link btn-prompt">  
          Inspect LLM Prompt  
        </button>  
      </div>  
    </div>  
  
    <p>  
      This qualitative summary is generated by an LLM (OpenAI API).  
      <strong>Crucially, the AI does not perform the math.</strong>  
      This app first uses Python (NumPy) to deterministically calculate all key metrics  
      (Avg HR, speed deviation, etc.).  
      The AI is then given these <em>pre-computed facts</em> (viewable via  
      'Inspect LLM Prompt') to provide a qualitative, radiologist-style interpretation.  
      <strong>It must be manually generated by clicking the button.</strong>  
    </p>  
    <p class="ai-summary-text">{{ai_summary}}</p>  
  </div>  
  
  <div class="guide-box guide-box-knn">  
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h2 style="margin: 0;">  
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"  
             fill="currentColor" viewBox="0 0 16 16" style="color: var(--atlas-green);">  
          <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1  
                   1H7zm4-6a3 3 0 1 0 0-6 3 3 0 0  
                   0 0 6z"/>  
          <path fill-rule="evenodd"  
                d="M5.216 14A2.238 2.238 0 0 1 5  
                   13c0-1.355.68-2.75 1.936-3.72A6.325  
                   6.325 0 0 0 5 9c-4 0-5 3-5  
                   4s1 1 1 1h4.216z"/>  
        </svg>  
        Atlas Vector Search (Workout Twins)  
      </h2>
      <div style="display: flex; align-items: center; gap: 10px;">
        <span id="voyage-badge" class="voyage-badge" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px; font-size: 0.85em; font-weight: 600; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
            <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.206 2.057v1.133h1.241c.303 0 .524-.246.524-.575 0-.37-.22-.598-.524-.598H5.423c-.35 0-.53.21-.53.34 0 .084.042.147.174.194.376.121 1.075.24 1.853.413.788.176 1.572.418 2.118.736.546.318.91.805.91 1.594 0 1.196-1.059 2.001-2.5 2.001-.936 0-1.803-.334-2.486-1.069-.73-.78-1.12-1.806-1.12-2.898V5.786z"/>
          </svg>
          Powered by VoyageAI
        </span>
        <button id="voyage-info-btn" type="button" class="control-btn" style="padding: 6px 12px; font-size: 0.9em; background-color: var(--accent-blue); color: white; display: inline-flex; align-items: center; gap: 5px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
            <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.206 2.057v1.133h1.241c.303 0 .524-.246.524-.575 0-.37-.22-.598-.524-.598H5.423c-.35 0-.53.21-.53.34 0 .084.042.147.174.194.376.121 1.075.24 1.853.413.788.176 1.572.418 2.118.736.546.318.91.805.91 1.594 0 1.196-1.059 2.001-2.5 2.001-.936 0-1.803-.334-2.486-1.069-.73-.78-1.12-1.806-1.12-2.898V5.786z"/>
          </svg>
          Learn More
        </button>
        <button id="ab-test-btn" type="button" class="control-btn" style="padding: 6px 12px; font-size: 0.9em; background-color: var(--accent-orange); color: white; display: inline-flex; align-items: center; gap: 5px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
          </svg>
          A/B Test
        </button>
      </div>
    </div>
    <p>  
      Using a <code>$vectorSearch</code> pipeline in MongoDB Atlas with index  
      <code>{{vector_index_name}}</code>  
      to find the 3 workouts most similar to this one's 192-element vector (excluding itself).  
      Higher score means more similar pattern.
    </p>
    <div id="voyage-explanation" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #667eea; margin-top: 15px; margin-bottom: 15px;">
      <p style="margin: 0 0 10px 0; color: var(--atlas-light-text); font-size: 0.95em; font-weight: 600; display: flex; align-items: center; gap: 8px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#667eea" viewBox="0 0 16 16">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.206 2.057v1.133h1.241c.303 0 .524-.246.524-.575 0-.37-.22-.598-.524-.598H5.423c-.35 0-.53.21-.53.34 0 .084.042.147.174.194.376.121 1.075.24 1.853.413.788.176 1.572.418 2.118.736.546.318.91.805.91 1.594 0 1.196-1.059 2.001-2.5 2.001-.936 0-1.803-.334-2.486-1.069-.73-.78-1.12-1.806-1.12-2.898V5.786z"/>
        </svg>
        <span>Why VoyageAI Reranking?</span>
      </p>
      <p style="margin: 0; color: var(--atlas-mid-text); font-size: 0.9em; line-height: 1.6;">
        We use a <strong style="color: var(--atlas-light-text);">two-stage retrieval pipeline</strong> for the most accurate "Workout Twins":
      </p>
      <ol style="margin: 10px 0 0 20px; padding-left: 0; color: var(--atlas-mid-text); font-size: 0.9em; line-height: 1.8;">
        <li><strong style="color: var(--atlas-light-text);">Fast Candidate Generation:</strong> MongoDB's vector search finds 25 structurally similar workouts in milliseconds</li>
        <li><strong style="color: var(--atlas-light-text);">Semantic Reranking:</strong> VoyageAI's advanced model reads the text descriptions and finds the 3 most semantically similar workouts</li>
      </ol>
      <p style="margin: 10px 0 0 0; color: var(--atlas-mid-text); font-size: 0.9em; line-height: 1.6;">
        This combines the <strong style="color: var(--atlas-green);">speed of vector search</strong> with the <strong style="color: #667eea;">deep semantic understanding</strong> of VoyageAI's reranker, giving you more accurate and relevant workout matches.
      </p>
    </div>
    <div style="background-color: var(--atlas-dark-blue); padding: 12px; border-radius: 6px; border-left: 4px solid var(--accent-purple); margin-top: 10px;">
      <p style="margin: 0; color: var(--atlas-light-text); font-size: 0.95em;">
        <strong>üí° Feature Engineering Insight:</strong> The vector below uses the <strong>indexed default channels</strong> 
        (HR, Calories, Speed) for fast vector search. But <strong style="color: var(--accent-purple);">different channel 
        combinations reveal different patterns!</strong> Common combinations like Power/Cadence/HR are also indexed for 
        blazing-fast searches. Try selecting Power, Cadence, or other metrics above and click <strong>"Update View & Find Similar"</strong> 
        to discover workouts that are similar in completely different ways.
      </p>
    </div>  
    <ul id="canonical-neighbors">{{ai_neighbors_html | safe}}</ul>
    <div id="custom-similar-results" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--atlas-border);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="color: var(--accent-purple); margin-top: 0; margin-bottom: 0;">Similar Workouts (Custom View)</h3>
        <button id="explainCustomBtn" class="control-btn" style="padding: 6px 12px; font-size: 0.9em; background-color: var(--accent-purple); color: white;">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 5px;">
            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
            <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.206 2.057v1.133h1.241c.303 0 .524-.246.524-.575 0-.37-.22-.598-.524-.598H5.423c-.35 0-.53.21-.53.34 0 .084.042.147.174.194.376.121 1.075.24 1.853.413.788.176 1.572.418 2.118.736.546.318.91.805.91 1.594 0 1.196-1.059 2.001-2.5 2.001-.936 0-1.803-.334-2.486-1.069-.73-.78-1.12-1.806-1.12-2.898V5.786z"/>
          </svg>
          How This Works
        </button>
      </div>
      <div id="custom-view-info" style="background-color: var(--atlas-dark-blue); padding: 12px; border-radius: 6px; border-left: 4px solid var(--accent-purple); margin-bottom: 15px;">
        <p style="margin: 0; color: var(--atlas-light-text); font-size: 0.95em;">
          <strong>Current View:</strong> 
          <span id="custom-view-channels" style="color: var(--accent-purple); font-weight: 600;"></span>
        </p>
        <p style="margin: 5px 0 0 0; color: var(--atlas-mid-text); font-size: 0.9em;">
          These workouts are similar based on patterns in the selected metrics above. 
          Different channel combinations reveal different types of similarity!
        </p>
        <p style="margin: 5px 0 0 0; color: var(--atlas-mid-text); font-size: 0.85em; font-style: italic;">
          üí° <strong>Performance Tip:</strong> Common combinations like Power/Cadence/HR use indexed vector search for 
          blazing-fast results (~5-10ms). Other combinations use intelligent pre-filtering (~200-500ms).
        </p>
      </div>
      <ul id="custom-similar-list"></ul>
    </div>
    
    <!-- Hybrid Search Section -->
    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--atlas-border);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="color: var(--atlas-green); margin-top: 0; margin-bottom: 0;">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: -3px; margin-right: 8px;">
            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
          </svg>
          Hybrid Search: The AI Vibe-Check + The Human Filter
        </h3>
        <button id="hybridSearchBtn" class="control-btn" style="padding: 8px 16px; font-size: 0.95em; background-color: var(--atlas-green); color: var(--button-text-dark);">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 6px;">
            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
          </svg>
          Try Hybrid Search
        </button>
      </div>
      <div style="background-color: var(--atlas-dark-blue); padding: 15px; border-radius: 8px; border-left: 4px solid var(--atlas-green); margin-bottom: 15px;">
        <p style="margin: 0 0 10px 0; color: var(--atlas-light-text); font-size: 1em; line-height: 1.6;">
          <strong>üéØ The Problem:</strong> Vector search is amazing for fuzzy, "vibe-based" questions ("find more workouts like this"). 
          But it's terrible at precise, factual questions ("...but only the ones on a Monday").
        </p>
        <p style="margin: 10px 0 0 0; color: var(--atlas-light-text); font-size: 1em; line-height: 1.6;">
          <strong>‚ú® The Solution:</strong> <strong style="color: var(--atlas-green);">Hybrid Search</strong> combines vector search (vibe) 
          with text search (facts) and filters (exact matches). This is how people actually think - we blend fuzzy concepts 
          ("vibe," "felt strong") with concrete facts ("Outdoor Run").
        </p>
        <p style="margin: 15px 0 0 0; color: var(--atlas-mid-text); font-size: 0.9em; font-style: italic;">
          üí° <strong>Example:</strong> "Show me workouts with a vibe similar to my last 'Tempo Run' (vector search)... 
          but only show me ones where my notes said I 'felt strong' (text search)... 
          and where the workout type was 'Outdoor Run' (filter)."
        </p>
      </div>
    </div>
  </div>  
  
  <div class="guide-box" style="border-top: 4px solid var(--accent-orange);">
    <h2>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
           fill="currentColor" viewBox="0 0 16 16"
           style="color: var(--accent-orange);">
        <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM4.5 7.5a.5.5 0 0 0 0 1h5.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H4.5z"/>
      </svg>
      Vector "Magic": Asking Abstract Questions with Math
    </h2>
    
    <div style="background-color: var(--atlas-dark-blue); padding: 20px; border-radius: 8px; border-left: 4px solid var(--accent-orange); margin-bottom: 20px;">
      <p style="margin: 0 0 15px 0; color: var(--atlas-light-text); font-size: 1.1em; line-height: 1.8;">
        <strong>üéØ The Problem:</strong> How do you ask the database for <em>"a harder version of this yoga session"</em>? 
        You can't type that into a search bar. But with <strong style="color: var(--accent-orange);">vector arithmetic</strong>, 
        we can discover abstract concepts like "effort" and use them to find workouts that match abstract queries!
      </p>
      
      <div style="background-color: var(--atlas-bg); padding: 15px; border-radius: 6px; margin-top: 15px;">
        <h3 style="color: var(--accent-orange); margin-top: 0; margin-bottom: 10px; font-size: 1.1em;">‚ú® The "Magic" Formula:</h3>
        <ol style="color: var(--atlas-light-text); line-height: 1.8; margin-left: 20px; padding-left: 10px;">
          <li><strong>Step 1: Find the "essence of effort"</strong><br>
            <code style="background-color: var(--atlas-hover-bg); padding: 5px 10px; border-radius: 4px; display: inline-block; margin-top: 5px;">
              Vector(Hard Tempo Run) - Vector(Easy Recovery Run) = "Effort Vector"
            </code><br>
            <span style="color: var(--atlas-mid-text); font-size: 0.95em; font-style: italic;">
              This new Effort Vector is a set of 192 numbers that, to our AI, literally represents the abstract concept of 'high effort'.
            </span>
          </li>
          <li style="margin-top: 15px;"><strong>Step 2: Apply it to find what you want</strong><br>
            <code style="background-color: var(--atlas-hover-bg); padding: 5px 10px; border-radius: 4px; display: inline-block; margin-top: 5px;">
              Vector(My Easy Yoga Session) + "Effort Vector" = ???
            </code><br>
            <span style="color: var(--atlas-mid-text); font-size: 0.95em; font-style: italic;">
              Take this new, mathematically-created vector and run a search with it.
            </span>
          </li>
          <li style="margin-top: 15px;"><strong>Step 3: Discover the results</strong><br>
            <span style="color: var(--atlas-green); font-weight: 600;">
              The database will return "Power Yoga" sessions, "Intense Vinyasa Flows," or other high-intensity yoga workouts!
            </span>
          </li>
        </ol>
      </div>
      
      <p style="margin: 15px 0 0 0; color: var(--atlas-light-text); font-size: 1.05em; font-weight: 600;">
        üöÄ <strong>Why this is genius:</strong> We've stopped just retrieving data. We are now <strong>exploring the latent space</strong> 
        of our workouts. We can ask abstract questions like <em>"what's the halfway point between a run and a bike ride?"</em> 
        or <em>"show me a workout that's 50% less intense than this one."</em>
      </p>
    </div>
    
    <div style="background-color: var(--atlas-hover-bg); padding: 20px; border-radius: 8px; border: 2px solid var(--atlas-border); margin-top: 20px;">
      <h3 style="color: var(--atlas-light-text); margin-top: 0; margin-bottom: 15px; font-size: 1.2em;">
        üßÆ Try Vector Magic
      </h3>
      
      <div id="vectorMagicSmartSuggestions" style="display: none; background-color: var(--atlas-dark-blue); padding: 15px; border-radius: 6px; border: 1px solid var(--atlas-green); margin-bottom: 20px;">
        <p style="margin: 0 0 10px 0; color: var(--atlas-light-text); font-weight: 600; font-size: 1em;">
          ‚ú® <strong>Smart Suggestions:</strong> Based on your neighbors, we've detected potential workouts for Vector Magic!
        </p>
        <div id="smartSuggestionsContent" style="color: var(--atlas-mid-text); font-size: 0.95em;"></div>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px;">
        <!-- Operation 1: One-Click Find Harder -->
        <div style="background-color: var(--atlas-dark-blue); padding: 15px; border-radius: 6px; border: 1px solid var(--atlas-border);">
          <h4 style="color: var(--accent-orange); margin-top: 0; margin-bottom: 10px;">1Ô∏è‚É£ Find Harder Version</h4>
          <p style="color: var(--atlas-mid-text); font-size: 0.95em; margin-bottom: 15px;">
            Automatically find harder versions using neighbors:
          </p>
          <div id="harderSuggestions" style="margin-bottom: 15px; font-size: 0.9em; color: var(--atlas-mid-text);">
            <p style="margin: 0; font-style: italic;">üí° Click below to automatically use neighbors</p>
          </div>
          <button id="findHarderAutoBtn" class="control-btn" style="width: 100%; margin-top: 10px; padding: 10px; background-color: var(--accent-orange); color: white; font-size: 0.95em;">
            üöÄ Find Harder Versions (Auto)
          </button>
          <details style="margin-top: 10px;">
            <summary style="color: var(--atlas-mid-text); font-size: 0.85em; cursor: pointer; user-select: none;">Manual override</summary>
            <div style="margin-top: 10px;">
              <input type="number" id="harderWorkoutId" placeholder="Workout ID" 
                     style="width: 100%; padding: 8px; background-color: var(--atlas-bg); color: var(--atlas-light-text); border: 1px solid var(--atlas-border); border-radius: 4px; font-size: 0.95em;">
              <button id="findHarderManualBtn" class="control-btn" style="width: 100%; margin-top: 8px; padding: 8px; background-color: var(--atlas-hover-bg); color: var(--atlas-light-text); font-size: 0.9em; border: 1px solid var(--atlas-border);">
                Use Manual ID
              </button>
            </div>
          </details>
        </div>
        
        <!-- Operation 2: One-Click Find Easier -->
        <div style="background-color: var(--atlas-dark-blue); padding: 15px; border-radius: 6px; border: 1px solid var(--atlas-border);">
          <h4 style="color: var(--accent-orange); margin-top: 0; margin-bottom: 10px;">2Ô∏è‚É£ Find Easier Version</h4>
          <p style="color: var(--atlas-mid-text); font-size: 0.95em; margin-bottom: 15px;">
            Automatically find easier versions using neighbors:
          </p>
          <div id="easierSuggestions" style="margin-bottom: 15px; font-size: 0.9em; color: var(--atlas-mid-text);">
            <p style="margin: 0; font-style: italic;">üí° Click below to automatically use neighbors</p>
          </div>
          <button id="findEasierAutoBtn" class="control-btn" style="width: 100%; margin-top: 10px; padding: 10px; background-color: var(--accent-orange); color: white; font-size: 0.95em;">
            üöÄ Find Easier Versions (Auto)
          </button>
          <details style="margin-top: 10px;">
            <summary style="color: var(--atlas-mid-text); font-size: 0.85em; cursor: pointer; user-select: none;">Manual override</summary>
            <div style="margin-top: 10px;">
              <input type="number" id="easierWorkoutId" placeholder="Workout ID" 
                     style="width: 100%; padding: 8px; background-color: var(--atlas-bg); color: var(--atlas-light-text); border: 1px solid var(--atlas-border); border-radius: 4px; font-size: 0.95em;">
              <button id="findEasierManualBtn" class="control-btn" style="width: 100%; margin-top: 8px; padding: 8px; background-color: var(--atlas-hover-bg); color: var(--atlas-light-text); font-size: 0.9em; border: 1px solid var(--atlas-border);">
                Use Manual ID
              </button>
            </div>
          </details>
        </div>
        
        <!-- Operation 3: Scale Intensity -->
        <div style="background-color: var(--atlas-dark-blue); padding: 15px; border-radius: 6px; border: 1px solid var(--atlas-border);">
          <h4 style="color: var(--accent-orange); margin-top: 0; margin-bottom: 10px;">3Ô∏è‚É£ Scale Intensity</h4>
          <p style="color: var(--atlas-mid-text); font-size: 0.95em; margin-bottom: 15px;">
            Scale this workout's intensity to find variations:
          </p>
          <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 10px;">
            <button class="scaleBtn" data-scale="0.5" style="flex: 1; padding: 8px; background-color: var(--atlas-hover-bg); color: var(--atlas-light-text); border: 1px solid var(--atlas-border); border-radius: 4px; font-size: 0.9em; cursor: pointer;">50% Less</button>
            <button class="scaleBtn" data-scale="0.75" style="flex: 1; padding: 8px; background-color: var(--atlas-hover-bg); color: var(--atlas-light-text); border: 1px solid var(--atlas-border); border-radius: 4px; font-size: 0.9em; cursor: pointer;">75%</button>
            <button class="scaleBtn" data-scale="1.25" style="flex: 1; padding: 8px; background-color: var(--atlas-hover-bg); color: var(--atlas-light-text); border: 1px solid var(--atlas-border); border-radius: 4px; font-size: 0.9em; cursor: pointer;">125%</button>
            <button class="scaleBtn" data-scale="1.5" style="flex: 1; padding: 8px; background-color: var(--atlas-hover-bg); color: var(--atlas-light-text); border: 1px solid var(--atlas-border); border-radius: 4px; font-size: 0.9em; cursor: pointer;">150% More</button>
          </div>
          <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <label style="color: var(--atlas-light-text); font-size: 0.9em; font-weight: 600;">Custom:</label>
            <input type="number" id="scaleFactor" placeholder="0.5" step="0.1" min="0.1" max="2.0" 
                   style="flex: 1; min-width: 80px; padding: 8px; background-color: var(--atlas-bg); color: var(--atlas-light-text); border: 1px solid var(--atlas-border); border-radius: 4px; font-size: 0.95em;">
          </div>
          <button id="scaleIntensityBtn" class="control-btn" style="width: 100%; margin-top: 10px; padding: 10px; background-color: var(--accent-orange); color: white; font-size: 0.95em;">
            Find Scaled Versions
          </button>
        </div>
      </div>
      
      <!-- Results Display -->
      <div id="vectorMagicResults" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--atlas-border);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h3 style="color: var(--accent-orange); margin-top: 0; margin-bottom: 0;">Vector Magic Results</h3>
          <button id="explainVectorMagicBtn" class="control-btn" style="padding: 6px 12px; font-size: 0.9em; background-color: var(--accent-orange); color: white;">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 5px;">
              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
              <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.206 2.057v1.133h1.241c.303 0 .524-.246.524-.575 0-.37-.22-.598-.524-.598H5.423c-.35 0-.53.21-.53.34 0 .084.042.147.174.194.376.121 1.075.24 1.853.413.788.176 1.572.418 2.118.736.546.318.91.805.91 1.594 0 1.196-1.059 2.001-2.5 2.001-.936 0-1.803-.334-2.486-1.069-.73-.78-1.12-1.806-1.12-2.898V5.786z"/>
            </svg>
            Learn More
          </button>
        </div>
        <div id="vectorMagicOperation" style="background-color: var(--atlas-dark-blue); padding: 12px; border-radius: 6px; border-left: 4px solid var(--accent-orange); margin-bottom: 15px;">
          <p style="margin: 0; color: var(--atlas-light-text); font-size: 0.95em;">
            <strong>Operation:</strong> <code id="vectorMagicOperationText" style="color: var(--accent-orange);"></code>
          </p>
        </div>
        <ul id="vectorMagicResultsList" style="list-style-type: none; padding-left: 0;"></ul>
      </div>
    </div>
  </div>
  
  <div class="explanation-box">  
    <div class="pipeline-header">  
      <h2>  
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"  
             fill="currentColor" viewBox="0 0 16 16"  
             style="color: var(--accent-purple);">  
          <path d="M11.854 1.146a.5.5 0 0 0-.708  
                   0l-4 4a.5.5 0 0 0 0  
                   .708l4 4a.5.5 0 0 0  
                   .708-.708L8.207 8l3.647-3.646a.5.5  
                   0 0 0 0-.708z"/>  
          <path d="M4.146 1.146a.5.5 0 0 1  
                   .708 0l4 4a.5.5 0 0 1  
                   0 .708l-4 4a.5.5 0 0  
                   1-.708-.708L7.793 8  
                   4.146 4.354a.5.5 0 0  
                   1 0-.708z"/>  
        </svg>  
        The Encoding Pipeline: From Data to Fingerprint  
      </h2>  
      <button id="whyCoolBtn" class="control-btn btn-why-cool">  
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"  
             fill="currentColor" viewBox="0 0 16 16">  
          <path d="M13.468 12.37C12.758 11.226  
                   11.195 10 8  
                   10s-4.757 1.225-5.468  
                   2.37A6.987 6.987 0 0 0  
                   8 15a6.987 6.987 0 0 0  
                   5.468-2.63z"/>  
          <path fill-rule="evenodd"  
                d="M8 9a3 3 0 1 0 0-6  
                   3 3 0 0 0 0 6z"/>  
          <path fill-rule="evenodd"  
                d="M8 1a7 7 0 1 0 0  
                   14A7 7 0 0 0 8  
                   1zM0 8a8 8 0 1 1 16  
                   0A8 8 0 0 1  
                   0 8z"/>  
        </svg>  
        Why is this cool?  
      </button>  
    </div>  
  
    <div class="encoding-pipeline">  
      <div class="pipeline-steps">  
  
        <div class="pipeline-step">  
          <h3><span class="step-number">1</span> Start: 1D Time-Series Data (64 mins)</h3>  
          <p><strong>This is where the magic begins:</strong> We start with raw time-series data‚Äî64 data points 
          per metric, representing one workout session. Each metric (heart rate, calories, speed, power, cadence) 
          tells its own story. The challenge? How do we make this searchable? How do we find similar patterns 
          without comparing every single data point?</p>
          <p style="margin-top: 10px; font-style: italic; color: var(--atlas-mid-text);">
            üí° <strong>Feature Engineering Tip:</strong> Notice how we have <strong>5 different metrics</strong> but 
            only use <strong>3 at a time</strong>. This gives us <strong>5√ó4√ó3 = 60 different ways</strong> to view 
            the same workout! Each combination reveals different patterns.
          </p>  
          <div class="step-1-charts">  
            <div>  
              <h4 class="red">Heart Rate (1D Array)</h4>  
              <img src="data:image/png;base64,{{all_charts.heart_rate}}" alt="Heart Rate Line Chart" class="chart-img">  
            </div>  
            <div>  
              <h4 class="green">Calories (1D Array)</h4>  
              <img src="data:image/png;base64,{{all_charts.calories_per_min}}" alt="Calories Line Chart" class="chart-img">  
            </div>  
            <div>  
              <h4 class="blue">Speed (1D Array)</h4>  
              <img src="data:image/png;base64,{{all_charts.speed_kph}}" alt="Speed Line Chart" class="chart-img">  
            </div>
            <div>  
              <h4 class="orange">Power (1D Array)</h4>  
              <img src="data:image/png;base64,{{all_charts.power}}" alt="Power Line Chart" class="chart-img">  
            </div>
            <div>  
              <h4 class="purple">Cadence (1D Array)</h4>  
              <img src="data:image/png;base64,{{all_charts.cadence}}" alt="Cadence Line Chart" class="chart-img">  
            </div>
          </div>  
        </div>  
  
        <div class="pipeline-step">  
          <h3><span class="step-number">2</span> "Fold" 1D (64) into 2D (8x8 Grids)</h3>  
          <p>Each 64-point array is reshaped into an 8x8 grid. Think of it like taking a long string of 64 characters and wrapping it every 8 characters to form an 8x8 block of text. This turns temporal patterns into visual textures.</p>  
          <div class="fold-visualization">  
            <div class="fold-text-block">  
              [<span class="highlight">0,1,2,3,4,5,6,7,</span><span class="dim">8,9,10,...,61,62,63</span>]  
            </div>  
            <div class="pipeline-arrow">&Rarr;</div>  
            <div class="fold-grid">  
              <span class="highlight">0</span><span class="highlight">1</span><span class="highlight">2</span><span class="highlight">3</span><span class="highlight">4</span><span class="highlight">5</span><span class="highlight">6</span><span class="highlight">7</span>  
              <span>8</span><span>9</span><span>10</span><span>11</span><span>12</span><span>13</span><span>14</span><span>15</span>  
              <span>16</span><span>17</span><span>18</span><span>19</span><span>20</span><span>21</span><span>22</span><span>23</span>  
              <span>24</span><span>25</span><span>26</span><span>27</span><span>28</span><span>29</span><span>30</span><span>31</span>  
              <span>32</span><span>33</span><span>34</span><span>35</span><span>36</span><span>37</span><span>38</span><span>39</span>  
              <span>40</span><span>41</span><span>42</span><span>43</span><span>44</span><span>45</span><span>46</span><span>47</span>  
              <span>48</span><span>49</span><span>50</span><span>51</span><span>52</span><span>53</span><span>54</span><span>55</span>  
              <span>56</span><span>57</span><span>58</span><span>59</span><span>60</span><span>61</span><span>62</span><span>63</span>  
            </div>  
          </div>  
          <p style="margin-top: 15px;">  
            Minutes <code>0..7</code> become Row 1 (highlighted). Minutes <code>8..15</code> become Row 2, etc.  
            We now have {% if b64_a %}four{% else %}three{% endif %} separate 8x8 grayscale "channels"{% if b64_a %} (R, G, B, and A){% endif %}.  
          </p>  
        </div>  
  
        <div class="pipeline-step">  
          <h3><span class="step-number">3</span> Stack Channels into {% if b64_a %}8x8x4 RGBA{% else %}8x8x3 RGB{% endif %} Image</h3>  
          <p>{% if b64_a %}The four{% else %}The three{% endif %} 8x8 grayscale grids (channels) generated in Step 2 are combined pixel-by-pixel:</p>  
          <div class="step-3-substeps">  
            <div class="substep">  
              <img src="data:image/png;base64,{{b64_r}}" alt="Red channel" class="channel-img" id="img-channel-r">  
              <p id="text-channel-r">{{ label_r_short_html|safe }}</p>  
            </div>  
            <div class="substep">  
              <img src="data:image/png;base64,{{b64_g}}" alt="Green channel" class="channel-img" id="img-channel-g">  
              <p id="text-channel-g">{{ label_g_short_html|safe }}</p>  
            </div>  
            <div class="substep">  
              <img src="data:image/png;base64,{{b64_b}}" alt="Blue channel" class="channel-img" id="img-channel-b">  
              <p id="text-channel-b">{{ label_b_short_html|safe }}</p>  
            </div>
            {% if b64_a %}
            <div class="substep">  
              <img src="data:image/png;base64,{{b64_a}}" alt="Alpha channel" class="channel-img" id="img-channel-a-pipeline">  
              <p id="text-channel-a-pipeline">{{ label_a_short_html|safe }}</p>  
            </div>
            {% endif %}
          </div>  
          <div class="pipeline-arrow">&dArr;</div>  
          <p style="text-align: center; margin-top: 15px;">These channels are layered together...</p>  
          <div style="text-align: center; margin-top: 10px;">  
            <img src="data:image/png;base64,{{b64_combined}}" alt="Combined {% if b64_a %}RGBA{% else %}RGB{% endif %}"  
                 class="channel-img" style="width: 160px; height: 160px; border-width: 2px;" id="main-fingerprint-img-small">  
            <p>...to create the final <strong>8x8 {% if b64_a %}RGBA{% else %}RGB{% endif %} color "fingerprint"</strong> image.</p>
            {% if b64_a %}
            <div style="margin-top: 15px; padding: 15px; background-color: var(--atlas-hover-bg); border-radius: 6px; border-left: 4px solid var(--atlas-green);">
              <p style="margin: 0 0 10px 0; color: var(--atlas-light-text); font-size: 1em; font-weight: 600;">
                üí° <strong>The Secret Data Lane: Why Alpha is Cool!</strong>
              </p>
              <p style="margin: 0; color: var(--atlas-mid-text); font-size: 0.95em; line-height: 1.6;">
                The Alpha channel encodes {% if alpha_mode == "fourth_metric" %}<strong>a fourth metric ({{alpha_key.replace('_', ' ').title()}})</strong>{% elif alpha_mode == "data_quality" %}<strong>data quality/confidence (255=good, 0=bad)</strong>{% elif alpha_mode == "global_rpe" %}<strong>global RPE (Rated Perceived Exertion)</strong>{% endif %}, 
                giving us a <strong>fourth 64-point data lane</strong> for richer pattern matching!
              </p>
              <p style="margin: 10px 0 0 0; color: var(--atlas-mid-text); font-size: 0.9em; line-height: 1.6;">
                {% if alpha_mode == "fourth_metric" %}
                <strong>üéØ Fourth Metric Mode:</strong> Now your vector search finds workouts with similar patterns in <strong>four metrics</strong> instead of three! 
                Perfect for finding workouts with similar cadence/efficiency patterns.
                {% elif alpha_mode == "data_quality" %}
                <strong>üîß Data Quality Mode:</strong> The database now "knows" which data points are reliable! Workouts with sensor dropouts 
                will have different vectors than perfect data, enabling smarter similarity matching.
                {% elif alpha_mode == "global_rpe" %}
                <strong>üåê Global RPE Mode:</strong> Match workouts by perceived effort! Two workouts with identical physical metrics but 
                different perceived difficulty will have different vectors.
                {% endif %}
              </p>
              <p style="margin: 10px 0 0 0; color: var(--atlas-green); font-size: 0.9em; font-weight: 600;">
                <a href="#" id="learnMoreAlpha" style="color: var(--atlas-green); text-decoration: underline; cursor: pointer;">Learn more about why Alpha channel is powerful ‚Üí</a>
              </p>
            </div>
            {% endif %}
          </div>  
        </div>  
  
        <div class="pipeline-step">  
          <h3><span class="step-number">4</span> Finish: Flatten to {% if b64_a %}256{% else %}192{% endif %}-Element Vector</h3>  
          <p>The 8x8x{% if b64_a %}4{% else %}3{% endif %} image (8 rows * 8 columns * {% if b64_a %}4{% else %}3{% endif %} color channels = {% if b64_a %}256{% else %}192{% endif %} values) is "flattened" row by row into a single list of {% if b64_a %}256{% else %}192{% endif %} numbers. This vector numerically captures the visual pattern.</p>  
          <div class="step-4-content">  
            <pre><code>Vector = [Pixel(0,0)R, Pixel(0,0)G, Pixel(0,0)B{% if b64_a %}, Pixel(0,0)A{% endif %}, Pixel(0,1)R, ..., Pixel(7,7){% if b64_a %}A{% else %}B{% endif %}]</code></pre>  
            <p>This is the vector stored in MongoDB Atlas and used for blazing-fast <code>$vectorSearch</code>!</p>
            {% if b64_a %}
            <div style="margin-top: 15px; padding: 15px; background-color: var(--atlas-hover-bg); border-radius: 6px; border-left: 4px solid var(--accent-purple);">
              <p style="margin: 0 0 10px 0; color: var(--atlas-light-text); font-size: 1em; font-weight: 600;">
                üéØ <strong>RGBA Mode: The Power of 256 Elements</strong>
              </p>
              <p style="margin: 0; color: var(--atlas-mid-text); font-size: 0.95em; line-height: 1.6;">
                With the Alpha channel enabled, we now have a <strong>256-element vector</strong> instead of 192, 
                providing an <strong>additional 64 data points</strong> for more nuanced similarity matching!
              </p>
              <p style="margin: 10px 0 0 0; color: var(--atlas-mid-text); font-size: 0.9em; line-height: 1.6;">
                <strong>Why this matters:</strong> More dimensions = richer pattern matching. The Alpha channel adds context that RGB alone can't capture, 
                whether it's a fourth metric, data quality indicators, or global workout characteristics like RPE.
              </p>
            </div>
            {% endif %}
          </div>
          <div style="background-color: var(--atlas-dark-blue); padding: 15px; border-radius: 6px; border-left: 4px solid var(--atlas-green); margin-top: 15px;">
            <p style="margin: 0; color: var(--atlas-light-text); font-size: 1.05em; font-weight: 600;">
              üéØ <strong>The Feature Engineering Breakthrough</strong>
            </p>
            <p style="margin: 10px 0 0 0; color: var(--atlas-mid-text); line-height: 1.6;">
              <strong>Why is this clever?</strong> We've transformed <strong>time-series data</strong> (which is hard to search) 
              into a <strong>fixed-size vector</strong> (which is fast to search). Instead of comparing 64√ó5=320 data points 
              for every workout, we compare one {% if b64_a %}256{% else %}192{% endif %}-element vector. This enables:
            </p>
            <ul style="margin: 10px 0 0 20px; color: var(--atlas-mid-text); line-height: 1.6;">
              <li><strong>Indexed search:</strong> MongoDB builds an optimized HNSW index on these vectors</li>
              <li><strong>Millisecond queries:</strong> Find similar workouts in milliseconds, even with millions of records</li>
              <li><strong>Pattern preservation:</strong> The visual "fingerprint" captures the shape and progression of effort</li>
              <li><strong>Multiple perspectives:</strong> Different {% if b64_a %}RGBA{% else %}RGB{% endif %} channel combinations reveal different types of similarity</li>
              {% if b64_a %}
              <li><strong>The Alpha advantage:</strong> The fourth channel adds 64 more data points, enabling richer pattern matching for metrics like cadence, data quality, or RPE!</li>
              {% endif %}
            </ul>
            <p style="margin: 15px 0 0 0; color: var(--atlas-light-text); font-weight: 600;">
              üöÄ <strong>Try it:</strong> Change the {% if b64_a %}RGBA{% else %}RGB{% endif %} channels above and click "Find Similar" to discover workouts 
              that are similar in power/cadence patterns vs. heart rate/calorie patterns. Same data, completely different insights!
              {% if b64_a %}
              <strong style="color: var(--atlas-green);">Experiment with the Alpha channel modes</strong> to see how encoding a fourth metric, data quality, or RPE changes similarity matching!
              {% endif %}
            </p>
          </div>
        </div>  
  
      </div>  
    </div>  
  </div>  
  
  <div class="guide-box guide-box-radiologist">  
    <h2>  
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"  
           fill="currentColor" viewBox="0 0 16 16"  
           style="color: var(--accent-orange);">  
        <path d="M10.5 8a2.5 2.5 0 1 1-5  
                 0 2.5 2.5 0 0 1 5 0z"/>  
        <path d="M0 8s3-5.5 8-5.5S16 8  
                 16 8s-3 5.5-8 5.5S0  
                 8 0 8zm8 3.5a3.5 3.5 0  
                 1 0 0-7 3.5 3.5 0  
                 0 0 0 7z"/>  
      </svg>  
      A Radiologist's Guide: Reading the Fingerprint  
    </h2>  
    <p>Think of this 8x8 image like a tiny X-ray of your workout's effort structure:</p>  
    <ul>  
      <li><strong>Overall Color:</strong> The color mix shows which metrics are high *at the same time*.
        <span style="color: #FFB6F1; background: #2c1a2b; padding: 1px 4px; border-radius: 3px;">Purplish</span> (R+B) = High Red & Blue channels.  
        <span style="color: #DFFFBF; background: #1a3a53; padding: 1px 4px; border-radius: 3px;">Yellowish</span> (R+G) = High Red & Green channels.  
        <span style="color: #000; background: #fff; padding: 1px 4px; border-radius: 3px;">White</span> = Peak effort (all channels high).  
        <span style="color: #eee; background: #333; padding: 1px 4px; border-radius: 3px;">Dark/Black</span> = Low effort (rest/warmup).</li>  
      <li><strong>Texture & Patterns (Top-Left to Bottom-Right):</strong> The image reads like text. Top-Left (start) is often dark (warm-up), Bottom-Right (end) is often dark (cool-down).  
        Clear <strong>horizontal stripes</strong> suggest intervals.  
        A smooth <strong>diagonal color gradient</strong> indicates a progressive ramp-up/down.</li>  
    </ul>  
  </div>  
  
  <div class="guide-box polymorphic-box">  
    <h2>  
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"  
           fill="currentColor" viewBox="0 0 16 16"  
           style="color: var(--accent-red);">  
        <path d="M1 3.5A1.5 1.5 0 0 1  
                 2.5 2h11A1.5 1.5 0 0 1  
                 15 3.5v9a1.5 1.5 0 0  
                 1-1.5 1.5h-11A1.5 1.5  
                 0 0 1 1 12.5v-9zM2.5  
                 3a.5.5 0 0 0-.5.5v9a.5.5  
                 0 0 0 .5.5h11a.5.5  
                 0 0 0 .5-.5v-9a.5.5  
                 0 0 0-.5-.5h-11z"/>  
        <path d="M2 3h12v1H2zM2 5.5h12v1H2zM2  
                 8h12v1H2zM2 10.5h12v1H2z"/>  
      </svg>  
      Polymorphic / Additional Fields  
    </h2>  
    <p>This data provides extra context but isn't part of the vector search. The specific fields here vary depending on the <code>workout_type</code>.</p>  
    <p><b>Workout Type:</b> {{workout_type}}</p>  
    <p><b>Session Tag:</b> {{session_tag}}</p>  
    {{gear_used_html}}  
    {{sets_reps_html}}  
    {{cycling_html}}  
    {{yoga_html}}  
    <p><b>Post-Session Notes:</b> {{post_session_notes_html}}</p>  
  </div>  
  
</div>  
  
<div id="promptModal" class="modal">  
  <div class="modal-content">  
    <span class="close-btn">&times;</span>  
    <h2>Full LLM Prompt Sent to OpenAI</h2>  
    <p>This is the exact structured prompt sent to the LLM when 'Generate AI Summary' is clicked.</p>  
    <div class="prompt-code"><pre>{{llm_analysis_prompt}}</pre></div>  
    <p class="caption" style="margin-top: 15px;">  
      <strong>System Instruction:</strong>  
      "You are a professional Workout Radiologist. Your job is to synthesize the provided data "
      "into a concise, qualitative summary (max 3 sentences)."
    </p>  
  </div>  
</div>  
  
<div id="customViewModal" class="modal">  
  <div class="modal-content">  
    <span class="close-btn">&times;</span>  
    <h2>How Custom Channel Similarity Search Works</h2>
    <p style="color: var(--atlas-light-text); font-size: 1.05em; margin-bottom: 20px;">
      When you select different RGB channels, you're exploring the same workout data from different perspectives. 
      Here's how the intelligent similarity search works:
    </p>
    
    <div style="background-color: var(--atlas-hover-bg); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--atlas-green);">
      <h3 style="color: var(--atlas-green); margin-top: 0;">üéØ The Smart Approach</h3>
      <p style="color: var(--atlas-light-text);">
        Instead of storing vectors for all 60 possible channel combinations, we use a 
        <strong>hybrid intelligent approach</strong> with <strong>pre-indexed common combinations</strong>:
      </p>
      <ol style="color: var(--atlas-mid-text); line-height: 1.8; margin-left: 20px;">
        <li><strong>Indexed Combinations (Fast ‚ö° ~5-10ms):</strong> Common channel combinations are pre-computed and indexed in MongoDB:
          <ul style="margin-top: 8px; margin-left: 15px; line-height: 1.6;">
            <li><strong>Default:</strong> HR, Calories, Speed</li>
            <li><strong>Cycling:</strong> Power, Cadence, HR</li>
            <li><strong>Performance:</strong> Power, Speed, HR</li>
            <li><strong>Cycling-Specific:</strong> Speed, Cadence, HR</li>
          </ul>
          These use MongoDB's indexed vector search directly - blazing fast!
        </li>
        <li><strong>Other Combinations (Fast ~200-500ms):</strong> For less common combinations, we use MongoDB vector search as a smart pre-filter to find ~100 likely candidates, then re-rank them with custom channel vectors computed on-the-fly.</li>
        <li><strong>Best of Both Worlds:</strong> Common combinations get indexed performance, while still supporting unlimited flexibility for all 60 possible combinations!</li>
      </ol>
    </div>

    <div style="background-color: var(--atlas-hover-bg); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--accent-purple);">
      <h3 style="color: var(--accent-purple); margin-top: 0;">üîç How It Finds Similar Workouts</h3>
      <p style="color: var(--atlas-light-text); margin-bottom: 10px;">
        When you change RGB channels and click "Update View & Find Similar":
      </p>
      
      <div style="background-color: var(--atlas-dark-blue); padding: 12px; border-radius: 6px; margin: 10px 0; border-left: 3px solid var(--atlas-green);">
        <p style="margin: 0 0 8px 0; color: var(--atlas-green); font-weight: 600; font-size: 0.95em;">
          ‚úì For Indexed Combinations (HR/Calories/Speed, Power/Cadence/HR, Power/Speed/HR, Speed/Cadence/HR):
        </p>
        <div style="font-family: monospace; font-size: 0.9em; color: var(--atlas-mid-text); margin-left: 10px;">
          <strong style="color: var(--atlas-light-text);">Step 1:</strong> Use pre-computed indexed vector directly<br>
          <strong style="color: var(--atlas-light-text);">Step 2:</strong> MongoDB indexed vector search (blazing fast!)<br>
          <strong style="color: var(--atlas-light-text);">Step 3:</strong> Return top matches instantly (~5-10ms)
        </div>
      </div>
      
      <div style="background-color: var(--atlas-dark-blue); padding: 12px; border-radius: 6px; margin: 10px 0; border-left: 3px solid var(--accent-orange);">
        <p style="margin: 0 0 8px 0; color: var(--accent-orange); font-weight: 600; font-size: 0.95em;">
          For Other Combinations:
        </p>
        <div style="font-family: monospace; font-size: 0.9em; color: var(--atlas-mid-text); margin-left: 10px;">
          <strong style="color: var(--atlas-light-text);">Step 1:</strong> Generate query vector with your selected channels<br>
          <strong style="color: var(--atlas-light-text);">Step 2:</strong> Pre-filter using indexed default vector search (finds ~100 candidates)<br>
          <strong style="color: var(--atlas-light-text);">Step 3:</strong> Generate custom vectors for each candidate<br>
          <strong style="color: var(--atlas-light-text);">Step 4:</strong> Compute cosine similarity with custom vectors<br>
          <strong style="color: var(--atlas-light-text);">Step 5:</strong> Rank and return top matches (~200-500ms)
        </div>
      </div>
      
      <p style="color: var(--atlas-mid-text); font-size: 0.95em; margin-top: 10px;">
        The system automatically chooses the fastest approach based on your channel selection. 
        Common combinations get indexed performance, while uncommon ones still work efficiently via smart pre-filtering!
      </p>
    </div>

    <div style="background-color: var(--atlas-hover-bg); padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent-blue);">
      <h3 style="color: var(--accent-blue); margin-top: 0;">üí° Why This Is Powerful</h3>
      <ul style="color: var(--atlas-mid-text); line-height: 1.8; margin-left: 20px;">
        <li><strong>Optimized Storage:</strong> We only index the most common combinations (4 out of 60), avoiding massive storage overhead while still covering the most useful cases</li>
        <li><strong>Blazing Fast for Common Cases:</strong> Indexed combinations get ~5-10ms search times, just as fast as the default view!</li>
        <li><strong>Smart Fallback:</strong> Other combinations still work efficiently via intelligent pre-filtering (~200-500ms)</li>
        <li><strong>Flexible Exploration:</strong> Try any channel combination and instantly see different similarity patterns</li>
        <li><strong>Pattern Discovery:</strong> The same workout can be similar to different sets of workouts depending on which metrics you focus on</li>
      </ul>
      <p style="color: var(--atlas-light-text); margin-top: 15px; font-weight: 600;">
        üöÄ Try it: Change the RGB channels and watch how the similar workouts change! 
        Common combinations like Power/Cadence/HR will be blazing fast!
      </p>
    </div>
  </div>  
</div>

<div id="alphaInfoModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h2>üéØ The Secret Data Lane: Why Alpha Channel is Cool!</h2>
    
    <div style="background-color: var(--atlas-hover-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--atlas-green);">
      <h3 style="color: var(--atlas-green); margin-top: 0;">üí° The Concept</h3>
      <p style="color: var(--atlas-light-text); line-height: 1.8;">
        Our current vector is <strong>8x8x3 (RGB)</strong> = 192 values. What if we used <strong>8x8x4 (RGBA)</strong>? 
        That "A" stands for <strong>Alpha</strong>, or <strong>opacity</strong>, and it gives us a <strong>fourth 64-point data lane</strong>. 
        What can we put there? <strong>Anything we want!</strong>
      </p>
    </div>

    <div style="background-color: var(--atlas-hover-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--accent-blue);">
      <h3 style="color: var(--accent-blue); margin-top: 0;">üìä The Obvious Application: A Fourth Metric</h3>
      <p style="color: var(--atlas-light-text); line-height: 1.8;">
        This is the simplest upgrade. For a running or cycling workout, that fourth channel is a perfect place for 
        <strong>Cadence (RPM)</strong>. Now, our vector search won't just find workouts with a similar heart rate and speed profile; 
        it will find ones with a similar <strong>turnover and efficiency</strong>.
      </p>
      <p style="color: var(--atlas-mid-text); margin-top: 10px; font-style: italic;">
        üí° <strong>Example:</strong> Two workouts might have identical HR and speed patterns, but one has high cadence (efficient) 
        while the other has low cadence (struggling). With Alpha = Cadence, they'll have different vectors!
      </p>
    </div>

    <div style="background-color: var(--atlas-hover-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--accent-orange);">
      <h3 style="color: var(--accent-orange); margin-top: 0;">üîß The "Hacky" Application: Encoding Data Quality</h3>
      <p style="color: var(--atlas-light-text); line-height: 1.8;">
        This is where it gets really clever. What does "Alpha" mean? <strong>Transparency</strong>.
      </p>
      <div style="background-color: var(--atlas-dark-blue); padding: 15px; border-radius: 6px; margin-top: 15px;">
        <p style="color: var(--atlas-light-text); margin: 0 0 10px 0; font-weight: 600;">Real-World Problem:</p>
        <p style="color: var(--atlas-mid-text); margin: 0;">
          My heart rate monitor disconnected for 5 minutes during a run. In my data, this shows up as a flat line or a zero.
        </p>
      </div>
      <div style="background-color: var(--atlas-dark-blue); padding: 15px; border-radius: 6px; margin-top: 15px;">
        <p style="color: var(--atlas-green); margin: 0 0 10px 0; font-weight: 600;">The Hack:</p>
        <p style="color: var(--atlas-mid-text); margin: 0;">
          When we create our 8x8x4 vector, we use the Alpha channel to represent <strong>"data confidence"</strong>:
        </p>
        <ul style="color: var(--atlas-mid-text); margin: 10px 0 0 20px; line-height: 1.8;">
          <li>For the 59 minutes of good data: <strong>Alpha = 255 (Opaque)</strong></li>
          <li>For the 5 minutes of bad/missing data: <strong>Alpha = 0 (Transparent)</strong></li>
        </ul>
      </div>
      <div style="background-color: var(--atlas-dark-blue); padding: 15px; border-radius: 6px; margin-top: 15px;">
        <p style="color: var(--accent-purple); margin: 0 0 10px 0; font-weight: 600;">Why This Is Genius:</p>
        <p style="color: var(--atlas-mid-text); margin: 0;">
          The vector search inherently understands this. When I search for a "perfect" workout (all Alpha=255), 
          the database knows to ignore my "gappy" workout because its vector is fundamentally different. 
          But if I search for another workout where my sensor also dropped out, <strong>their vectors will match!</strong> 
          We've made our database understand the concept of <strong>"unreliable data"</strong>.
        </p>
      </div>
    </div>

    <div style="background-color: var(--atlas-hover-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--accent-purple);">
      <h3 style="color: var(--accent-purple); margin-top: 0;">üåê The Global Application: Encoding RPE</h3>
      <p style="color: var(--atlas-light-text); line-height: 1.8;">
        We could also use this channel to encode <strong>"global"</strong> data, like setting the entire Alpha grid to a single value 
        representing the user's <strong>RPE (Rated Perceived Exertion)</strong>. Now, "hard" workouts have a different "tint" than "easy" ones.
      </p>
      <p style="color: var(--atlas-mid-text); margin-top: 10px; font-style: italic;">
        üí° <strong>Example:</strong> Two workouts might have identical HR/speed/cadence patterns, but one felt "easy" (RPE=3) 
        while the other felt "hard" (RPE=8). With Alpha = RPE, they'll have different vectors, enabling similarity matching 
        based on perceived effort!
      </p>
    </div>

    <div style="background-color: var(--atlas-dark-blue); padding: 20px; border-radius: 8px; border: 2px solid var(--atlas-green);">
      <h3 style="color: var(--atlas-green); margin-top: 0;">üöÄ Why This Is Powerful</h3>
      <ul style="color: var(--atlas-light-text); line-height: 1.8; margin-left: 20px;">
        <li><strong>More Data Points:</strong> 256-element vectors vs 192-element = 64 more dimensions for pattern matching</li>
        <li><strong>Richer Similarity:</strong> Find workouts similar in 4 metrics instead of 3</li>
        <li><strong>Data Quality Awareness:</strong> The database "knows" which data points are reliable</li>
        <li><strong>Contextual Matching:</strong> Match workouts by perceived effort, not just physical metrics</li>
        <li><strong>Flexible Encoding:</strong> Use the same channel for different purposes (metric, quality, or global value)</li>
      </ul>
      <p style="color: var(--atlas-light-text); margin-top: 15px; font-weight: 600;">
        üéØ <strong>Try it:</strong> Switch between different Alpha modes above and see how it changes the vector similarity matching!
      </p>
    </div>
  </div>
</div>

<div id="whyModal" class="modal">  
  <div class="modal-content">  
    <span class="close-btn">&times;</span>  
    <h2>Why the "Visual Fingerprint"?</h2>  
    <div class="modal-comparison" style="display: flex; gap: 20px;">  
      <div class="pain-point" style="flex: 1;">  
        <h3>‚ùå The Old Way (Painful!)</h3>  
        <p>Comparing raw time-series data (like minute-by-minute heart rate) directly is:</p>  
        <ul style="padding-left: 20px;">  
          <li><strong>Slow:</strong> Algorithms like DTW are complex - comparing millions takes ages.</li>  
          <li><strong>Unindexable:</strong> You can't build a fast search index. Every search requires comparing against *everything*.</li>  
          <li><strong>Impractical:</strong> Real-time "find similar patterns" is basically impossible at scale.</li>  
        </ul>  
      </div>  
      <div class="divider" style="border-left: 2px solid var(--atlas-border);"></div>  
      <div class="cool-point" style="flex: 1;">  
        <h3>‚úÖ The Vector Way (Awesome!)</h3>  
        <p>Turning the pattern into a vector ("fingerprint") via this encoding pipeline + Atlas Vector Search is:</p>  
        <ul style="padding-left: 20px;">  
          <li><strong>Indexable:</strong> Atlas builds a highly optimized vector index (HNSW).</li>  
          <li><strong>Fast:</strong> Finding similar patterns in millions takes milliseconds, not hours.</li>  
          <li><strong>Shape-Focused:</strong> Captures the *structure* of the effort, perfect for finding workouts that *feel* the same.</li>  
        </ul>  
      </div>  
    </div>  
    <p class="bottom-line" style="text-align: center; font-size: 1.2em; font-weight: 600; margin-top: 25px; color: var(--atlas-light-text);">  
      <strong>We trade a little precision for a HUGE gain in speed and scalability!</strong>  
    </p>  
  </div>  
</div>

<div id="hybridSearchModal" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <span class="close-btn">&times;</span>
    <h2>üîç Hybrid Search: The AI Vibe-Check + The Human Filter</h2>
    
    <div style="background-color: var(--atlas-hover-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--atlas-green);">
      <h3 style="color: var(--atlas-green); margin-top: 0;">üí° Why This Is Genius</h3>
      <p style="color: var(--atlas-light-text); line-height: 1.8;">
        This is how people actually think. We blend fuzzy concepts ("vibe," "felt strong") with concrete facts ("Outdoor Run"). 
        Hybrid search lets our application do the same, giving us the best of both worlds.
      </p>
    </div>

    <div style="background-color: var(--atlas-dark-blue); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
      <h3 style="color: var(--atlas-light-text); margin-top: 0; margin-bottom: 15px;">Real-World Example</h3>
      <p style="color: var(--atlas-light-text); line-height: 1.8; margin-bottom: 15px;">
        I'm planning my week and want to find a good workout to do. I can now ask a question that is part-AI, part-human:
      </p>
      <div style="background-color: var(--atlas-hover-bg); padding: 15px; border-radius: 6px; margin: 10px 0; border-left: 3px solid var(--accent-blue);">
        <p style="margin: 0; color: var(--atlas-light-text); font-weight: 600; font-size: 0.95em;">
          "Show me workouts with a vibe similar to my last 'Tempo Run'"
        </p>
        <p style="margin: 5px 0 0 0; color: var(--atlas-mid-text); font-size: 0.9em; font-style: italic;">
          ‚Üê This is the <strong style="color: var(--accent-blue);">vector search</strong> (fuzzy, vibe-based)
        </p>
      </div>
      <div style="background-color: var(--atlas-hover-bg); padding: 15px; border-radius: 6px; margin: 10px 0; border-left: 3px solid var(--atlas-green);">
        <p style="margin: 0; color: var(--atlas-light-text); font-weight: 600; font-size: 0.95em;">
          "...but only show me ones where my notes said I 'felt strong'"
        </p>
        <p style="margin: 5px 0 0 0; color: var(--atlas-mid-text); font-size: 0.9em; font-style: italic;">
          ‚Üê This is the <strong style="color: var(--atlas-green);">text search</strong> (precise, factual)
        </p>
      </div>
      <div style="background-color: var(--atlas-hover-bg); padding: 15px; border-radius: 6px; margin: 10px 0; border-left: 3px solid var(--accent-orange);">
        <p style="margin: 0; color: var(--atlas-light-text); font-weight: 600; font-size: 0.95em;">
          "...and where the workout type was 'Outdoor Run'"
        </p>
        <p style="margin: 5px 0 0 0; color: var(--atlas-mid-text); font-size: 0.9em; font-style: italic;">
          ‚Üê This is a <strong style="color: var(--accent-orange);">filter</strong> (exact match)
        </p>
      </div>
    </div>

    <!-- What Fields Are Searched - Visual Explanation -->
    <div style="background-color: var(--atlas-hover-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--accent-blue);">
      <h3 style="color: var(--accent-blue); margin-top: 0; margin-bottom: 15px;">üîç What Fields Are Being Searched?</h3>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 15px;">
        <!-- Vector Search -->
        <div style="background-color: var(--atlas-dark-blue); padding: 15px; border-radius: 6px; border: 2px solid var(--accent-blue);">
          <h4 style="color: var(--accent-blue); margin-top: 0; margin-bottom: 10px; font-size: 1em; display: flex; align-items: center; gap: 8px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM4.5 7.5a.5.5 0 0 0 0 1h5.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H4.5z"/>
            </svg>
            Vector Search (Vibe)
          </h4>
          <p style="color: var(--atlas-light-text); font-size: 0.9em; margin: 0 0 8px 0; font-weight: 600;">Field: <code style="background-color: var(--atlas-bg); padding: 2px 6px; border-radius: 3px; font-size: 0.85em;">workout_vector</code></p>
          <p style="color: var(--atlas-mid-text); font-size: 0.85em; margin: 0; line-height: 1.5;">
            A 192-element vector encoding the workout's time-series pattern (HR, Calories, Speed). Finds workouts with similar "vibe" or pattern shape.
          </p>
        </div>
        
        <!-- Text Search -->
        <div style="background-color: var(--atlas-dark-blue); padding: 15px; border-radius: 6px; border: 2px solid var(--atlas-green);">
          <h4 style="color: var(--atlas-green); margin-top: 0; margin-bottom: 10px; font-size: 1em; display: flex; align-items: center; gap: 8px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
            </svg>
            Text Search (Facts)
          </h4>
          <p style="color: var(--atlas-light-text); font-size: 0.9em; margin: 0 0 8px 0; font-weight: 600;">Fields:</p>
          <ul style="color: var(--atlas-mid-text); font-size: 0.85em; margin: 0; padding-left: 20px; line-height: 1.8;">
            <li><code style="background-color: var(--atlas-bg); padding: 2px 6px; border-radius: 3px; font-size: 0.85em;">post_session_notes.notes</code> <span style="color: var(--atlas-green);">(weight: 10)</span></li>
            <li><code style="background-color: var(--atlas-bg); padding: 2px 6px; border-radius: 3px; font-size: 0.85em;">session_tag</code> <span style="color: var(--atlas-green);">(weight: 8)</span></li>
            <li><code style="background-color: var(--atlas-bg); padding: 2px 6px; border-radius: 3px; font-size: 0.85em;">workout_type</code> <span style="color: var(--atlas-green);">(weight: 5)</span></li>
            <li><code style="background-color: var(--atlas-bg); padding: 2px 6px; border-radius: 3px; font-size: 0.85em;">ai_classification</code> <span style="color: var(--atlas-green);">(weight: 3)</span></li>
          </ul>
          <p style="color: var(--atlas-mid-text); font-size: 0.85em; margin: 8px 0 0 0; line-height: 1.5;">
            Full-text search across notes, tags, types, and classifications. Higher weights = more important.
          </p>
        </div>
        
        <!-- Filters -->
        <div style="background-color: var(--atlas-dark-blue); padding: 15px; border-radius: 6px; border: 2px solid var(--accent-orange);">
          <h4 style="color: var(--accent-orange); margin-top: 0; margin-bottom: 10px; font-size: 1em; display: flex; align-items: center; gap: 8px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"/>
            </svg>
            Filters (Exact)
          </h4>
          <p style="color: var(--atlas-light-text); font-size: 0.9em; margin: 0 0 8px 0; font-weight: 600;">Fields:</p>
          <ul style="color: var(--atlas-mid-text); font-size: 0.85em; margin: 0; padding-left: 20px; line-height: 1.8;">
            <li><code style="background-color: var(--atlas-bg); padding: 2px 6px; border-radius: 3px; font-size: 0.85em;">workout_type</code> (exact match)</li>
            <li><code style="background-color: var(--atlas-bg); padding: 2px 6px; border-radius: 3px; font-size: 0.85em;">session_tag</code> (exact match)</li>
          </ul>
          <p style="color: var(--atlas-mid-text); font-size: 0.85em; margin: 8px 0 0 0; line-height: 1.5;">
            Exact match filters applied to both vector and text search results.
          </p>
        </div>
      </div>
      
      <div style="background-color: var(--atlas-dark-blue); padding: 12px; border-radius: 6px; margin-top: 15px; border-left: 3px solid var(--atlas-green);">
        <p style="margin: 0; color: var(--atlas-light-text); font-size: 0.9em; line-height: 1.6;">
          <strong>üí° How It Works:</strong> When you enter a text query like "felt strong", it searches across <strong>all 4 text fields</strong> 
          (notes, session_tag, workout_type, ai_classification) with different weights. The vector search finds workouts with similar patterns, 
          and filters narrow down to exact matches. Results are combined with weighted scoring (70% vector, 30% text).
        </p>
      </div>
    </div>

    <!-- Hybrid Search Form -->
    <div style="background-color: var(--atlas-dark-blue); padding: 20px; border-radius: 8px; border: 2px solid var(--atlas-green);">
      <h3 style="color: var(--atlas-green); margin-top: 0; margin-bottom: 20px;">Try It Yourself</h3>
      <form id="hybridSearchForm" style="margin: 0;">
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: var(--atlas-light-text); font-weight: 600; margin-bottom: 8px; font-size: 0.95em;">
            Text Search (optional)
            <span style="color: var(--atlas-mid-text); font-weight: 400; font-size: 0.85em; font-style: italic;">
              - Search in notes, session tags, workout types, classifications
            </span>
          </label>
          <input 
            type="text" 
            id="hybridTextQuery" 
            placeholder="e.g., 'felt strong', 'Tempo Pace', 'High Intensity'"
            style="width: 100%; padding: 10px; background-color: var(--atlas-bg); color: var(--atlas-light-text); border: 1px solid var(--atlas-border); border-radius: 6px; font-size: 1em; font-family: inherit;"
          />
        </div>
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: var(--atlas-light-text); font-weight: 600; margin-bottom: 8px; font-size: 0.95em;">
            Workout Type Filter (optional)
            <span style="color: var(--atlas-mid-text); font-weight: 400; font-size: 0.85em; font-style: italic;">
              - Exact match filter
            </span>
          </label>
          <select 
            id="hybridWorkoutType" 
            style="width: 100%; padding: 10px; background-color: var(--atlas-bg); color: var(--atlas-light-text); border: 1px solid var(--atlas-border); border-radius: 6px; font-size: 1em; font-family: inherit;"
          >
            <option value="">Any workout type</option>
            <option value="Outdoor Run">Outdoor Run</option>
            <option value="Cycling">Cycling</option>
            <option value="Strength">Strength</option>
            <option value="Yoga">Yoga</option>
          </select>
        </div>
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: var(--atlas-light-text); font-weight: 600; margin-bottom: 8px; font-size: 0.95em;">
            Session Tag Filter (optional)
            <span style="color: var(--atlas-mid-text); font-weight: 400; font-size: 0.85em; font-style: italic;">
              - Exact match filter
            </span>
          </label>
          <select 
            id="hybridSessionTag" 
            style="width: 100%; padding: 10px; background-color: var(--atlas-bg); color: var(--atlas-light-text); border: 1px solid var(--atlas-border); border-radius: 6px; font-size: 1em; font-family: inherit;"
          >
            <option value="">Any session tag</option>
            <option value="Tempo Pace">Tempo Pace</option>
            <option value="Threshold">Threshold</option>
            <option value="Race Day">Race Day</option>
            <option value="High Intensity Interval">High Intensity Interval</option>
            <option value="Recovery">Recovery</option>
            <option value="Z2 Cardio">Z2 Cardio</option>
            <option value="Easy Recovery Run">Easy Recovery Run</option>
          </select>
        </div>
        
        <div style="display: flex; gap: 10px; align-items: center;">
          <button 
            type="submit" 
            class="control-btn" 
            style="flex: 1; padding: 12px 20px; background-color: var(--atlas-green); color: var(--button-text-dark); font-size: 1em; font-weight: 600;"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 8px; vertical-align: -3px;">
              <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
            </svg>
            Search
          </button>
          <button 
            type="button" 
            id="hybridSearchClearBtn"
            class="control-btn" 
            style="padding: 12px 20px; background-color: var(--atlas-hover-bg); color: var(--atlas-light-text); border: 1px solid var(--atlas-border); font-size: 1em;"
          >
            Clear
          </button>
        </div>
      </form>
      
      <!-- Results Area -->
      <div id="hybridSearchResults" style="margin-top: 30px; display: none;">
        <h3 style="color: var(--atlas-light-text); margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid var(--atlas-border); padding-bottom: 10px;">
          Search Results
        </h3>
        <div id="hybridSearchResultsContent" style="color: var(--atlas-mid-text);">
          <!-- Results will be populated here -->
        </div>
      </div>
      
      <!-- Loading indicator -->
      <div id="hybridSearchLoading" style="display: none; text-align: center; padding: 20px; color: var(--atlas-mid-text);">
        <p style="margin: 0;">Searching...</p>
      </div>
    </div>
  </div>
</div>
  
<script>  
document.addEventListener("DOMContentLoaded", function() {  
  // --- Particle background (optional). If you have the code, place it here. ---
  const canvas = document.getElementById("particle-canvas");  
  if (!canvas) {  
    console.error("Particle.js: Canvas element with id 'particle-canvas' not found.");  
    return;  
  }  
  const ctx = canvas.getContext("2d");  
  let particles = [];  
  
  function resizeCanvas() {  
    canvas.width = window.innerWidth;  
    canvas.height = window.innerHeight;  
  }  
  window.addEventListener("resize", resizeCanvas);  
  resizeCanvas();  
  
  function createParticle() {  
    const x = Math.random() * canvas.width;  
    const y = Math.random() * canvas.height;  
    const size = Math.random() * 2.5 + 1;  
    const speedX = (Math.random() * 0.5 - 0.25) * 0.6;  
    const speedY = (Math.random() * 0.5 - 0.25) * 0.6;  
    const opacity = Math.random() * 0.5 + 0.15;  
    particles.push({x, y, size, speedX, speedY, opacity});  
  }  
  const numParticles = window.innerWidth < 768 ? 60 : 100;  
  for (let i = 0; i < numParticles; i++) {  
    createParticle();  
  }  
  function animate() {  
    ctx.clearRect(0, 0, canvas.width, canvas.height);  
    particles.forEach((p, index) => {  
      p.x += p.speedX;  
      p.y += p.speedY;  
      if (p.x < -p.size) p.x = canvas.width + p.size;  
      if (p.x > canvas.width + p.size) p.x = -p.size;  
      if (p.y < -p.size) p.y = canvas.height + p.size;  
      if (p.y > canvas.height + p.size) p.y = -p.size;  
  
      ctx.beginPath();  
      ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);  
      ctx.fillStyle = `rgba(0, 237, 100, ${p.opacity * 0.8})`;  
      ctx.fill();  
    });  
    requestAnimationFrame(animate);  
  }  
  animate();  
});  
</script>  
  
<script>  
document.addEventListener("DOMContentLoaded", function() {  
  // --- Modal Logic (#promptModal) ---  
  const promptModal = document.getElementById("promptModal");  
  const promptBtn = document.getElementById("inspectPromptBtn");  
  const promptClose = promptModal ? promptModal.querySelector(".close-btn") : null;  
  
  if (promptBtn) {  
    promptBtn.onclick = function() {  
      if(promptModal) promptModal.style.display = "block";  
    }  
  }  
  if (promptClose) {  
    promptClose.onclick = function() {  
      if(promptModal) promptModal.style.display = "none";  
    }  
  }

  // --- Modal Logic (#alphaInfoModal) ---
  const alphaInfoModal = document.getElementById("alphaInfoModal");
  const alphaInfoBtn = document.getElementById("alphaInfoBtn");
  const alphaInfoClose = alphaInfoModal ? alphaInfoModal.querySelector(".close-btn") : null;
  
  if (alphaInfoBtn) {
    alphaInfoBtn.onclick = function() {
      if(alphaInfoModal) alphaInfoModal.style.display = "block";
    };
  }
  if (alphaInfoClose) {
    alphaInfoClose.onclick = function() {
      if(alphaInfoModal) alphaInfoModal.style.display = "none";
    };
  }
  
  // Link to open alpha info modal
  const learnMoreAlphaLink = document.getElementById("learnMoreAlpha");
  if (learnMoreAlphaLink) {
    learnMoreAlphaLink.onclick = function(e) {
      e.preventDefault();
      if(alphaInfoModal) alphaInfoModal.style.display = "block";
    };
  }  
  
  // --- Modal Logic (#customViewModal) ---
  const customViewModal = document.getElementById("customViewModal");
  const explainCustomBtn = document.getElementById("explainCustomBtn");
  const customViewClose = customViewModal ? customViewModal.querySelector(".close-btn") : null;
  
  if (explainCustomBtn) {
    explainCustomBtn.onclick = function() {
      if(customViewModal) customViewModal.style.display = "block";
    };
  }
  if (customViewClose) {
    customViewClose.onclick = function() {
      if(customViewModal) customViewModal.style.display = "none";
    };
  }

  // --- Modal Logic (#whyModal) ---  
  const whyModal = document.getElementById("whyModal");  
  const whyBtn = document.getElementById("whyCoolBtn");  
  const whyClose = whyModal ? whyModal.querySelector(".close-btn") : null;  
  
  if (whyBtn) {  
    whyBtn.onclick = function() {  
      if(whyModal) whyModal.style.display = "block";  
    }  
  }  
  if (whyClose) {  
    whyClose.onclick = function() {  
      if(whyModal) whyModal.style.display = "none";  
    }  
  }  
  
  // --- Modal Logic (#hybridSearchModal) ---
  const hybridSearchModal = document.getElementById("hybridSearchModal");
  const hybridSearchBtn = document.getElementById("hybridSearchBtn");
  const hybridSearchClose = hybridSearchModal ? hybridSearchModal.querySelector(".close-btn") : null;
  
  if (hybridSearchBtn) {
    hybridSearchBtn.onclick = function() {
      if(hybridSearchModal) hybridSearchModal.style.display = "block";
    };
  }
  if (hybridSearchClose) {
    hybridSearchClose.onclick = function() {
      if(hybridSearchModal) hybridSearchModal.style.display = "none";
    };
  }
  
  // --- Hybrid Search Form Logic ---
  const hybridSearchForm = document.getElementById("hybridSearchForm");
  const hybridSearchClearBtn = document.getElementById("hybridSearchClearBtn");
  const hybridSearchResults = document.getElementById("hybridSearchResults");
  const hybridSearchResultsContent = document.getElementById("hybridSearchResultsContent");
  const hybridSearchLoading = document.getElementById("hybridSearchLoading");
  
  if (hybridSearchForm) {
    hybridSearchForm.addEventListener("submit", async function(e) {
      e.preventDefault();
      
      const textQuery = document.getElementById("hybridTextQuery").value.trim() || null;
      const workoutType = document.getElementById("hybridWorkoutType").value || null;
      const sessionTag = document.getElementById("hybridSessionTag").value || null;
      
      // Show loading, hide results
      hybridSearchLoading.style.display = "block";
      hybridSearchResults.style.display = "none";
      
      try {
        // Build query string
        const params = new URLSearchParams();
        if (textQuery) params.append("text_query", textQuery);
        if (workoutType) params.append("workout_type", workoutType);
        if (sessionTag) params.append("session_tag", sessionTag);
        params.append("limit", "10");
        
        const url = `/experiments/data_imaging/workout/{{workout_id}}/hybrid-search?${params.toString()}`;
        
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Search failed: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        // Hide loading, show results
        hybridSearchLoading.style.display = "none";
        hybridSearchResults.style.display = "block";
        
        // Display results
        if (data.results && data.results.length > 0) {
          let html = `<p style="color: var(--atlas-light-text); margin-bottom: 15px; font-weight: 600;">Found ${data.total_found} workout(s):</p>`;
          html += '<ul style="list-style: none; padding: 0; margin: 0;">';
          
          data.results.forEach((result, index) => {
            const notes = result.post_session_notes?.notes || "No notes";
            const vectorScore = result.vector_score > 0 ? result.vector_score.toFixed(4) : "N/A";
            const textScore = result.text_score > 0 ? result.text_score.toFixed(4) : "N/A";
            const combinedScore = result.combined_score > 0 ? result.combined_score.toFixed(4) : "N/A";
            
            html += `
              <li style="background-color: var(--atlas-hover-bg); padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid var(--atlas-green);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <a href="/experiments/data_imaging/workout/${result.workout_id}" style="color: var(--atlas-green); font-weight: 600; font-size: 1.1em; text-decoration: none;">
                    Workout #${result.workout_id}
                  </a>
                  <span style="color: var(--atlas-mid-text); font-size: 0.9em;">Combined Score: ${combinedScore}</span>
                </div>
                <div style="color: var(--atlas-mid-text); font-size: 0.9em; margin-bottom: 8px;">
                  <strong>Type:</strong> ${result.workout_type || "N/A"} | 
                  <strong>Tag:</strong> ${result.session_tag || "N/A"} | 
                  <strong>RPE:</strong> ${result.rpe || "N/A"}
                </div>
                <div style="color: var(--atlas-mid-text); font-size: 0.85em; margin-bottom: 8px;">
                  <strong>Notes:</strong> ${notes}
                </div>
                <div style="color: var(--atlas-mid-text); font-size: 0.85em; display: flex; gap: 15px;">
                  <span>Vector Score: <strong style="color: var(--accent-blue);">${vectorScore}</strong></span>
                  <span>Text Score: <strong style="color: var(--atlas-green);">${textScore}</strong></span>
                </div>
              </li>
            `;
          });
          
          html += '</ul>';
          hybridSearchResultsContent.innerHTML = html;
        } else {
          hybridSearchResultsContent.innerHTML = `
            <p style="color: var(--atlas-mid-text); text-align: center; padding: 20px;">
              No workouts found matching your criteria. Try adjusting your search parameters.
            </p>
          `;
        }
      } catch (error) {
        hybridSearchLoading.style.display = "none";
        hybridSearchResults.style.display = "block";
        hybridSearchResultsContent.innerHTML = `
          <p style="color: var(--atlas-delete-red); text-align: center; padding: 20px;">
            Error: ${error.message}
          </p>
        `;
      }
    });
  }
  
  if (hybridSearchClearBtn) {
    hybridSearchClearBtn.onclick = function() {
      document.getElementById("hybridTextQuery").value = "";
      document.getElementById("hybridWorkoutType").value = "";
      document.getElementById("hybridSessionTag").value = "";
      hybridSearchResults.style.display = "none";
      hybridSearchLoading.style.display = "none";
    };
  }
  
  // --- Close modal on window click ---  
  window.onclick = function(event) {  
    if (event.target == promptModal) {  
      promptModal.style.display = "none";  
    }  
    if (event.target == customViewModal) {
      customViewModal.style.display = "none";
    }
    if (event.target == whyModal) {  
      whyModal.style.display = "none";  
    }
    if (event.target == alphaInfoModal) {
      alphaInfoModal.style.display = "none";
    }
    if (event.target == hybridSearchModal) {
      hybridSearchModal.style.display = "none";
    }
  }  
  
  // --- Analyze Form Logic (Unchanged) ---  
  const analyzeForm = document.getElementById("analyzeForm");  
  const analyzeBtn = document.getElementById("analyzeBtn");  
  if (analyzeForm && analyzeBtn) {  
    analyzeForm.addEventListener("submit", function(e) {  
      e.preventDefault(); 
      analyzeBtn.disabled = true;  
      analyzeBtn.innerHTML = 'Analyzing...';  
      analyzeBtn.style.backgroundColor = 'var(--accent-orange)';  
      analyzeBtn.style.color = 'var(--button-text-dark)';  
      
      // Get the *current* URL's query string, which might have custom r/g/b keys
      const queryString = window.location.search;
  
      fetch(analyzeForm.action, {  
        method: 'POST',  
        headers: { 'Content-Type': 'application/json' }  
      })
      .then(response => {  
        if (response.status === 303 || response.redirected) {
          // Manually redirect, *preserving* the query string
          let redirectUrl = response.headers.get('Location');
          if (redirectUrl.indexOf('?') === -1) { 
             redirectUrl += queryString; // Add our params
          }
          window.location.href = redirectUrl;  
        } else if (response.ok) {  
          window.location.reload();  
        } else {
          response.json().then(data => {  
            alert(`LLM Analysis Failed: ${data.detail}`);  
          }).catch(() => {  
            alert('LLM Analysis Failed. Check console and server logs.');  
          });
          analyzeBtn.disabled = false;
          analyzeBtn.innerHTML = `... (omitted) ... Generate AI Summary`;
          analyzeBtn.style.backgroundColor = 'var(--accent-blue)';
          analyzeBtn.style.color = 'white';
        }
      })
      .catch(error => {
        console.error('Network Error:', error);  
        alert('Network error during analysis.');  
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = `... (omitted) ... Generate AI Summary`;
        analyzeBtn.style.backgroundColor = 'var(--accent-blue)';
        analyzeBtn.style.color = 'white';
      });  
    });  
  }
  
  // ---
  // --- NEW: Client-side View Updater
  // ---
  const updateBtn = document.getElementById('updateViewBtn');
  const revertBtn = document.getElementById('revertViewBtn');
  
  // Selectors
  const rSelect = document.getElementById('r_key');
  const gSelect = document.getElementById('g_key');
  const bSelect = document.getElementById('b_key');
  const alphaModeSelect = document.getElementById('alpha_mode');
  const alphaKeySelect = document.getElementById('alpha_key');
  const alphaKeyGroup = document.getElementById('alpha_key_group');
  
  // Show/hide alpha key selector based on alpha mode
  if (alphaModeSelect && alphaKeyGroup) {
    alphaModeSelect.addEventListener('change', function() {
      if (this.value === 'fourth_metric') {
        alphaKeyGroup.style.display = 'flex';
      } else {
        alphaKeyGroup.style.display = 'none';
      }
    });
  }

  // 1. Get all the elements we need to update
  const elementsToUpdate = {
    imgMain: document.getElementById('main-fingerprint-img'),
    imgMainSmall: document.getElementById('main-fingerprint-img-small'),
    capR: document.getElementById('caption-r'),
    capG: document.getElementById('caption-g'),
    capB: document.getElementById('caption-b'),
    imgR: document.getElementById('img-channel-r'),
    imgG: document.getElementById('img-channel-g'),
    imgB: document.getElementById('img-channel-b'),
    textR: document.getElementById('text-channel-r'),
    textG: document.getElementById('text-channel-g'),
    textB: document.getElementById('text-channel-b')
  };
  
  // Alpha channel elements (may not exist initially)
  const alphaElements = {
    capA: document.getElementById('caption-a'),
    imgA: document.getElementById('img-channel-a'),
    textA: document.getElementById('text-channel-a'),
    alphaSection: document.querySelector('#img-channel-a')?.closest('div')
  };

  // 2. On page load, save the *initial* (revert) state to sessionStorage
  // This state is whatever the server rendered (canonical or from query params)
  const storagePrefix = 'revert_state_{{workout_id}}_';
  sessionStorage.setItem(storagePrefix + 'imgMainSrc', elementsToUpdate.imgMain.src);
  sessionStorage.setItem(storagePrefix + 'imgMainSmallSrc', elementsToUpdate.imgMainSmall.src);
  sessionStorage.setItem(storagePrefix + 'capRHTML', elementsToUpdate.capR.innerHTML);
  sessionStorage.setItem(storagePrefix + 'capGHTML', elementsToUpdate.capG.innerHTML);
  sessionStorage.setItem(storagePrefix + 'capBHTML', elementsToUpdate.capB.innerHTML);
  sessionStorage.setItem(storagePrefix + 'imgRSrc', elementsToUpdate.imgR.src);
  sessionStorage.setItem(storagePrefix + 'imgGSrc', elementsToUpdate.imgG.src);
  sessionStorage.setItem(storagePrefix + 'imgBSrc', elementsToUpdate.imgB.src);
  sessionStorage.setItem(storagePrefix + 'textRHTML', elementsToUpdate.textR.innerHTML);
  sessionStorage.setItem(storagePrefix + 'textGHTML', elementsToUpdate.textG.innerHTML);
  sessionStorage.setItem(storagePrefix + 'textBHTML', elementsToUpdate.textB.innerHTML);
  sessionStorage.setItem(storagePrefix + 'selectR', rSelect.value);
  sessionStorage.setItem(storagePrefix + 'selectG', gSelect.value);
  sessionStorage.setItem(storagePrefix + 'selectB', bSelect.value);
  if (alphaModeSelect) sessionStorage.setItem(storagePrefix + 'selectAlphaMode', alphaModeSelect.value);
  if (alphaKeySelect) sessionStorage.setItem(storagePrefix + 'selectAlphaKey', alphaKeySelect.value);

  // 3. Helper function to apply new data to the DOM
  function applyVizData(data) {
    elementsToUpdate.imgMain.src = 'data:image/png;base64,' + data.b64_combined;
    elementsToUpdate.imgMainSmall.src = 'data:image/png;base64,' + data.b64_combined;
    elementsToUpdate.capR.innerHTML = data.label_r_full_html;
    elementsToUpdate.capG.innerHTML = data.label_g_full_html;
    elementsToUpdate.capB.innerHTML = data.label_b_full_html;
    elementsToUpdate.imgR.src = 'data:image/png;base64,' + data.b64_r;
    elementsToUpdate.imgG.src = 'data:image/png;base64,' + data.b64_g;
    elementsToUpdate.imgB.src = 'data:image/png;base64,' + data.b64_b;
    elementsToUpdate.textR.innerHTML = data.label_r_short_html;
    elementsToUpdate.textG.innerHTML = data.label_g_short_html;
    elementsToUpdate.textB.innerHTML = data.label_b_short_html;
    
    // Handle alpha channel if present
    if (data.b64_a) {
      // Create alpha channel section if it doesn't exist
      if (!alphaElements.imgA) {
        const alphaSection = document.createElement('div');
        alphaSection.style.marginTop = '15px';
        alphaSection.style.textAlign = 'center';
        alphaSection.innerHTML = `
          <h4 style="color: var(--atlas-mid-text); margin-bottom: 10px; font-size: 1em;">Alpha Channel</h4>
          <img src="" alt="Alpha channel" class="channel-img" id="img-channel-a" style="width: 128px; height: 128px;">
          <p style="margin-top: 10px; color: var(--atlas-mid-text); font-size: 0.9em;" id="text-channel-a"></p>
        `;
        elementsToUpdate.capB.parentElement.appendChild(alphaSection);
        alphaElements.imgA = document.getElementById('img-channel-a');
        alphaElements.textA = document.getElementById('text-channel-a');
        alphaElements.capA = document.createElement('span');
        alphaElements.capA.id = 'caption-a';
        elementsToUpdate.capB.parentElement.insertBefore(alphaElements.capA, elementsToUpdate.capB.nextSibling);
        elementsToUpdate.capB.parentElement.insertBefore(document.createTextNode('<br>'), alphaElements.capA);
      }
      
      alphaElements.imgA.src = 'data:image/png;base64,' + data.b64_a;
      alphaElements.textA.innerHTML = data.label_a_short_html;
      alphaElements.capA.innerHTML = data.label_a_full_html;
      if (alphaElements.alphaSection) alphaElements.alphaSection.style.display = 'block';
      
      // Update pipeline section alpha channel
      const pipelineAlphaImg = document.getElementById('img-channel-a-pipeline');
      const pipelineAlphaText = document.getElementById('text-channel-a-pipeline');
      if (pipelineAlphaImg) {
        pipelineAlphaImg.src = 'data:image/png;base64,' + data.b64_a;
      }
      if (pipelineAlphaText) {
        pipelineAlphaText.innerHTML = data.label_a_short_html;
      }
      
      // Show alpha channel in pipeline if hidden
      const pipelineAlphaSubstep = pipelineAlphaImg?.closest('.substep');
      if (pipelineAlphaSubstep) {
        pipelineAlphaSubstep.style.display = 'flex';
      }
      
      // Update pipeline step 2 description
      const step2Desc = document.querySelector('.pipeline-step:nth-of-type(2) > p:last-of-type');
      if (step2Desc) {
        step2Desc.textContent = step2Desc.textContent.replace(/three|four/g, 'four');
        if (!step2Desc.textContent.includes('(R, G, B, and A)')) {
          step2Desc.textContent = step2Desc.textContent.replace(/channels"/, 'channels" (R, G, B, and A)');
        }
      }
      
      // Update pipeline step 3 title and description
      const step3Title = document.querySelector('.pipeline-step:nth-of-type(3) h3');
      if (step3Title) {
        step3Title.innerHTML = step3Title.innerHTML.replace(/8x8x3 RGB|8x8x4 RGBA/g, '8x8x4 RGBA');
      }
      const step3Desc = document.querySelector('.pipeline-step:nth-of-type(3) > p');
      if (step3Desc) {
        step3Desc.textContent = step3Desc.textContent.replace(/three|four/g, 'four');
      }
      
      // Update pipeline step 4 title and description
      const step4Title = document.querySelector('.pipeline-step:nth-of-type(4) h3');
      if (step4Title) {
        step4Title.innerHTML = step4Title.innerHTML.replace(/192-Element|256-Element/g, '256-Element');
      }
      const step4Desc = document.querySelector('.pipeline-step:nth-of-type(4) > p');
      if (step4Desc) {
        step4Desc.textContent = step4Desc.textContent.replace(/8x8x3|8x8x4/g, '8x8x4').replace(/192|256/g, '256');
      }
    } else {
      // Hide alpha channel section if not present
      if (alphaElements.alphaSection) alphaElements.alphaSection.style.display = 'none';
      if (alphaElements.capA) alphaElements.capA.style.display = 'none';
      
      // Hide alpha channel in pipeline
      const pipelineAlphaSubstep = document.getElementById('img-channel-a-pipeline')?.closest('.substep');
      if (pipelineAlphaSubstep) {
        pipelineAlphaSubstep.style.display = 'none';
      }
      
      // Update pipeline step 2 description back to three
      const step2Desc = document.querySelector('.pipeline-step:nth-of-type(2) > p:last-of-type');
      if (step2Desc) {
        step2Desc.textContent = step2Desc.textContent.replace(/four|three/g, 'three');
        step2Desc.textContent = step2Desc.textContent.replace(/ \(R, G, B, and A\)/, '');
      }
      
      // Update pipeline step 3 title and description back to RGB
      const step3Title = document.querySelector('.pipeline-step:nth-of-type(3) h3');
      if (step3Title) {
        step3Title.innerHTML = step3Title.innerHTML.replace(/8x8x4 RGBA|8x8x3 RGB/g, '8x8x3 RGB');
      }
      const step3Desc = document.querySelector('.pipeline-step:nth-of-type(3) > p');
      if (step3Desc) {
        step3Desc.textContent = step3Desc.textContent.replace(/four|three/g, 'three');
      }
      
      // Update pipeline step 4 title and description back to 192
      const step4Title = document.querySelector('.pipeline-step:nth-of-type(4) h3');
      if (step4Title) {
        step4Title.innerHTML = step4Title.innerHTML.replace(/256-Element|192-Element/g, '192-Element');
      }
      const step4Desc = document.querySelector('.pipeline-step:nth-of-type(4) > p');
      if (step4Desc) {
        step4Desc.textContent = step4Desc.textContent.replace(/8x8x4|8x8x3/g, '8x8x3').replace(/256|192/g, '192');
      }
    }
  }
  
  // 4. Add click listener for the "Update View" button (now auto-finds similar workouts)
  if (updateBtn) {
    updateBtn.addEventListener('click', function() {
      // Show loading state
      updateBtn.disabled = true;
      updateBtn.textContent = 'Updating & Finding Similar...';

      const rVal = rSelect.value;
      const gVal = gSelect.value;
      const bVal = bSelect.value;
      const alphaModeVal = alphaModeSelect ? alphaModeSelect.value : 'none';
      const alphaKeyVal = alphaKeySelect ? alphaKeySelect.value : 'cadence';
      
      // Construct the API URLs
      const vizUrl = `/experiments/data_imaging/workout/{{workout_id}}/viz?r_key=${rVal}&g_key=${gVal}&b_key=${bVal}&alpha_mode=${alphaModeVal}&alpha_key=${alphaKeyVal}`;
      const similarUrl = `/experiments/data_imaging/workout/{{workout_id}}/similar?r_key=${rVal}&g_key=${gVal}&b_key=${bVal}&alpha_mode=${alphaModeVal}&alpha_key=${alphaKeyVal}&limit=3`;

      // Fetch both visualization data and similar workouts in parallel
      Promise.all([
        fetch(vizUrl).then(response => {
          if (!response.ok) throw new Error(`Viz API error: ${response.statusText}`);
          return response.json();
        }),
        fetch(similarUrl).then(response => {
          if (!response.ok) throw new Error(`Similar API error: ${response.statusText}`);
          return response.json();
        })
      ])
        .then(([vizData, similarData]) => {
          // Apply the new visualization data
          applyVizData(vizData);
          
          // Show the revert button
          if (revertBtn) {
            revertBtn.style.display = 'inline-flex';
          }
          
          // Display similar workouts results
          // Update the channel info display
          const channelNames = {
            'heart_rate': 'Heart Rate',
            'calories_per_min': 'Calories',
            'speed_kph': 'Speed',
            'power': 'Power',
            'cadence': 'Cadence'
          };
          const rName = channelNames[rVal] || rVal.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
          const gName = channelNames[gVal] || gVal.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
          const bName = channelNames[bVal] || bVal.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
          
          const customViewChannelsEl = document.getElementById('custom-view-channels');
          if (customViewChannelsEl) {
            customViewChannelsEl.innerHTML = `<span style="color: var(--accent-red);">R: ${rName}</span> | <span style="color: var(--accent-green-viz);">G: ${gName}</span> | <span style="color: var(--accent-blue);">B: ${bName}</span>`;
          }
          
          if (similarData.similar && similarData.similar.length > 0) {
            const items = similarData.similar.map(item => {
              const sid = item.workout_id;
              let contextSpan = `Type: ${item.workout_type || '?'}`;
              if (item.session_tag) contextSpan += ` | Tag: ${item.session_tag}`;
              if (item.ai_classification && item.ai_classification !== 'Pending Analysis') {
                contextSpan += ` | Pattern: ${item.ai_classification}`;
              }
              
              return `<li><a href="/experiments/data_imaging/workout/${sid}?r_key=${encodeURIComponent(rVal)}&g_key=${encodeURIComponent(gVal)}&b_key=${encodeURIComponent(bVal)}&alpha_mode=${encodeURIComponent(alphaModeVal)}&alpha_key=${encodeURIComponent(alphaKeyVal)}">Workout #${sid}</a> <span>(${contextSpan})</span><br>Similarity Score: ${item.score.toFixed(4)}</li>`;
            });
            
            customSimilarList.innerHTML = items.join('');
            customSimilarResults.style.display = 'block';
          } else {
            customSimilarList.innerHTML = '<li>No similar workouts found for this channel combination.</li>';
            customSimilarResults.style.display = 'block';
          }
          
          // Restore button state
          updateBtn.disabled = false;
          updateBtn.textContent = 'Update View & Find Similar';
        })
        .catch(error => {
          console.error('Error updating view or finding similar:', error);
          alert('Failed to update visualization or find similar workouts. Check console.');
          // Restore button state
          updateBtn.disabled = false;
          updateBtn.textContent = 'Update View & Find Similar';
        });
    });
  }

  // Get references to custom similar results elements (used by update button)
  const customSimilarResults = document.getElementById('custom-similar-results');
  const customSimilarList = document.getElementById('custom-similar-list');

  // 5. Add click listener for the "Revert" button
  if (revertBtn) {
    revertBtn.addEventListener('click', function() {
      // Apply the saved data from sessionStorage
      elementsToUpdate.imgMain.src = sessionStorage.getItem(storagePrefix + 'imgMainSrc');
      elementsToUpdate.imgMainSmall.src = sessionStorage.getItem(storagePrefix + 'imgMainSmallSrc');
      elementsToUpdate.capR.innerHTML = sessionStorage.getItem(storagePrefix + 'capRHTML');
      elementsToUpdate.capG.innerHTML = sessionStorage.getItem(storagePrefix + 'capGHTML');
      elementsToUpdate.capB.innerHTML = sessionStorage.getItem(storagePrefix + 'capBHTML');
      elementsToUpdate.imgR.src = sessionStorage.getItem(storagePrefix + 'imgRSrc');
      elementsToUpdate.imgG.src = sessionStorage.getItem(storagePrefix + 'imgGSrc');
      elementsToUpdate.imgB.src = sessionStorage.getItem(storagePrefix + 'imgBSrc');
      elementsToUpdate.textR.innerHTML = sessionStorage.getItem(storagePrefix + 'textRHTML');
      elementsToUpdate.textG.innerHTML = sessionStorage.getItem(storagePrefix + 'textGHTML');
      elementsToUpdate.textB.innerHTML = sessionStorage.getItem(storagePrefix + 'textBHTML');
      
      // Reset the select dropdowns
      rSelect.value = sessionStorage.getItem(storagePrefix + 'selectR');
      gSelect.value = sessionStorage.getItem(storagePrefix + 'selectG');
      bSelect.value = sessionStorage.getItem(storagePrefix + 'selectB');
      if (alphaModeSelect) alphaModeSelect.value = sessionStorage.getItem(storagePrefix + 'selectAlphaMode') || 'none';
      if (alphaKeySelect) alphaKeySelect.value = sessionStorage.getItem(storagePrefix + 'selectAlphaKey') || 'cadence';
      if (alphaKeyGroup && alphaModeSelect) {
        alphaKeyGroup.style.display = alphaModeSelect.value === 'fourth_metric' ? 'flex' : 'none';
      }
      
      // Hide the revert button
      revertBtn.style.display = 'none';
      
      // Hide custom similar results when reverting
      if (customSimilarResults) {
        customSimilarResults.style.display = 'none';
      }
    });
  }
  
  // ---
  // --- Vector Magic: Interactive Vector Arithmetic (Auto-using Neighbors)
  // ---
  const neighborsData = {{ neighbors_data | default([]) | tojson }};
  const currentWorkoutRPE = {{ current_workout_rpe | default('null') }};
  const currentWorkoutSessionTag = {{ current_workout_session_tag | default('null') | tojson }};
  
  // Intelligently categorize neighbors
  function categorizeNeighbors(neighbors, currentRPE, currentTag) {
    const hardWorkouts = [];
    const easyWorkouts = [];
    const hardTags = ['Tempo Pace', 'Threshold', 'Race Day', 'High Intensity Interval'];
    const easyTags = ['Recovery', 'Z2 Cardio', 'Easy Recovery Run'];
    
    neighbors.forEach(neighbor => {
      const tag = neighbor.session_tag;
      const rpe = neighbor.rpe;
      
      // Check session tags first
      if (tag && hardTags.some(ht => tag.includes(ht))) {
        hardWorkouts.push(neighbor);
      } else if (tag && easyTags.some(et => tag.includes(et))) {
        easyWorkouts.push(neighbor);
      } else if (rpe && currentRPE) {
        // Use RPE comparison
        if (rpe > currentRPE + 1) {
          hardWorkouts.push(neighbor);
        } else if (rpe < currentRPE - 1) {
          easyWorkouts.push(neighbor);
        }
      } else {
        // Default: use first neighbor as hard, last as easy
        if (neighbors.indexOf(neighbor) === 0) {
          hardWorkouts.push(neighbor);
        } else if (neighbors.indexOf(neighbor) === neighbors.length - 1) {
          easyWorkouts.push(neighbor);
        }
      }
    });
    
    return { hardWorkouts, easyWorkouts };
  }
  
  // Auto-populate suggestions (will search database if neighbors don't have suitable workouts)
  async function updateSuggestions() {
    const { hardWorkouts, easyWorkouts } = categorizeNeighbors(neighborsData, currentWorkoutRPE, currentWorkoutSessionTag);
    
    // If neighbors don't have suitable workouts, search database
    let finalHardWorkouts = hardWorkouts;
    let finalEasyWorkouts = easyWorkouts;
    
    if (hardWorkouts.length === 0) {
      try {
        const response = await fetch(`/experiments/data_imaging/workout/{{ workout_id }}/find-by-intensity?intensity=hard&limit=2`);
        if (response.ok) {
          const data = await response.json();
          if (data.workouts && data.workouts.length > 0) {
            finalHardWorkouts = data.workouts;
          }
        }
      } catch (error) {
        console.warn('Could not fetch hard workouts:', error);
      }
    }
    
    if (easyWorkouts.length === 0) {
      try {
        const response = await fetch(`/experiments/data_imaging/workout/{{ workout_id }}/find-by-intensity?intensity=easy&limit=2`);
        if (response.ok) {
          const data = await response.json();
          if (data.workouts && data.workouts.length > 0) {
            finalEasyWorkouts = data.workouts;
          }
        }
      } catch (error) {
        console.warn('Could not fetch easy workouts:', error);
      }
    }
    
    // Show smart suggestions
    const suggestionsDiv = document.getElementById('vectorMagicSmartSuggestions');
    const suggestionsContent = document.getElementById('smartSuggestionsContent');
    
    if (finalHardWorkouts.length > 0 || finalEasyWorkouts.length > 0) {
      suggestionsDiv.style.display = 'block';
      let suggestionsHTML = '<ul style="margin: 10px 0 0 20px; padding-left: 0; list-style: none;">';
      
      if (finalHardWorkouts.length > 0) {
        const source = hardWorkouts.length > 0 ? 'neighbors' : 'database';
        suggestionsHTML += `<li style="margin-bottom: 8px;">üî• <strong>Harder workouts found (${source}):</strong> `;
        suggestionsHTML += finalHardWorkouts.slice(0, 2).map(w => 
          `Workout #${w.workout_id} (${w.session_tag || w.workout_type || '?'})`
        ).join(', ');
        suggestionsHTML += '</li>';
      }
      
      if (finalEasyWorkouts.length > 0) {
        const source = easyWorkouts.length > 0 ? 'neighbors' : 'database';
        suggestionsHTML += `<li style="margin-bottom: 8px;">üòå <strong>Easier workouts found (${source}):</strong> `;
        suggestionsHTML += finalEasyWorkouts.slice(0, 2).map(w => 
          `Workout #${w.workout_id} (${w.session_tag || w.workout_type || '?'})`
        ).join(', ');
        suggestionsHTML += '</li>';
      }
      
      suggestionsHTML += '</ul>';
      suggestionsContent.innerHTML = suggestionsHTML;
    }
    
    // Update suggestion displays
    const harderSuggestions = document.getElementById('harderSuggestions');
    const easierSuggestions = document.getElementById('easierSuggestions');
    
    if (finalHardWorkouts.length > 0) {
      const source = hardWorkouts.length > 0 ? '‚ú®' : 'üîç';
      harderSuggestions.innerHTML = `<p style="margin: 0; color: var(--atlas-green); font-weight: 600;">${source} Will use: Workout #${finalHardWorkouts[0].workout_id} (${finalHardWorkouts[0].session_tag || finalHardWorkouts[0].workout_type || 'hard workout'})</p>`;
    } else {
      harderSuggestions.innerHTML = '<p style="margin: 0; color: var(--atlas-mid-text); font-style: italic;">üí° Will search database for harder workouts</p>';
    }
    
    if (finalEasyWorkouts.length > 0) {
      const source = easyWorkouts.length > 0 ? '‚ú®' : 'üîç';
      easierSuggestions.innerHTML = `<p style="margin: 0; color: var(--atlas-green); font-weight: 600;">${source} Will use: Workout #${finalEasyWorkouts[0].workout_id} (${finalEasyWorkouts[0].session_tag || finalEasyWorkouts[0].workout_type || 'easy workout'})</p>`;
    } else {
      easierSuggestions.innerHTML = '<p style="margin: 0; color: var(--atlas-mid-text); font-style: italic;">üí° Will search database for easier workouts</p>';
    }
  }
  
  // Initialize suggestions on page load
  if (neighborsData && neighborsData.length >= 0) {
    updateSuggestions();
  }
  
  const findHarderAutoBtn = document.getElementById('findHarderAutoBtn');
  const findEasierAutoBtn = document.getElementById('findEasierAutoBtn');
  const findHarderManualBtn = document.getElementById('findHarderManualBtn');
  const findEasierManualBtn = document.getElementById('findEasierManualBtn');
  const scaleIntensityBtn = document.getElementById('scaleIntensityBtn');
  const scaleBtns = document.querySelectorAll('.scaleBtn');
  const vectorMagicResults = document.getElementById('vectorMagicResults');
  const vectorMagicResultsList = document.getElementById('vectorMagicResultsList');
  const vectorMagicOperationText = document.getElementById('vectorMagicOperationText');
  const explainVectorMagicBtn = document.getElementById('explainVectorMagicBtn');
  
  // Helper function to perform vector magic search
  async function performVectorMagic(operation, operandWorkoutId, scaleFactor) {
    const currentWorkoutId = {{ workout_id }};
    const rVal = rSelect.value;
    const gVal = gSelect.value;
    const bVal = bSelect.value;
    const alphaModeVal = alphaModeSelect ? alphaModeSelect.value : 'none';
    const alphaKeyVal = alphaKeySelect ? alphaKeySelect.value : 'cadence';
    
    // Build query parameters
    const params = new URLSearchParams({
      operation: operation,
      r_key: rVal,
      g_key: gVal,
      b_key: bVal,
      alpha_mode: alphaModeVal,
      alpha_key: alphaKeyVal,
      limit: '5'
    });
    
    if (operandWorkoutId !== null && operandWorkoutId !== undefined) {
      params.append('operand_workout_id', operandWorkoutId);
    }
    if (scaleFactor !== null && scaleFactor !== undefined) {
      params.append('scale_factor', scaleFactor);
    }
    
    const url = `/experiments/data_imaging/workout/${currentWorkoutId}/vector-magic?${params.toString()}`;
    
    try {
      const response = await fetch(url);
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({detail: response.statusText}));
        throw new Error(errorData.detail || `HTTP ${response.status}`);
      }
      return await response.json();
    } catch (error) {
      console.error('Vector magic search error:', error);
      throw error;
    }
  }
  
  // Helper function to display results
  function displayVectorMagicResults(data) {
    vectorMagicOperationText.textContent = data.operation || 'Unknown operation';
    vectorMagicResults.style.display = 'block';
    
    if (!data.results || data.results.length === 0) {
      vectorMagicResultsList.innerHTML = '<li style="color: var(--atlas-mid-text); padding: 15px; background-color: var(--atlas-dark-blue); border-radius: 6px; border: 1px solid var(--atlas-border);">No workouts found matching the vector magic query.</li>';
      return;
    }
    
    const rVal = rSelect.value;
    const gVal = gSelect.value;
    const bVal = bSelect.value;
    const alphaModeVal = alphaModeSelect ? alphaModeSelect.value : 'none';
    const alphaKeyVal = alphaKeySelect ? alphaKeySelect.value : 'cadence';
    
    const items = data.results.map(item => {
      const sid = item.workout_id;
      let contextSpan = `Type: ${item.workout_type || '?'}`;
      if (item.session_tag) contextSpan += ` | Tag: ${item.session_tag}`;
      if (item.ai_classification && item.ai_classification !== 'Pending Analysis') {
        contextSpan += ` | Pattern: ${item.ai_classification}`;
      }
      
      const queryParams = new URLSearchParams({
        r_key: rVal,
        g_key: gVal,
        b_key: bVal,
        alpha_mode: alphaModeVal,
        alpha_key: alphaKeyVal
      });
      
      return `<li style="background: var(--atlas-dark-blue); padding: 10px 15px; border-radius: 6px; border: 1px solid var(--atlas-border); transition: background-color 0.2s ease; line-height: 1.5; margin-bottom: 10px;">
        <a href="/experiments/data_imaging/workout/${sid}?${queryParams.toString()}" style="font-weight: 600; color: var(--atlas-green); text-decoration: none;">Workout #${sid}</a> 
        <span style="color: var(--atlas-mid-text); font-size: 0.9em; margin-left: 8px; display: inline-block;">(${contextSpan})</span><br>
        <span style="color: var(--atlas-mid-text); font-size: 0.9em;">Similarity Score: <strong style="color: var(--accent-orange);">${item.score.toFixed(4)}</strong></span>
      </li>`;
    });
    
    vectorMagicResultsList.innerHTML = items.join('');
    
    // Scroll to results
    vectorMagicResults.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
  
  // Helper function to find workouts by intensity (searches database if neighbors don't have them)
  async function findWorkoutByIntensity(intensity, neighbors, currentRPE, currentTag) {
    // First, try neighbors
    const { hardWorkouts, easyWorkouts } = categorizeNeighbors(neighbors, currentRPE, currentTag);
    
    if (intensity === 'hard' && hardWorkouts.length > 0) {
      return hardWorkouts[0];
    } else if (intensity === 'easy' && easyWorkouts.length > 0) {
      return easyWorkouts[0];
    }
    
    // If neighbors don't have suitable workouts, search the database
    try {
      const response = await fetch(`/experiments/data_imaging/workout/{{ workout_id }}/find-by-intensity?intensity=${intensity}&limit=1`);
      if (response.ok) {
        const data = await response.json();
        if (data.workouts && data.workouts.length > 0) {
          return data.workouts[0];
        }
      }
    } catch (error) {
      console.warn(`Could not find ${intensity} workouts in database:`, error);
    }
    
    return null;
  }
  
  // Find Harder (Auto) button
  if (findHarderAutoBtn) {
    findHarderAutoBtn.addEventListener('click', async function() {
      findHarderAutoBtn.disabled = true;
      findHarderAutoBtn.textContent = 'üîç Searching for harder workouts...';
      
      try {
        const hardWorkout = await findWorkoutByIntensity('hard', neighborsData, currentWorkoutRPE, currentWorkoutSessionTag);
        
        if (!hardWorkout) {
          alert('No harder workouts found. Try generating more workouts or use manual override.');
          findHarderAutoBtn.disabled = false;
          findHarderAutoBtn.textContent = 'üöÄ Find Harder Versions (Auto)';
          return;
        }
        
        findHarderAutoBtn.textContent = 'Finding Harder Versions...';
        
        const data = await performVectorMagic('add', hardWorkout.workout_id, null);
        const source = hardWorkout.session_tag || hardWorkout.workout_type || `Workout #${hardWorkout.workout_id}`;
        displayVectorMagicResults({
          operation: `Vector({{ workout_id }}) + Vector(${hardWorkout.workout_id}) = Harder Versions (using ${source})`,
          results: data.results
        });
      } catch (error) {
        alert(`Error finding harder versions: ${error.message}`);
        console.error('Error:', error);
      } finally {
        findHarderAutoBtn.disabled = false;
        findHarderAutoBtn.textContent = 'üöÄ Find Harder Versions (Auto)';
      }
    });
  }
  
  // Find Easier (Auto) button
  if (findEasierAutoBtn) {
    findEasierAutoBtn.addEventListener('click', async function() {
      findEasierAutoBtn.disabled = true;
      findEasierAutoBtn.textContent = 'üîç Searching for easier workouts...';
      
      try {
        const easyWorkout = await findWorkoutByIntensity('easy', neighborsData, currentWorkoutRPE, currentWorkoutSessionTag);
        
        if (!easyWorkout) {
          alert('No easier workouts found. Try generating more workouts or use manual override.');
          findEasierAutoBtn.disabled = false;
          findEasierAutoBtn.textContent = 'üöÄ Find Easier Versions (Auto)';
          return;
        }
        
        findEasierAutoBtn.textContent = 'Finding Easier Versions...';
        
        const data = await performVectorMagic('add', easyWorkout.workout_id, null);
        const source = easyWorkout.session_tag || easyWorkout.workout_type || `Workout #${easyWorkout.workout_id}`;
        displayVectorMagicResults({
          operation: `Vector({{ workout_id }}) + Vector(${easyWorkout.workout_id}) = Easier Versions (using ${source})`,
          results: data.results
        });
      } catch (error) {
        alert(`Error finding easier versions: ${error.message}`);
        console.error('Error:', error);
      } finally {
        findEasierAutoBtn.disabled = false;
        findEasierAutoBtn.textContent = 'üöÄ Find Easier Versions (Auto)';
      }
    });
  }
  
  // Manual override buttons
  if (findHarderManualBtn) {
    findHarderManualBtn.addEventListener('click', async function() {
      const workoutId = parseInt(document.getElementById('harderWorkoutId').value);
      if (!workoutId) {
        alert('Please enter a workout ID');
        return;
      }
      
      findHarderManualBtn.disabled = true;
      findHarderManualBtn.textContent = 'Finding...';
      
      try {
        const data = await performVectorMagic('add', workoutId, null);
        displayVectorMagicResults(data);
      } catch (error) {
        alert(`Error: ${error.message}`);
        console.error('Error:', error);
      } finally {
        findHarderManualBtn.disabled = false;
        findHarderManualBtn.textContent = 'Use Manual ID';
      }
    });
  }
  
  if (findEasierManualBtn) {
    findEasierManualBtn.addEventListener('click', async function() {
      const workoutId = parseInt(document.getElementById('easierWorkoutId').value);
      if (!workoutId) {
        alert('Please enter a workout ID');
        return;
      }
      
      findEasierManualBtn.disabled = true;
      findEasierManualBtn.textContent = 'Finding...';
      
      try {
        const data = await performVectorMagic('add', workoutId, null);
        displayVectorMagicResults(data);
      } catch (error) {
        alert(`Error: ${error.message}`);
        console.error('Error:', error);
      } finally {
        findEasierManualBtn.disabled = false;
        findEasierManualBtn.textContent = 'Use Manual ID';
      }
    });
  }
  
  // Scale buttons
  scaleBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const scale = parseFloat(this.dataset.scale);
      document.getElementById('scaleFactor').value = scale;
      scaleIntensityBtn.click();
    });
  });
  
  // Scale Intensity button
  if (scaleIntensityBtn) {
    scaleIntensityBtn.addEventListener('click', async function() {
      const scaleFactor = parseFloat(document.getElementById('scaleFactor').value);
      
      if (!scaleFactor || scaleFactor <= 0) {
        alert('Please enter a valid scale factor (e.g., 0.5 for 50% less intense, 1.5 for 50% more intense)');
        return;
      }
      
      scaleIntensityBtn.disabled = true;
      scaleIntensityBtn.textContent = 'Finding Scaled Versions...';
      
      try {
        const data = await performVectorMagic('scale', null, scaleFactor);
        displayVectorMagicResults(data);
      } catch (error) {
        alert(`Error finding scaled versions: ${error.message}`);
        console.error('Error:', error);
      } finally {
        scaleIntensityBtn.disabled = false;
        scaleIntensityBtn.textContent = 'Find Scaled Versions';
      }
    });
  }
  
  // Explain Vector Magic button (scrolls to top of section)
  if (explainVectorMagicBtn) {
    explainVectorMagicBtn.addEventListener('click', function() {
      const vectorMagicSection = document.querySelector('.guide-box[style*="border-top: 4px solid var(--accent-orange)"]');
      if (vectorMagicSection) {
        vectorMagicSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
  }
  
  // Note: We now auto-detect workouts from neighbors, so no need to store effort IDs
});  
</script>

  <!-- VoyageAI A/B Testing Modal -->
  <div id="ab-test-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 10000; align-items: center; justify-content: center; padding: 20px;">
    <div style="background-color: var(--atlas-dark-blue); border: 2px solid var(--atlas-border); border-radius: 12px; padding: 30px; max-width: 1400px; width: 95%; max-height: 95vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h2 style="margin: 0; color: var(--atlas-light-text); display: flex; align-items: center; gap: 10px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="var(--accent-orange)" viewBox="0 0 16 16">
            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
          </svg>
          A/B Testing: VoyageAI Reranking Comparison
        </h2>
        <button id="close-ab-modal" style="background: transparent; border: none; color: var(--atlas-mid-text); font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='var(--atlas-hover-bg)'" onmouseout="this.style.backgroundColor='transparent'">
          √ó
        </button>
      </div>
      
      <!-- Loading State -->
      <div id="ab-test-loading" style="text-align: center; padding: 40px;">
        <div style="color: var(--atlas-light-text); font-size: 1.1em; margin-bottom: 15px;">Loading comparison...</div>
        <div style="color: var(--atlas-mid-text); font-size: 0.9em;">Fetching results with and without VoyageAI reranking</div>
      </div>
      
      <!-- Error State -->
      <div id="ab-test-error" style="display: none; background-color: var(--atlas-bg); padding: 20px; border-radius: 8px; border-left: 4px solid var(--accent-red);">
        <p style="color: var(--atlas-light-text); margin: 0 0 10px 0; font-weight: 600;">Error loading comparison</p>
        <p id="ab-test-error-message" style="color: var(--atlas-mid-text); margin: 0; font-size: 0.9em;"></p>
      </div>
      
      <!-- Comparison Results -->
      <div id="ab-test-results" style="display: none;">
        <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #667eea; margin-bottom: 25px;">
          <p style="margin: 0 0 10px 0; color: var(--atlas-light-text); font-weight: 600; font-size: 0.95em;">
            üìä Side-by-Side Comparison
          </p>
          <p style="margin: 0; color: var(--atlas-mid-text); font-size: 0.9em; line-height: 1.6;">
            Compare the top 3 workout recommendations. <strong style="color: var(--atlas-light-text);">Green highlights</strong> show workouts that appear in both results. 
            <strong style="color: #667eea;">Purple highlights</strong> show workouts unique to VoyageAI reranking. 
            <strong style="color: var(--accent-orange);">Orange highlights</strong> show workouts only in vector-only search.
          </p>
        </div>
        
        <!-- Side-by-Side Comparison -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
          <!-- With VoyageAI -->
          <div style="background-color: var(--atlas-bg); border: 2px solid #667eea; border-radius: 8px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
              <span style="display: inline-block; width: 16px; height: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%;"></span>
              <h3 style="margin: 0; color: var(--atlas-light-text); font-size: 1.2em; font-weight: 600;">With VoyageAI Reranking</h3>
            </div>
            <p style="color: var(--atlas-mid-text); font-size: 0.85em; margin: 0 0 15px 0; line-height: 1.5;">
              MongoDB finds 25 candidates ‚Üí VoyageAI reranks to find the top 3 most semantically similar
            </p>
            <div id="ab-test-with-voyage" style="min-height: 200px;">
              <!-- Results will be inserted here -->
            </div>
          </div>
          
          <!-- Without VoyageAI -->
          <div style="background-color: var(--atlas-bg); border: 2px solid var(--accent-orange); border-radius: 8px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
              <span style="display: inline-block; width: 16px; height: 16px; background: var(--accent-orange); border-radius: 50%;"></span>
              <h3 style="margin: 0; color: var(--atlas-light-text); font-size: 1.2em; font-weight: 600;">Without VoyageAI</h3>
            </div>
            <p style="color: var(--atlas-mid-text); font-size: 0.85em; margin: 0 0 15px 0; line-height: 1.5;">
              MongoDB finds the top 3 candidates directly (faster, but less accurate)
            </p>
            <div id="ab-test-without-voyage" style="min-height: 200px;">
              <!-- Results will be inserted here -->
            </div>
          </div>
        </div>
        
        <!-- Summary Stats -->
        <div id="ab-test-summary" style="background-color: var(--atlas-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--atlas-border); margin-bottom: 20px;">
          <!-- Summary will be inserted here -->
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--atlas-border);">
        <button id="close-ab-modal-btn" class="control-btn btn-revert" style="padding: 10px 20px;">Close</button>
      </div>
    </div>
  </div>

  <script>
    // VoyageAI A/B Testing Modal
    const abTestBtn = document.getElementById('ab-test-btn');
    const abTestModal = document.getElementById('ab-test-modal');
    const closeAbModal = document.getElementById('close-ab-modal');
    const closeAbModalBtn = document.getElementById('close-ab-modal-btn');
    const voyageBadge = document.getElementById('voyage-badge');
    const voyageExplanation = document.getElementById('voyage-explanation');
    
    // Modal state elements
    const abTestLoading = document.getElementById('ab-test-loading');
    const abTestError = document.getElementById('ab-test-error');
    const abTestErrorMessage = document.getElementById('ab-test-error-message');
    const abTestResults = document.getElementById('ab-test-results');
    const abTestWithVoyage = document.getElementById('ab-test-with-voyage');
    const abTestWithoutVoyage = document.getElementById('ab-test-without-voyage');
    const abTestSummary = document.getElementById('ab-test-summary');

    // Check URL parameter for use_voyage
    const urlParams = new URLSearchParams(window.location.search);
    const useVoyage = urlParams.get('use_voyage');
    const voyageEnabled = useVoyage !== 'false'; // Default to true if not specified

    // Update UI based on current setting
    function updateVoyageUI(enabled) {
      if (enabled) {
        voyageBadge.style.display = 'inline-flex';
        voyageExplanation.style.display = 'block';
      } else {
        voyageBadge.style.display = 'none';
        voyageExplanation.style.display = 'none';
      }
    }

    // Initialize UI
    updateVoyageUI(voyageEnabled);

    // Format workout for display
    function formatWorkoutForABTest(workout, highlightClass = '') {
      const contextSpan = `Type: ${workout.workout_type || '?'}${workout.session_tag ? ` | Tag: ${workout.session_tag}` : ''}${workout.ai_classification && workout.ai_classification !== 'Pending Analysis' ? ` | Pattern: ${workout.ai_classification}` : ''}`;
      const scoreColor = workout.method === 'voyage_reranked' ? '#667eea' : 'var(--accent-orange)';
      
      return `
        <div class="ab-test-workout-item ${highlightClass}" style="background-color: var(--atlas-dark-blue); padding: 12px; border-radius: 6px; border: 1px solid var(--atlas-border); margin-bottom: 12px; transition: all 0.2s;">
          <a href="/experiments/data_imaging/workout/${workout.workout_id}${window.location.search}" style="font-weight: 600; color: var(--atlas-green); text-decoration: none; font-size: 1.05em;">Workout #${workout.workout_id}</a>
          <div style="color: var(--atlas-mid-text); font-size: 0.9em; margin: 6px 0;">${contextSpan}</div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
            <span style="color: var(--atlas-mid-text); font-size: 0.85em;">Similarity Score:</span>
            <strong style="color: ${scoreColor}; font-size: 1em;">${workout.score.toFixed(4)}</strong>
          </div>
        </div>
      `;
    }

    // Calculate differences between results
    function calculateDifferences(withVoyage, withoutVoyage) {
      const withIds = new Set(withVoyage.map(w => w.workout_id));
      const withoutIds = new Set(withoutVoyage.map(w => w.workout_id));
      
      const common = withVoyage.filter(w => withoutIds.has(w.workout_id));
      const onlyVoyage = withVoyage.filter(w => !withoutIds.has(w.workout_id));
      const onlyVector = withoutVoyage.filter(w => !withIds.has(w.workout_id));
      
      return { common, onlyVoyage, onlyVector };
    }

    // Display A/B test results
    function displayABTestResults(data) {
      if (data.error) {
        abTestError.style.display = 'block';
        abTestErrorMessage.textContent = data.error;
        abTestLoading.style.display = 'none';
        return;
      }
      
      const { with_voyage, without_voyage, source_workout } = data;
      const differences = calculateDifferences(with_voyage, without_voyage);
      
      // Display with VoyageAI results
      let withVoyageHTML = '';
      with_voyage.forEach((workout, index) => {
        let highlightClass = '';
        if (differences.common.find(c => c.workout_id === workout.workout_id)) {
          highlightClass = 'ab-common'; // Common to both
        } else if (differences.onlyVoyage.find(v => v.workout_id === workout.workout_id)) {
          highlightClass = 'ab-voyage-only'; // Only in VoyageAI
        }
        withVoyageHTML += formatWorkoutForABTest(workout, highlightClass);
      });
      if (with_voyage.length === 0) {
        withVoyageHTML = '<p style="color: var(--atlas-mid-text); font-style: italic;">No results found</p>';
      }
      abTestWithVoyage.innerHTML = withVoyageHTML;
      
      // Display without VoyageAI results
      let withoutVoyageHTML = '';
      without_voyage.forEach((workout, index) => {
        let highlightClass = '';
        if (differences.common.find(c => c.workout_id === workout.workout_id)) {
          highlightClass = 'ab-common'; // Common to both
        } else if (differences.onlyVector.find(v => v.workout_id === workout.workout_id)) {
          highlightClass = 'ab-vector-only'; // Only in vector-only
        }
        withoutVoyageHTML += formatWorkoutForABTest(workout, highlightClass);
      });
      if (without_voyage.length === 0) {
        withoutVoyageHTML = '<p style="color: var(--atlas-mid-text); font-style: italic;">No results found</p>';
      }
      abTestWithoutVoyage.innerHTML = withoutVoyageHTML;
      
      // Display summary
      const commonCount = differences.common.length;
      const voyageOnlyCount = differences.onlyVoyage.length;
      const vectorOnlyCount = differences.onlyVector.length;
      const totalUnique = new Set([...with_voyage.map(w => w.workout_id), ...without_voyage.map(w => w.workout_id)]).size;
      
      abTestSummary.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div style="text-align: center; padding: 10px; background-color: var(--atlas-dark-blue); border-radius: 6px;">
            <div style="color: var(--atlas-green); font-size: 1.5em; font-weight: 600; margin-bottom: 5px;">${commonCount}</div>
            <div style="color: var(--atlas-mid-text); font-size: 0.85em;">Common Results</div>
          </div>
          <div style="text-align: center; padding: 10px; background-color: var(--atlas-dark-blue); border-radius: 6px;">
            <div style="color: #667eea; font-size: 1.5em; font-weight: 600; margin-bottom: 5px;">${voyageOnlyCount}</div>
            <div style="color: var(--atlas-mid-text); font-size: 0.85em;">VoyageAI Only</div>
          </div>
          <div style="text-align: center; padding: 10px; background-color: var(--atlas-dark-blue); border-radius: 6px;">
            <div style="color: var(--accent-orange); font-size: 1.5em; font-weight: 600; margin-bottom: 5px;">${vectorOnlyCount}</div>
            <div style="color: var(--atlas-mid-text); font-size: 0.85em;">Vector-Only</div>
          </div>
          <div style="text-align: center; padding: 10px; background-color: var(--atlas-dark-blue); border-radius: 6px;">
            <div style="color: var(--atlas-light-text); font-size: 1.5em; font-weight: 600; margin-bottom: 5px;">${totalUnique}</div>
            <div style="color: var(--atlas-mid-text); font-size: 0.85em;">Total Unique</div>
          </div>
        </div>
      `;
      
      // Add CSS for highlights
      const style = document.createElement('style');
      style.textContent = `
        .ab-test-workout-item.ab-common {
          border-left: 4px solid var(--atlas-green) !important;
          background-color: rgba(0, 237, 100, 0.1) !important;
        }
        .ab-test-workout-item.ab-voyage-only {
          border-left: 4px solid #667eea !important;
          background-color: rgba(102, 126, 234, 0.15) !important;
        }
        .ab-test-workout-item.ab-vector-only {
          border-left: 4px solid var(--accent-orange) !important;
          background-color: rgba(255, 165, 84, 0.15) !important;
        }
        .ab-test-workout-item:hover {
          transform: translateX(4px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
      `;
      if (!document.getElementById('ab-test-styles')) {
        style.id = 'ab-test-styles';
        document.head.appendChild(style);
      }
      
      // Show results, hide loading
      abTestLoading.style.display = 'none';
      abTestResults.style.display = 'block';
    }

    // Fetch A/B test results
    async function fetchABTestResults() {
      const workoutId = {{ workout_id }};
      
      abTestLoading.style.display = 'block';
      abTestError.style.display = 'none';
      abTestResults.style.display = 'none';
      
      try {
        const response = await fetch(`/experiments/data_imaging/workout/${workoutId}/ab-test-neighbors`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        displayABTestResults(data);
      } catch (error) {
        console.error('Error fetching A/B test results:', error);
        abTestError.style.display = 'block';
        abTestErrorMessage.textContent = error.message || 'Failed to load comparison results';
        abTestLoading.style.display = 'none';
      }
    }

    // Open modal and fetch results
    if (abTestBtn) {
      abTestBtn.addEventListener('click', function() {
        abTestModal.style.display = 'flex';
        fetchABTestResults();
      });
    }

    // Close modal
    function closeModal() {
      abTestModal.style.display = 'none';
    }

    if (closeAbModal) {
      closeAbModal.addEventListener('click', closeModal);
    }

    if (closeAbModalBtn) {
      closeAbModalBtn.addEventListener('click', closeModal);
    }

    // Close modal on outside click
    abTestModal.addEventListener('click', function(e) {
      if (e.target === abTestModal) {
        closeModal();
      }
    });
  </script>
  
</body>  
</html>