<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indexing Demo - g.nome</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0d1117;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            transition: overflow 0.3s ease;
            position: relative;
        }

        /* --- REMOVED --- */
        /* body::before { ... } */
        /* @keyframes float { ... } */


        /* --- MONGODB LOGO EFFECT STYLES --- */
        #mongo-logo-container {
            position: fixed;
            bottom: -80px;
            right: -80px;
            width: 400px;
            height: 400px;
            z-index: 0;
            pointer-events: none;
            will-change: transform, opacity;
        }

        .mongo-logo-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            opacity: 0.12;
            transform: rotate(-15deg);
            filter: drop-shadow(0 0 40px rgba(0, 237, 100, 0.3)) 
                    drop-shadow(0 0 80px rgba(0, 237, 100, 0.2))
                    drop-shadow(0 0 120px rgba(0, 237, 100, 0.1));
            animation: logoGlow 4s ease-in-out infinite;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform, opacity, filter;
        }

        #mongo-logo-container::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120%;
            height: 120%;
            transform: translate(-50%, -50%);
            background: radial-gradient(
                circle,
                rgba(0, 237, 100, 0.15) 0%,
                transparent 70%
            );
            border-radius: 50%;
            filter: blur(30px);
            animation: pulseGlow 6s ease-in-out infinite;
            z-index: -1;
        }

        #mongo-logo-container::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 140%;
            height: 140%;
            transform: translate(-50%, -50%);
            background: radial-gradient(
                circle,
                rgba(33, 150, 243, 0.08) 0%,
                transparent 60%
            );
            border-radius: 50%;
            filter: blur(40px);
            animation: pulseGlow 8s ease-in-out infinite reverse;
            z-index: -2;
        }

        @keyframes logoGlow {
            0%, 100% {
                filter: drop-shadow(0 0 40px rgba(0, 237, 100, 0.3)) 
                        drop-shadow(0 0 80px rgba(0, 237, 100, 0.2))
                        drop-shadow(0 0 120px rgba(0, 237, 100, 0.1));
                opacity: 0.12;
            }
            50% {
                filter: drop-shadow(0 0 60px rgba(0, 237, 100, 0.4)) 
                        drop-shadow(0 0 120px rgba(0, 237, 100, 0.3))
                        drop-shadow(0 0 180px rgba(0, 237, 100, 0.15));
                opacity: 0.18;
            }
        }

        @keyframes pulseGlow {
            0%, 100% {
                opacity: 0.6;
                transform: translate(-50%, -50%) scale(1);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }
        }

        /* Responsive positioning */
        @media (max-width: 768px) {
            #mongo-logo-container {
                width: 250px;
                height: 250px;
                bottom: -50px;
                right: -50px;
            }
        }
        /* --- END OF MONGODB LOGO EFFECT STYLES --- */


        /* This ensures the page content stays on top of the background logo */
        body > * {
            position: relative;
            z-index: 1;
        }

        body.modal-open {
            overflow: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        /* Header */
        .header {
            background: rgba(26, 29, 36, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 237, 100, 0.2);
            border-radius: 12px;
            padding: 30px 40px;
            margin-bottom: 24px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }
        
        .header h1 {
            font-size: 2rem;
            color: #00ED64;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .header .subtitle {
            color: #b8bcc4;
            font-size: 1rem;
        }
        
        /* Stats Bar */
        .stats-bar {
            background: rgba(26, 29, 36, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 237, 100, 0.15);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-item .label {
            font-size: 0.875rem;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .stat-item .value {
            font-size: 2rem;
            color: #00ED64;
            font-weight: 700;
        }
        
        /* Index Types Grid */
        .index-types-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .index-card {
            background: rgba(26, 29, 36, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 237, 100, 0.15);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
        }
        
        .index-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 237, 100, 0.2);
            border-color: rgba(0, 237, 100, 0.4);
        }
        
        .index-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .index-card-header h3 {
            font-size: 1.25rem;
            color: #ffffff;
            font-weight: 700;
        }
        
        .index-card-header .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-regular { background: rgba(0, 237, 100, 0.2); color: #00ED64; border: 1px solid rgba(0, 237, 100, 0.3); }
        .badge-text { background: rgba(255, 87, 87, 0.2); color: #ff5757; border: 1px solid rgba(255, 87, 87, 0.3); }
        .badge-geo { background: rgba(255, 193, 7, 0.2); color: #ffc107; border: 1px solid rgba(255, 193, 7, 0.3); }
        .badge-partial { background: rgba(156, 39, 176, 0.2); color: #9c27b0; border: 1px solid rgba(156, 39, 176, 0.3); }
        .badge-ttl { background: rgba(33, 150, 243, 0.2); color: #2196f3; border: 1px solid rgba(33, 150, 243, 0.3); }
        .badge-vector { background: rgba(0, 237, 100, 0.2); color: #00ED64; border: 1px solid rgba(0, 237, 100, 0.3); }
        
        .index-card p {
            color: #b8bcc4;
            font-size: 0.9375rem;
            margin-bottom: 16px;
            line-height: 1.6;
        }
        
        .index-card-button {
            width: 100%;
            padding: 10px;
            background: rgba(0, 237, 100, 0.1);
            border: 1px solid rgba(0, 237, 100, 0.3);
            border-radius: 6px;
            color: #00ED64;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .index-card-button:hover {
            background: rgba(0, 237, 100, 0.2);
            border-color: rgba(0, 237, 100, 0.5);
            color: #ffffff;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: rgba(26, 29, 36, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 237, 100, 0.3);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .modal-overlay.show .modal-content {
            opacity: 1;
            transform: scale(1);
        }
        
        .modal-header {
            background: linear-gradient(135deg, rgba(0, 237, 100, 0.2) 0%, rgba(0, 237, 100, 0.1) 100%);
            border-bottom: 1px solid rgba(0, 237, 100, 0.3);
            color: #00ED64;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        
        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
        }
        
        .modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: rgba(0, 237, 100, 0.2);
            border-color: rgba(0, 237, 100, 0.4);
            color: #00ED64;
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 24px;
            overflow-y: auto;
            background: rgba(13, 17, 23, 0.5);
        }

        /* Loading Spinner for Modal */
        .modal-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            color: #b8bcc4;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 237, 100, 0.2);
            border-top: 4px solid #00ED64;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Result Content Styles (Re-used from original) */
        .result-description {
            background: rgba(0, 237, 100, 0.1);
            border-left: 4px solid #00ED64;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            color: #b8bcc4;
        }
        
        .result-value {
            background: rgba(0, 237, 100, 0.15);
            border: 1px solid rgba(0, 237, 100, 0.3);
            border-left: 4px solid #00ED64;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .result-value h4 {
            color: #00ED64;
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .result-value p {
            color: #b8bcc4;
            font-size: 0.9375rem;
        }
        
        .test-result {
            background: rgba(26, 29, 36, 0.8);
            border: 1px solid rgba(0, 237, 100, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .test-result h4 {
            color: #ffffff;
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 12px;
        }
        
        .test-result .index-name {
            display: inline-block;
            background: rgba(0, 237, 100, 0.15);
            border: 1px solid rgba(0, 237, 100, 0.3);
            padding: 6px 12px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.8125rem;
            color: #00ED64;
            margin-bottom: 12px;
        }
        
        .test-result .query {
            background: #1a1d24;
            border: 1px solid rgba(0, 237, 100, 0.2);
            color: #00ED64;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            margin: 12px 0;
            overflow-x: auto;
        }
        
        .test-result .explanation {
            background: rgba(0, 237, 100, 0.1);
            border-left: 3px solid #00ED64;
            padding: 12px;
            border-radius: 4px;
            margin: 12px 0;
            color: #b8bcc4;
            font-size: 0.9375rem;
        }
        
        .test-result .result-data {
            background: rgba(26, 29, 36, 0.8);
            border: 1px solid rgba(0, 237, 100, 0.2);
            padding: 16px;
            border-radius: 6px;
            margin-top: 12px;
        }
        
        .test-result .result-data pre {
            background: #1a1d24;
            border: 1px solid rgba(0, 237, 100, 0.2);
            color: #00ED64;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 0.875rem;
            margin-top: 12px;
        }
        
        /* Messages */
        .message {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .message.error {
            background: rgba(255, 87, 87, 0.15);
            color: #ff5757;
            border: 1px solid rgba(255, 87, 87, 0.3);
        }
        
        .message.info {
            background: rgba(33, 150, 243, 0.15);
            color: #2196f3;
            border: 1px solid rgba(33, 150, 243, 0.3);
        }
        
        /* Auto-seed notice */
        .auto-seed-notice {
            background: rgba(0, 237, 100, 0.15);
            border: 1px solid rgba(0, 237, 100, 0.3);
            border-left: 4px solid #00ED64;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #00ED64;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Performance Metrics */
        .performance-metrics {
            background: rgba(0, 237, 100, 0.1);
            border: 1px solid rgba(0, 237, 100, 0.2);
            border-left: 4px solid #00ED64;
            padding: 16px;
            border-radius: 6px;
            margin: 12px 0;
        }
        
        .performance-metrics h5 {
            color: #00ED64;
            font-size: 0.9375rem;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        
        .metric-item {
            background: rgba(26, 29, 36, 0.8);
            border: 1px solid rgba(0, 237, 100, 0.2);
            padding: 12px;
            border-radius: 6px;
        }
        
        .metric-item .label {
            font-size: 0.75rem;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            font-weight: 600;
        }
        
        .metric-item .value {
            font-size: 1.125rem;
            color: #ffffff;
            font-weight: 700;
        }
        
        .metric-item .value.highlight {
            color: #00ED64;
        }
        
        /* Explain Plan */
        .explain-plan {
            background: rgba(156, 39, 176, 0.1);
            border: 1px solid rgba(156, 39, 176, 0.2);
            border-left: 4px solid #9c27b0;
            padding: 16px;
            border-radius: 6px;
            margin: 12px 0;
        }
        
        .explain-plan h5 {
            color: #9c27b0;
            font-size: 0.9375rem;
            font-weight: 700;
            margin-bottom: 12px;
        }
        
        .explain-plan .explain-item {
            background: rgba(26, 29, 36, 0.8);
            border: 1px solid rgba(0, 237, 100, 0.1);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 0.875rem;
            color: #b8bcc4;
        }
        
        .explain-plan .explain-item strong {
            color: #ffffff;
            margin-right: 8px;
        }
        
        .index-used {
            background: rgba(0, 237, 100, 0.2);
            color: #00ED64;
            border: 1px solid rgba(0, 237, 100, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8125rem;
        }
        
        .collection-scan {
            background: rgba(255, 87, 87, 0.2);
            color: #ff5757;
            border: 1px solid rgba(255, 87, 87, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8125rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Indexing Demo</h1>
            <p class="subtitle">Explore MongoDB index types and their performance impact</p>
        </div>
        
        {% if auto_seeded %}
        <div class="auto-seed-notice">
            <strong>‚ú® Auto-seeded!</strong> Sample data has been automatically loaded.
        </div>
        {% endif %}
        
        <div class="stats-bar">
            <div class="stat-item">
                <div class="label">Products</div>
                <div class="value" id="products-count">-</div>
            </div>
            <div class="stat-item">
                <div class="label">Sessions</div>
                <div class="value" id="sessions-count">-</div>
            </div>
            <div class="stat-item">
                <div class="label">Embeddings</div>
                <div class="value" id="embeddings-count">-</div>
            </div>
            <div class="stat-item">
                <div class="label">Logs</div>
                <div class="value" id="logs-count">-</div>
            </div>
        </div>
        
        <div class="index-types-grid">
            <div class="index-card">
                <div class="index-card-header">
                    <h3>Regular Indexes</h3>
                    <span class="badge badge-regular">Regular</span>
                </div>
                <p>Unique indexes prevent duplicates. Compound indexes optimize multi-field queries. Essential for fast lookups.</p>
                <button class="index-card-button" onclick="testRegular()">Test Regular Index</button>
            </div>
            
            <div class="index-card">
                <div class="index-card-header">
                    <h3>Text Indexes</h3>
                    <span class="badge badge-text">Text</span>
                </div>
                <p>Full-text search with natural language processing. Word stemming and relevance scoring enable powerful search.</p>
                <button class="index-card-button" onclick="testText()">Test Text Index</button>
            </div>
            
            <div class="index-card">
                <div class="index-card-header">
                    <h3>Geospatial Indexes</h3>
                    <span class="badge badge-geo">Geospatial</span>
                </div>
                <p>2dsphere indexes for location-based queries. Perfect for "find near me" features with spherical calculations.</p>
                <button class="index-card-button" onclick="testGeospatial()">Test Geospatial Index</button>
            </div>
            
            <div class="index-card">
                <div class="index-card-header">
                    <h3>Partial Indexes</h3>
                    <span class="badge badge-partial">Partial</span>
                </div>
                <p>Index only matching documents. Reduces index size by 50-90% while maintaining full performance.</p>
                <button class="index-card-button" onclick="testPartial()">Test Partial Index</button>
            </div>
            
            <div class="index-card">
                <div class="index-card-header">
                    <h3>TTL Indexes</h3>
                    <span class="badge badge-ttl">TTL</span>
                </div>
                <p>Automatically delete documents after expiration. Perfect for session data, logs, and temporary data.</p>
                <button class="index-card-button" onclick="testTTL()">Test TTL Index</button>
            </div>
            
            <div class="index-card">
                <div class="index-card-header">
                    <h3>Vector Search</h3>
                    <span class="badge badge-vector">Vector</span>
                </div>
                <p>Semantic similarity search using embeddings. Powers AI features like recommendations and semantic search.</p>
                <button class="index-card-button" onclick="testVector()">Test Vector Search</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-content" id="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Test Results</h2>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                </div>
        </div>
    </div>
    
    <script>
        // Stats
        async function updateStats() {
            try {
                // A less disruptive way to update stats without full reload
                const response = await fetch('/experiments/indexing_demo/stats'); // Assuming a dedicated stats endpoint
                if (!response.ok) throw new Error('Stats request failed');
                
                const stats = await response.json();
                
                if (stats && !stats.error) {
                    document.getElementById('products-count').textContent = stats.collections?.products || stats.products || 0;
                    document.getElementById('sessions-count').textContent = stats.collections?.sessions || stats.sessions || 0;
                    document.getElementById('embeddings-count').textContent = stats.collections?.embeddings || stats.embeddings || 0;
                    document.getElementById('logs-count').textContent = stats.collections?.logs || stats.logs || 0;
                }
            } catch (error) {
                console.error('Error updating stats:', error);
                // Fallback to original reload logic if preferred
                // location.reload(); 
            }
        }
        
        window.addEventListener('DOMContentLoaded', () => {
            const stats = {{ stats | tojson | safe }};
            if (stats && !stats.error) {
                document.getElementById('products-count').textContent = stats.collections?.products || stats.products || 0;
                document.getElementById('sessions-count').textContent = stats.collections?.sessions || stats.sessions || 0;
                document.getElementById('embeddings-count').textContent = stats.collections?.embeddings || stats.embeddings || 0;
                document.getElementById('logs-count').textContent = stats.collections?.logs || stats.logs || 0;
            }
        });
        
        // Modal Controls
        const modalOverlay = document.getElementById('modal-overlay');
        const modalContent = document.getElementById('modal-content');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalClose = document.getElementById('modal-close');

        function openModal() {
            document.body.classList.add('modal-open');
            modalOverlay.classList.add('show');
        }

        function closeModal() {
            document.body.classList.remove('modal-open');
            modalOverlay.classList.remove('show');
        }

        if (modalOverlay && modalClose && modalContent) {
            modalClose.addEventListener('click', closeModal);
            
            modalOverlay.addEventListener('click', (event) => {
                if (event.target === modalOverlay) {
                    closeModal();
                }
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && modalOverlay.classList.contains('show')) {
                    closeModal();
                }
            });
        }

        function showModalLoading(title) {
            modalTitle.textContent = title || 'Processing...';
            modalBody.innerHTML = `
                <div class="modal-loading">
                    <div class="spinner"></div>
                    <p>Running test, please wait...</p>
                </div>
            `;
            openModal();
        }

        function displayModalError(error) {
            modalTitle.textContent = 'Error';
            modalBody.innerHTML = `<div class="message error">${escapeHtml(String(error.message || 'An unknown error occurred'))}</div>`;
            openModal();
        }

        // Display Test Results in Modal
        function displayModalResults(data) {
            // Handle errors
            if (data.error || !data.success) {
                displayModalError(new Error(data.error || 'Request failed'));
                return;
            }
            
            // Get result data
            const result = data.result || data;
            console.log('Result data:', result);
            console.log('Tests:', result.tests);
            
            if (!result) {
                displayModalError(new Error('No results returned'));
                return;
            }
            
            // Set title
            modalTitle.textContent = result.index_type || 'Test Results';
            
            // Build HTML
            let html = '';
            
            if (result.description) {
                html += `<div class="result-description">${escapeHtml(String(result.description))}</div>`;
            }
            
            if (result.value) {
                html += `
                    <div class="result-value">
                        <h4>üí° Value & Impact</h4>
                        <p>${escapeHtml(String(result.value))}</p>
                    </div>
                `;
            }
            
            if (result.tests && Array.isArray(result.tests) && result.tests.length > 0) {
                result.tests.forEach((test, idx) => {
                    if (!test) return;
                    console.log(`Test ${idx}:`, test);
                    console.log(`Test performance:`, test.performance);
                    
                    // Build performance metrics section
                    let performanceHtml = '';
                    if (test.performance) {
                        console.log('Building performance HTML for test:', test.name);
                        console.log('Performance object:', test.performance);
                        
                        let metricsHtml = '';
                        let hasMetrics = false;
                        
                        if (test.performance.execution_time_ms !== undefined && test.performance.execution_time_ms !== null) {
                            metricsHtml += `
                                <div class="metric-item">
                                    <div class="label">Execution Time</div>
                                    <div class="value highlight">${parseFloat(test.performance.execution_time_ms).toFixed(2)} ms</div>
                                </div>
                            `;
                            hasMetrics = true;
                        }
                        if (test.performance.count_query_time_ms !== undefined && test.performance.count_query_time_ms !== null) {
                            metricsHtml += `
                                <div class="metric-item">
                                    <div class="label">Count Query</div>
                                    <div class="value highlight">${parseFloat(test.performance.count_query_time_ms).toFixed(2)} ms</div>
                                </div>
                            `;
                            hasMetrics = true;
                        }
                        if (test.performance.find_query_time_ms !== undefined && test.performance.find_query_time_ms !== null) {
                            metricsHtml += `
                                <div class="metric-item">
                                    <div class="label">Find Query</div>
                                    <div class="value highlight">${parseFloat(test.performance.find_query_time_ms).toFixed(2)} ms</div>
                                </div>
                            `;
                            hasMetrics = true;
                        }
                        
                        // Build explain plan section
                        let explainHtml = '';
                        if (test.performance.explain) {
                            let explainItems = '';
                            if (test.performance.explain.index_used) {
                                const indexUsed = test.performance.explain.index_used;
                                const indexBadge = indexUsed !== 'Collection Scan' ? 
                                    `<span class="index-used">${escapeHtml(String(indexUsed))}</span>` :
                                    `<span class="collection-scan">Collection Scan (No Index)</span>`;
                                explainItems += `
                                    <div class="explain-item">
                                        <strong>Index Used:</strong> ${indexBadge}
                                    </div>
                                `;
                            }
                            if (test.performance.explain.total_docs_examined !== undefined && test.performance.explain.total_docs_examined !== null) {
                                explainItems += `
                                    <div class="explain-item">
                                        <strong>Documents Examined:</strong> ${test.performance.explain.total_docs_examined}
                                    </div>
                                `;
                            }
                            if (test.performance.explain.total_docs_returned !== undefined && test.performance.explain.total_docs_returned !== null) {
                                explainItems += `
                                    <div class="explain-item">
                                        <strong>Documents Returned:</strong> ${test.performance.explain.total_docs_returned}
                                    </div>
                                `;
                            }
                            if (test.performance.explain.efficiency !== undefined && test.performance.explain.efficiency !== null) {
                                explainItems += `
                                    <div class="explain-item">
                                        <strong>Query Efficiency:</strong> ${parseFloat(test.performance.explain.efficiency).toFixed(1)}%
                                    </div>
                                `;
                            }
                            if (test.performance.explain.execution_time_ms !== undefined && test.performance.explain.execution_time_ms !== null) {
                                explainItems += `
                                    <div class="explain-item">
                                        <strong>Execution Time (DB):</strong> ${test.performance.explain.execution_time_ms} ms
                                    </div>
                                `;
                            }
                            
                            if (explainItems) {
                                explainHtml = `
                                    <div class="explain-plan">
                                        <h5>üìä Query Explain Plan</h5>
                                        ${explainItems}
                                    </div>
                                `;
                            }
                        }
                        
                        // ALWAYS show performance section if performance object exists
                        // Build the performance section
                        let perfSectionContent = '';
                        if (metricsHtml) {
                            perfSectionContent += `<div class="metrics-grid">${metricsHtml}</div>`;
                        }
                        if (explainHtml) {
                            perfSectionContent += explainHtml;
                        }
                        
                        // ALWAYS show performance section if performance object exists
                        // If we have metrics or explain, show them. Otherwise show what we have
                        if (hasMetrics || explainHtml) {
                            performanceHtml = `
                                <div class="performance-metrics">
                                    <h5>‚ö° Performance Metrics</h5>
                                    ${perfSectionContent}
                                </div>
                            `;
                        } else {
                            // Still show section even if empty - for debugging
                            performanceHtml = `
                                <div class="performance-metrics">
                                    <h5>‚ö° Performance Metrics</h5>
                                    <div class="message info">
                                        <strong>Performance data:</strong> execution_time_ms=${test.performance.execution_time_ms !== undefined ? test.performance.execution_time_ms : 'N/A'}, 
                                        count_query_time_ms=${test.performance.count_query_time_ms !== undefined ? test.performance.count_query_time_ms : 'N/A'}, 
                                        find_query_time_ms=${test.performance.find_query_time_ms !== undefined ? test.performance.find_query_time_ms : 'N/A'}
                                    </div>
                                </div>
                            `;
                        }
                        
                        console.log('Generated performance HTML:', performanceHtml ? 'YES (' + performanceHtml.length + ' chars)' : 'NO');
                        console.log('hasMetrics:', hasMetrics);
                        console.log('explainHtml:', explainHtml ? 'YES' : 'NO');
                    } else {
                        console.log('No performance object for test:', test.name);
                    }
                    
                    html += `
                        <div class="test-result">
                            <h4>${escapeHtml(String(test.name || 'Test'))}</h4>
                            ${test.index ? `<div class="index-name">Index: ${escapeHtml(String(test.index))}</div>` : ''}
                            ${(test.query || test.expiration) ? `<div class="query">${escapeHtml(String(test.query || test.expiration))}</div>` : ''}
                            ${test.explanation ? `<div class="explanation">${escapeHtml(String(test.explanation))}</div>` : ''}
                            ${performanceHtml || ''}
                            ${test.result ? `
                                <div class="result-data">
                                    <strong>Results:</strong>
                                    <pre>${JSON.stringify(test.result, null, 2)}</pre>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            } else {
                html += `<div class="test-result"><pre>${JSON.stringify(result, null, 2)}</pre></div>`;
            }
            
            if (result.note) {
                html += `<div class="message info"><strong>Note:</strong> ${escapeHtml(String(result.note))}</div>`;
            }
            
            if (!html) {
                html = '<div class="message error">No content to display</div>';
            }
            
            // Update DOM
            modalBody.innerHTML = html;
            openModal(); // Ensure it's open
        }
        
        function escapeHtml(text) {
            if (text == null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }
        
        // Test Functions
        async function testIndex(endpoint, name) {
            console.log(`Testing ${name} at ${endpoint}`);
            showModalLoading(`Testing ${name}...`);
            
            try {
                const response = await fetch(`/experiments/indexing_demo/${endpoint}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log(`Response for ${name}:`, data);
                console.log(`Performance data:`, JSON.stringify(data, null, 2));
                
                if (!data) {
                    throw new Error('No data returned from server');
                }
                
                displayModalResults(data);
                setTimeout(updateStats, 500); // Update stats after test
                
            } catch (error) {
                console.error(`Error testing ${name}:`, error);
                displayModalError(error);
            }
        }
        
        async function testRegular() {
            await testIndex('test-regular', 'Regular Index');
        }
        
        async function testText() {
            await testIndex('test-text', 'Text Index');
        }
        
        async function testGeospatial() {
            await testIndex('test-geospatial', 'Geospatial Index');
        }
        
        async function testPartial() {
            await testIndex('test-partial', 'Partial Index');
        }
        
        async function testTTL() {
            await testIndex('test-ttl', 'TTL Index');
        }
        
        async function testVector() {
            await testIndex('test-vector', 'Vector Search');
        }


        /* --- MONGODB LOGO EFFECT SCRIPT --- */
        
        /**
         * Creates an intelligently positioned MongoDB logo with elegant CSS effects.
         */
        function createMongoLogo() {
            // Create container for the logo
            const logoContainer = document.createElement('div');
            logoContainer.id = 'mongo-logo-container';
            document.body.prepend(logoContainer);

            // Create the logo image element
            const logoImg = document.createElement('img');
            logoImg.src = 'https://logo.svgcdn.com/logos/mongodb-icon.svg';
            logoImg.alt = 'MongoDB';
            logoImg.className = 'mongo-logo-img';

            // Add subtle mouse parallax effect
            document.addEventListener('mousemove', (e) => {
                const mouseX = e.clientX / window.innerWidth;
                const mouseY = e.clientY / window.innerHeight;
                
                // Subtle parallax - logo slightly follows mouse
                const moveX = (mouseX - 0.5) * 20;
                const moveY = (mouseY - 0.5) * 20;
                
                logoImg.style.transform = `rotate(-15deg) translate(${moveX}px, ${moveY}px)`;
            });

            logoContainer.appendChild(logoImg);
        }

        // Run when page loads
        window.addEventListener('DOMContentLoaded', createMongoLogo);

        /* --- END OF MONGODB LOGO EFFECT SCRIPT --- */
    </script>
</body>
</html>