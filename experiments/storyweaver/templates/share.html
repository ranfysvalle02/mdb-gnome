{% extends "base.html" %}

{% block title %}Contribute to {{ project.name }}{% endblock %}

{% block content %}
<main class="space-y-12 max-w-3xl mx-auto">
    <div class="text-center">
        <h2 class="text-3xl font-extrabold text-slate-900">Contribute to: <span class="text-indigo-600">{{ project.name }}</span></h2>
        <p class="mt-2 text-lg text-slate-600">Join the conversation and add your perspective.</p>
    </div>
    <div class="content-card text-left">
        <p class="text-sm font-semibold text-slate-500 mb-2 tracking-wide uppercase">Group Prompt</p>
        <blockquote class="text-lg text-slate-800 border-l-4 border-emerald-500 pl-4 italic">{{ invite_prompt }}</blockquote>
    </div>
    
    <div id="contribution-card" class="content-card">
        <h3 class="text-2xl font-bold mb-5 flex items-center gap-3"><span class="text-3xl">✍️</span> Your Contribution</h3>
         <form id="shared-note-form" class="space-y-4">
            <div>
                <label for="contributor-label-input" class="block text-sm font-medium text-slate-700 mb-1">Your Name</label>
                <input type="text" id="contributor-label-input" required class="form-input" placeholder="e.g., Jane Doe">
            </div>
            <div>
                <label for="note-content" class="block text-sm font-medium text-slate-700 mb-1">Your Note</label>
                <textarea id="note-content" rows="8" required class="form-textarea" placeholder="Share your thoughts here..."></textarea>
            </div>
            <input type="hidden" id="shared-token-input" value="{{ shared_token }}">
            <input type="hidden" id="project-id-input" value="{{ project._id }}">
            <div class="text-right pt-2">
                 <button type="submit" id="submit-note-btn" class="btn btn-primary">Add My Note</button>
            </div>
        </form>
    </div>
    <div id="thank-you-message" class="content-card text-center hidden">
        <h3 class="text-2xl font-bold text-emerald-600 mb-3">Thank You!</h3>
        <p class="text-slate-700">Your contribution has been successfully added to the project.</p>
    </div>
</main>
{% endblock %}

<script>
document.addEventListener('DOMContentLoaded', () => {
    const sharedNoteForm = document.getElementById('shared-note-form');
    const submitBtn = document.getElementById('submit-note-btn');
    
    sharedNoteForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const contributorLabel = document.getElementById('contributor-label-input').value.trim();
        const content = document.getElementById('note-content').value.trim();
        const sharedToken = document.getElementById('shared-token-input').value;
        const projectId = document.getElementById('project-id-input').value;

        if (!contributorLabel || !content) {
            alert('Please enter your name and a note.');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';

        try {
            const response = await fetch('/experiments/storyweaver/api/notes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    content: content,
                    project_id: projectId,
                    shared_token: sharedToken,
                    contributor_label: contributorLabel,
                    active_prompt: '{{ invite_prompt }}'
                })
            });
            
            const result = await response.json();
            if (result.status === 'success') {
                document.getElementById('contribution-card').classList.add('hidden');
                document.getElementById('thank-you-message').classList.remove('hidden');
            } else {
                alert('An error occurred: ' + (result.message || 'Failed to submit note.'));
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add My Note';
            }
        } catch (error) {
            console.error('Error submitting note:', error);
            alert('An error occurred: ' + error.message);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Add My Note';
        }
    });
});
</script>
