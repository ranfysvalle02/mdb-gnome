{% extends "base.html" %}

{% block title %}{{ project.name }} - Story Weaver{% endblock %}

{% block content %}
<div id="js-data"
    data-project-id="{{ project._id }}"
    data-project-name="{{ project.name }}"
    data-project-type="{{ project.project_type }}"
    data-is-atlas="{{ is_atlas }}">
</div>

<main class="space-y-8">
    <!-- Hero Section -->
    <div class="text-center mb-12">
        <h1 class="text-5xl md:text-6xl font-extrabold mb-4 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
            {{ project.name }}
        </h1>
        <p class="mt-4 text-xl md:text-2xl text-slate-600 max-w-3xl mx-auto font-light italic leading-relaxed">
            "{{ project.project_goal }}"
        </p>
    </div>

    <!-- Primary Actions Section -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- Add Note Card (Always visible) -->
        <div class="lg:col-span-2">
            <div class="content-card h-full">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-100 to-pink-100 flex items-center justify-center text-2xl">
                        ‚úçÔ∏è
                    </div>
                    <h2 class="text-2xl font-bold text-slate-900">Add a Note</h2>
                </div>
                <form id="note-form" class="space-y-4">
                    <div>
                        <textarea id="note-content" rows="5" class="form-textarea" placeholder="Add your thoughts, research, or memories..."></textarea>
                    </div>
                    <div>
                        <label for="note-tags-input" class="block text-sm font-medium text-slate-700 mb-2">
                            Tags <span class="text-slate-500 font-normal">(comma separated)</span>
                        </label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="note-tags-input" class="form-input flex-1" placeholder="research, chapter 1, key point">
                            <button type="button" id="suggest-tags-btn" class="btn btn-accent flex-shrink-0 h-[46px] px-4 disabled:opacity-50">
                                Suggest
                            </button>
                        </div>
                        <div id="tag-suggestions-container" class="mt-3 flex flex-wrap gap-2"></div>
                    </div>
                    <div class="flex justify-end pt-2">
                        <button type="submit" class="btn btn-primary px-8">Add Note</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Quick Actions Sidebar -->
        <div class="space-y-6">
            {% if project.project_type == 'study' %}
            <!-- Generate Notes Card -->
            <div class="content-card">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-emerald-100 to-teal-100 flex items-center justify-center text-xl">
                        üß†
                    </div>
                    <h3 class="text-lg font-bold text-slate-900">Generate Notes</h3>
                </div>
                <form id="generate-notes-form" class="space-y-4">
                    <div>
                        <label for="note-topic-input" class="block text-sm font-medium text-slate-700 mb-1">Topic</label>
                        <input type="text" id="note-topic-input" required class="form-input text-sm" placeholder="e.g., 'The Krebs Cycle'">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="use-web-search-checkbox" class="w-4 h-4 text-emerald-600 bg-gray-100 border-gray-300 rounded focus:ring-emerald-500">
                        <label for="use-web-search-checkbox" class="text-sm font-medium text-slate-700 cursor-pointer">
                            üîç Search web
                        </label>
                    </div>
                    <button type="submit" class="btn btn-accent w-full text-sm py-2">Generate</button>
                </form>
            </div>
            {% endif %}

            <!-- Collapsible Invite & Share -->
            <div class="content-card">
                <button id="invite-toggle" class="w-full flex items-center justify-between mb-4 group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center text-xl">
                            üíå
                        </div>
                        <h3 class="text-lg font-bold text-slate-900">Invite & Share</h3>
                    </div>
                    <svg class="w-5 h-5 text-slate-500 transition-transform group-hover:rotate-180" id="invite-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div id="invite-content" class="hidden space-y-4 pt-2 border-t border-slate-200">
                    <!-- Specific Contributor Invite -->
                    <div class="space-y-3">
                        <p class="text-xs font-semibold text-slate-600 uppercase tracking-wide">Invite Contributor</p>
                        <form id="token-form" class="space-y-3">
                            <div>
                                <label for="contributor-label-input" class="block text-xs font-medium text-slate-700 mb-1">Name</label>
                                <input type="text" id="contributor-label-input" required class="form-input text-sm" placeholder="Contributor name">
                            </div>
                            <div>
                                <label for="prompt-textarea" class="block text-xs font-medium text-slate-700 mb-1">Prompt</label>
                                <textarea id="prompt-textarea" rows="2" required class="form-textarea text-sm" placeholder="What should they write about?"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary w-full text-sm py-2">Generate Link</button>
                            <div id="token-result" class="text-xs"></div>
                        </form>
                    </div>
                    <hr class="my-4">
                    <!-- Shared Link -->
                    <div class="space-y-3">
                        <p class="text-xs font-semibold text-slate-600 uppercase tracking-wide">Open Share</p>
                        <form id="shared-token-form" class="space-y-3">
                            <div>
                                <label for="shared-prompt-textarea" class="block text-xs font-medium text-slate-700 mb-1">Group Prompt</label>
                                <textarea id="shared-prompt-textarea" rows="2" required class="form-textarea text-sm" placeholder="What should they contribute?"></textarea>
                            </div>
                            <button type="submit" class="btn btn-secondary w-full text-sm py-2">Generate Link</button>
                            <div id="shared-token-result" class="text-xs"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Tools Section -->
    <div class="content-card">
        <div class="flex items-center gap-3 mb-6">
            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-cyan-100 to-blue-100 flex items-center justify-center text-2xl">
                ü§ñ
            </div>
            <div>
                <h2 class="text-2xl font-bold text-slate-900">AI Tools</h2>
                <p class="text-sm text-slate-600 mt-1">Select notes to transform with AI</p>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="ai-action-card">
                <div class="text-3xl mb-3">üìñ</div>
                <h4 class="ai-action-title text-lg">Weave a Story</h4>
                <div class="space-y-3 mb-4">
                    <div>
                        <label for="story-tone-select" class="ai-action-label text-xs">Tone</label>
                        <select id="story-tone-select" class="form-select text-sm">
                            {% for tone in story_tones %}<option value="{{ tone }}">{{ tone }}</option>{% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="story-format-select" class="ai-action-label text-xs">Format</label>
                        <select id="story-format-select" class="form-select text-sm">
                            {% for format in story_formats %}<option value="{{ format }}">{{ format }}</option>{% endfor %}
                        </select>
                    </div>
                </div>
                <button type="button" id="launch-story-builder-btn" class="btn btn-secondary w-full text-sm py-2 mt-auto">Select & Create</button>
            </div>
            
            <div class="ai-action-card">
                <div class="text-3xl mb-3">üéµ</div>
                <h4 class="ai-action-title text-lg">Create a Song</h4>
                <div class="space-y-3 mb-4">
                    <div>
                        <label for="song-genre-select" class="ai-action-label text-xs">Genre</label>
                        <select id="song-genre-select" class="form-select text-sm">
                            {% for genre in song_genres %}<option value="{{ genre }}">{{ genre }}</option>{% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="song-mood-select" class="ai-action-label text-xs">Mood</label>
                        <select id="song-mood-select" class="form-select text-sm">
                            {% for mood in song_moods %}<option value="{{ mood }}">{{ mood }}</option>{% endfor %}
                        </select>
                    </div>
                </div>
                <button type="button" id="launch-song-builder-btn" class="btn btn-secondary w-full text-sm py-2 mt-auto">Select & Write</button>
            </div>
            
            <div class="ai-action-card">
                <div class="text-3xl mb-3">üß†</div>
                <h4 class="ai-action-title text-lg">Generate Quiz</h4>
                <p class="text-xs text-slate-600 mb-4 flex-grow">Test knowledge with customizable quizzes</p>
                <button type="button" data-modal-target="quiz-options-modal" class="btn btn-accent w-full text-sm py-2 mt-auto">Configure</button>
            </div>
            
            <div class="ai-action-card">
                <div class="text-3xl mb-3">üìö</div>
                <h4 class="ai-action-title text-lg">Study Guide</h4>
                <p class="text-xs text-slate-600 mb-4 flex-grow">Synthesize notes into a structured guide</p>
                <button type="button" id="launch-study-guide-btn" class="btn btn-secondary-outline w-full text-sm py-2 mt-auto">Generate</button>
            </div>
        </div>
    </div>

    <!-- Notes Section -->
    <div class="content-card">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center text-xl">
                    üìù
                </div>
                <h2 class="text-2xl font-bold text-slate-900">Project Notes</h2>
            </div>
            <select id="contributor-filter" class="form-select w-full sm:w-auto text-sm max-w-xs"></select>
        </div>
        <div id="notes-container" class="space-y-4"></div>
        <div id="loading-indicator" class="text-center p-8 text-slate-500 hidden">
            <div class="spinner mx-auto mb-2"></div>
            Loading notes...
        </div>
    </div>

    <!-- Quizzes Section (Collapsible) -->
    {% if quizzes %}
    <div class="content-card">
        <button id="quizzes-toggle" class="w-full flex items-center justify-between mb-4 group">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-100 to-blue-100 flex items-center justify-center text-xl">
                    üéØ
                </div>
                <h2 class="text-xl font-bold text-slate-900">Quizzes <span class="text-sm font-normal text-slate-500">({{ quizzes|length }})</span></h2>
            </div>
            <svg class="w-5 h-5 text-slate-500 transition-transform group-hover:rotate-180" id="quizzes-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
        </button>
        <div id="quizzes-content" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-slate-200">
                {% for quiz in quizzes %}
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-slate-800">{{ quiz.title }}</h4>
                        <span class="text-xs font-semibold bg-cyan-100 text-cyan-800 px-2 py-1 rounded-full">{{ quiz.question_type }}</span>
                    </div>
                    <p class="text-xs text-slate-500 mb-4">Created: {{ quiz.created_at.strftime('%B %d, %Y') if quiz.created_at else 'Date Missing' }}</p>
                    <div class="flex items-center gap-2">
                        <a href="/experiments/storyweaver/quiz/{{ quiz.share_token }}" target="_blank" class="btn btn-secondary-outline text-xs py-1 px-3 flex-1 text-center">View</a>
                        <button class="btn btn-primary text-xs py-1 px-3 copy-link-btn" data-url="/experiments/storyweaver/quiz/{{ quiz.share_token }}">Share</button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Invitations Section (Collapsible) -->
    {% if invited_users or shared_invites %}
    <div class="content-card">
        <button id="invitations-toggle" class="w-full flex items-center justify-between mb-4 group">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center text-xl">
                    üîó
                </div>
                <h2 class="text-xl font-bold text-slate-900">Invitations & Links</h2>
            </div>
            <svg class="w-5 h-5 text-slate-500 transition-transform group-hover:rotate-180" id="invitations-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
        </button>
        <div id="invitations-content" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-slate-200">
                {% for invite in invited_users %}
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-slate-800">{{ invite.label }}</h4>
                        <span class="text-xs font-semibold bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full">Specific</span>
                    </div>
                    <p class="text-xs text-slate-600 italic mb-3">"{{ invite.prompt }}"</p>
                    <div class="flex items-center gap-2">
                        <input type="text" readonly value="/experiments/storyweaver/invite/{{ invite.token }}" class="form-input-minimal flex-1 text-xs truncate">
                        <button class="btn btn-primary text-xs py-1 px-3 copy-link-btn" data-url="/experiments/storyweaver/invite/{{ invite.token }}">Copy</button>
                    </div>
                </div>
                {% endfor %}
                {% for invite in shared_invites %}
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-slate-800">Share Link</h4>
                        <span class="text-xs font-semibold bg-green-100 text-green-800 px-2 py-1 rounded-full">Open</span>
                    </div>
                    <p class="text-xs text-slate-600 italic mb-3">"{{ invite.prompt }}"</p>
                    <div class="flex items-center gap-2">
                        <input type="text" readonly value="/experiments/storyweaver/share/{{ invite.token }}" class="form-input-minimal flex-1 text-xs truncate">
                        <button class="btn btn-primary text-xs py-1 px-3 copy-link-btn" data-url="/experiments/storyweaver/share/{{ invite.token }}">Copy</button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</main>
{% endblock %}

{% block modals %}
    <!-- Modals remain the same -->
    <div id="note-selection-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-slate-50 rounded-xl shadow-2xl max-w-7xl w-full h-[90vh] flex flex-col modal-animated">
            <header class="flex-shrink-0 p-4 border-b flex justify-between items-center">
                <h3 id="note-selection-title" class="text-xl font-bold text-slate-900">Select Notes</h3>
                <button class="modal-close-btn text-slate-400 text-3xl hover:text-slate-800 transition-colors">&times;</button>
            </header>
            <main class="flex-grow flex flex-col md:flex-row overflow-hidden">
                <aside class="w-full md:w-1/4 p-4 border-r overflow-y-auto">
                    <h4 class="font-semibold mb-2">Search & Filter</h4>
                    <input type="search" id="preview-search-input" placeholder="Search notes..." class="form-input mb-4">
                    <h5 class="font-semibold mb-2 mt-4">Tags</h5>
                    <div id="preview-tags-container" class="space-y-2 text-sm"></div>
                </aside>
                <section class="flex-grow p-4 flex flex-col overflow-y-auto bg-white">
                    <div id="preview-results-summary" class="text-sm text-slate-600 mb-2 flex-shrink-0"></div>
                    <div id="preview-notes-container" class="space-y-3 flex-grow overflow-y-auto pr-2"></div>
                </section>
                <aside class="w-full md:w-1/3 p-4 bg-slate-100 border-l flex flex-col overflow-y-auto">
                    <div class="flex-shrink-0">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold">Selected Notes (<span id="selected-notes-count">0</span>)</h4>
                            <div class="flex items-center space-x-2">
                                <button type="button" id="select-all-notes-btn" class="text-xs font-semibold text-indigo-600 hover:text-indigo-800 transition-colors">Select All</button>
                                <button type="button" id="deselect-all-notes-btn" class="text-xs font-semibold text-indigo-600 hover:text-indigo-800 transition-colors">Deselect All</button>
                            </div>
                        </div>
                    </div>
                    <div id="selected-notes-container" class="space-y-2 flex-grow overflow-y-auto"></div>
                </aside>
            </main>
            <footer class="flex-shrink-0 p-4 border-t flex justify-end bg-slate-50 rounded-b-xl">
                <button id="confirm-action-btn" class="btn btn-secondary disabled:from-slate-400 disabled:to-slate-400" disabled>Confirm Selection</button>
            </footer>
        </div>
    </div>
    <div id="quiz-options-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 max-w-lg w-full modal-animated">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-slate-900">Quiz Options</h3>
                <button class="modal-close-btn text-slate-400 text-3xl hover:text-slate-800 transition-colors">&times;</button>
            </div>
            <form id="quiz-options-form" class="space-y-4">
                <div>
                    <label for="quiz-num-questions" class="block text-sm font-medium text-slate-700 mb-1">Number of Questions</label>
                    <input type="number" id="quiz-num-questions" class="form-input" value="5" min="1" max="10">
                </div>
                <div>
                    <label for="quiz-question-type" class="block text-sm font-medium text-slate-700 mb-1">Question Type</label>
                    <select id="quiz-question-type" class="form-select">
                        <option value="Multiple Choice">Multiple Choice</option>
                        <option value="True/False">True / False</option>
                    </select>
                </div>
                <div>
                    <label for="quiz-difficulty" class="block text-sm font-medium text-slate-700 mb-1">Difficulty</label>
                    <select id="quiz-difficulty" class="form-select">
                        <option value="Easy">Easy</option>
                        <option selected value="Medium">Medium</option>
                        <option value="Hard">Hard</option>
                    </select>
                </div>
                <div class="pt-4 text-right">
                    <button type="submit" class="btn btn-primary">Select Notes & Generate</button>
                </div>
            </form>
        </div>
    </div>
    <div id="story-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto modal-animated">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h3 id="story-modal-title" class="text-2xl font-bold text-slate-900">Your Story</h3>
                <button class="modal-close-btn text-slate-400 text-3xl hover:text-slate-800 transition-colors">&times;</button>
            </div>
            <div id="story-modal-content" class="text-slate-700 leading-relaxed space-y-4 prose max-w-none"></div>
        </div>
    </div>
    <div id="song-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto modal-animated">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h3 id="song-modal-title" class="text-2xl font-bold text-slate-900">Your Song Lyrics</h3>
                <button class="modal-close-btn text-slate-400 text-3xl hover:text-slate-800 transition-colors">&times;</button>
            </div>
            <div id="song-modal-content" class="text-slate-700 leading-relaxed space-y-4 prose max-w-none"></div>
        </div>
    </div>
    <div id="study-guide-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto modal-animated">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h3 id="study-guide-modal-title" class="text-2xl font-bold text-slate-900">Your Study Guide</h3>
                <button class="modal-close-btn text-slate-400 text-3xl hover:text-slate-800 transition-colors">&times;</button>
            </div>
            <div id="study-guide-modal-content" class="text-slate-700 leading-relaxed space-y-4 prose max-w-none"></div>
        </div>
    </div>
    <div id="quiz-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto modal-animated">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-slate-900">Practice Quiz</h3>
                <button class="modal-close-btn text-slate-400 text-3xl hover:text-slate-800 transition-colors">&times;</button>
            </div>
            <div id="quiz-content-area"></div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log('Project page loaded, initializing...');
    
    const jsData = document.getElementById('js-data');
    if (!jsData) {
        console.error('js-data element not found!');
        return;
    }
    
    const projectId = jsData.dataset.projectId;
    const projectName = jsData.dataset.projectName;
    const projectType = jsData.dataset.projectType;
    
    console.log('Project data:', { projectId, projectName, projectType });
    
    // Collapsible sections
    function setupCollapsible(toggleId, contentId, arrowId) {
        const toggle = document.getElementById(toggleId);
        const content = document.getElementById(contentId);
        const arrow = document.getElementById(arrowId);
        if (toggle && content && arrow) {
            toggle.addEventListener('click', () => {
                const isHidden = content.classList.contains('hidden');
                if (isHidden) {
                    content.classList.remove('hidden');
                    arrow.style.transform = 'rotate(180deg)';
                } else {
                    content.classList.add('hidden');
                    arrow.style.transform = 'rotate(0deg)';
                }
            });
        }
    }
    
    setupCollapsible('invite-toggle', 'invite-content', 'invite-arrow');
    setupCollapsible('quizzes-toggle', 'quizzes-content', 'quizzes-arrow');
    setupCollapsible('invitations-toggle', 'invitations-content', 'invitations-arrow');
    
    // Load initial notes
    loadNotes(projectId, 1);
    loadContributors(projectId);
    
    // Note form submission
    const noteForm = document.getElementById('note-form');
    if (noteForm) {
        noteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Note form submitted');
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding...';
            
            const content = document.getElementById('note-content').value.trim();
            const tags = document.getElementById('note-tags-input').value.trim();
            
            if (!content) {
                alert('Please enter note content.');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                return;
            }
            
            try {
                const response = await fetch('/experiments/storyweaver/api/notes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        project_id: projectId,
                        content: content,
                        tags: tags
                    })
                });
                
                const result = await response.json();
                console.log('Add note result:', result);
                
                if (result.status === 'success') {
                    noteForm.reset();
                    document.getElementById('tag-suggestions-container').innerHTML = '';
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    loadNotes(projectId, 1);
                } else {
                    alert('Error adding note: ' + (result.message || 'Unknown error'));
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            } catch (error) {
                console.error('Error adding note:', error);
                alert('Error adding note: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
    }
    
    // Tag suggestions
    const suggestTagsBtn = document.getElementById('suggest-tags-btn');
    if (suggestTagsBtn) {
        suggestTagsBtn.addEventListener('click', async () => {
            const content = document.getElementById('note-content').value.trim();
            if (!content) {
                alert('Please enter some note content first.');
                return;
            }
            
            suggestTagsBtn.disabled = true;
            suggestTagsBtn.textContent = 'Suggesting...';
            
            try {
                const response = await fetch('/experiments/storyweaver/api/suggest-tags', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        project_id: projectId,
                        content: content
                    })
                });
                
                const result = await response.json();
                const container = document.getElementById('tag-suggestions-container');
                
                if (result.tags && result.tags.length > 0) {
                    container.innerHTML = result.tags.map(tag => 
                        `<span class="tag-suggestion cursor-pointer" data-tag="${tag}">${tag}</span>`
                    ).join('');
                    
                    // Make tag suggestions clickable
                    container.querySelectorAll('.tag-suggestion').forEach(el => {
                        el.addEventListener('click', () => {
                            const tagsInput = document.getElementById('note-tags-input');
                            const currentTags = tagsInput.value.split(',').map(t => t.trim()).filter(t => t);
                            const newTag = el.dataset.tag;
                            if (!currentTags.includes(newTag)) {
                                tagsInput.value = currentTags.concat(newTag).join(', ');
                            }
                        });
                    });
                } else {
                    container.innerHTML = '<span class="text-sm text-slate-500">No suggestions available</span>';
                }
            } catch (error) {
                console.error('Error suggesting tags:', error);
                alert('Error suggesting tags: ' + error.message);
            } finally {
                suggestTagsBtn.disabled = false;
                suggestTagsBtn.textContent = 'Suggest';
            }
        });
    }
    
    // Generate invite token form
    const tokenForm = document.getElementById('token-form');
    if (tokenForm) {
        tokenForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Generating...';
            
            const label = document.getElementById('contributor-label-input').value.trim();
            const prompt = document.getElementById('prompt-textarea').value.trim();
            
            if (!label || !prompt) {
                alert('Please fill in both contributor name and prompt.');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                return;
            }
            
            try {
                const response = await fetch('/experiments/storyweaver/api/generate-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        project_id: projectId,
                        label: label,
                        prompt: prompt
                    })
                });
                
                const result = await response.json();
                const resultDiv = document.getElementById('token-result');
                
                if (result.status === 'success') {
                    const fullUrl = window.location.origin + result.invite_url;
                    resultDiv.innerHTML = `
                        <div class="p-3 bg-indigo-50 border border-indigo-200 rounded-lg text-xs">
                            <p class="font-semibold mb-2">Invite link for ${result.label}:</p>
                            <div class="flex items-center gap-2">
                                <input type="text" readonly value="${fullUrl}" class="form-input-minimal flex-1 text-xs">
                                <button class="btn btn-primary text-xs py-1 px-2 copy-link-btn" data-url="${fullUrl}">Copy</button>
                            </div>
                        </div>
                    `;
                    tokenForm.reset();
                    
                    // Setup copy button
                    resultDiv.querySelector('.copy-link-btn').addEventListener('click', async (e) => {
                        const url = e.target.dataset.url;
                        try {
                            await navigator.clipboard.writeText(url);
                            e.target.textContent = 'Copied!';
                            setTimeout(() => e.target.textContent = 'Copy', 2000);
                        } catch (err) {
                            alert('Failed to copy. URL: ' + url);
                        }
                    });
                } else {
                    alert('Error generating invite: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error generating token:', error);
                alert('Error generating invite: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
    }
    
    // Generate shared token form
    const sharedTokenForm = document.getElementById('shared-token-form');
    if (sharedTokenForm) {
        sharedTokenForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Generating...';
            
            const prompt = document.getElementById('shared-prompt-textarea').value.trim();
            
            if (!prompt) {
                alert('Please enter a prompt.');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                return;
            }
            
            try {
                const response = await fetch('/experiments/storyweaver/api/generate-shared-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        project_id: projectId,
                        prompt: prompt
                    })
                });
                
                const result = await response.json();
                const resultDiv = document.getElementById('shared-token-result');
                
                if (result.status === 'success') {
                    const fullUrl = window.location.origin + result.shared_url;
                    resultDiv.innerHTML = `
                        <div class="p-3 bg-green-50 border border-green-200 rounded-lg text-xs">
                            <p class="font-semibold mb-2">Share link:</p>
                            <div class="flex items-center gap-2">
                                <input type="text" readonly value="${fullUrl}" class="form-input-minimal flex-1 text-xs">
                                <button class="btn btn-secondary text-xs py-1 px-2 copy-link-btn" data-url="${fullUrl}">Copy</button>
                            </div>
                        </div>
                    `;
                    sharedTokenForm.reset();
                    
                    // Setup copy button
                    resultDiv.querySelector('.copy-link-btn').addEventListener('click', async (e) => {
                        const url = e.target.dataset.url;
                        try {
                            await navigator.clipboard.writeText(url);
                            e.target.textContent = 'Copied!';
                            setTimeout(() => e.target.textContent = 'Copy', 2000);
                        } catch (err) {
                            alert('Failed to copy. URL: ' + url);
                        }
                    });
                } else {
                    alert('Error generating share link: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error generating shared token:', error);
                alert('Error generating share link: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
    }
    
    // Generate notes form (for study projects)
    const generateNotesForm = document.getElementById('generate-notes-form');
    if (generateNotesForm) {
        generateNotesForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Generating...';
            
            const topic = document.getElementById('note-topic-input').value.trim();
            
            if (!topic) {
                alert('Please enter a topic.');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                return;
            }
            
            try {
                const useWebSearch = document.getElementById('use-web-search-checkbox')?.checked || false;
                const response = await fetch('/experiments/storyweaver/api/generate-notes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        project_id: projectId,
                        topic: topic,
                        num_notes: 5,
                        use_web_search: useWebSearch
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    generateNotesForm.reset();
                    loadNotes(projectId, 1);
                    alert(`Successfully generated ${result.notes.length} study notes!`);
                } else {
                    alert('Error generating notes: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error generating notes:', error);
                alert('Error generating notes: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
    }
    
    // Load notes function
    async function loadNotes(projId, page = 1, contributorFilter = null) {
        console.log('Loading notes for project:', projId);
        const container = document.getElementById('notes-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        if (!container) {
            console.error('notes-container not found!');
            return;
        }
        
        loadingIndicator.classList.remove('hidden');
        container.innerHTML = '';
        
        try {
            let url = `/experiments/storyweaver/api/notes/${projId}?page=${page}`;
            if (contributorFilter && contributorFilter !== 'All Contributors') {
                url += `&contributor_filter=${encodeURIComponent(contributorFilter)}`;
            }
            
            const response = await fetch(url, {
                credentials: 'include'
            });
            
            const notes = await response.json();
            console.log('Loaded notes:', notes);
            
            if (notes.length === 0) {
                container.innerHTML = '<div class="no-notes-message"><p class="text-slate-500">No notes yet. Add your first note above!</p></div>';
            } else {
                container.innerHTML = notes.map(note => `
                    <div class="note-card animate-fade-in relative" data-note-id="${note._id}">
                        <button class="note-delete-btn absolute top-2 right-2" data-note-id="${note._id}" title="Delete note">&times;</button>
                        <div class="flex flex-wrap items-center gap-2 mb-3">
                            <span class="contributor-tag">${note.contributor_label || 'Me'}</span>
                            ${note.tags && note.tags.length > 0 ? note.tags.map(tag => `<span class="tag">${tag}</span>`).join(' ') : ''}
                        </div>
                        <p class="note-content mb-3">${escapeHtml(note.content)}</p>
                        <small class="note-timestamp">${note.formatted_timestamp || 'Date missing'}</small>
                    </div>
                `).join('');
                
                // Setup delete buttons
                container.querySelectorAll('.note-delete-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const noteId = btn.dataset.noteId;
                        if (confirm('Are you sure you want to delete this note?')) {
                            try {
                                const deleteResponse = await fetch(`/experiments/storyweaver/api/notes/${noteId}`, {
                                    method: 'DELETE',
                                    credentials: 'include'
                                });
                                const result = await deleteResponse.json();
                                if (result.status === 'success') {
                                    btn.closest('.note-card').classList.add('animate-fade-out');
                                    setTimeout(() => {
                                        btn.closest('.note-card').remove();
                                        if (container.children.length === 0) {
                                            container.innerHTML = '<div class="no-notes-message"><p class="text-slate-500">No notes yet. Add your first note above!</p></div>';
                                        }
                                    }, 300);
                                } else {
                                    alert('Error deleting note: ' + result.message);
                                }
                            } catch (error) {
                                console.error('Error deleting note:', error);
                                alert('Error deleting note: ' + error.message);
                            }
                        }
                    });
                });
            }
        } catch (error) {
            console.error('Error loading notes:', error);
            container.innerHTML = '<div class="no-notes-message"><p class="text-red-500">Error loading notes. Please refresh the page.</p></div>';
        } finally {
            loadingIndicator.classList.add('hidden');
        }
    }
    
    // Load contributors for filter
    async function loadContributors(projId) {
        const filterSelect = document.getElementById('contributor-filter');
        if (!filterSelect) return;
        
        try {
            const response = await fetch(`/experiments/storyweaver/api/contributors/${projId}`, {
                credentials: 'include'
            });
            const contributors = await response.json();
            
            filterSelect.innerHTML = contributors.map(c => 
                `<option value="${c}">${c}</option>`
            ).join('');
            
            filterSelect.addEventListener('change', (e) => {
                loadNotes(projectId, 1, e.target.value);
            });
        } catch (error) {
            console.error('Error loading contributors:', error);
        }
    }
    
    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML.replace(/\n/g, '<br>');
    }
    
    // Copy link functionality for all copy buttons
    document.addEventListener('click', async (e) => {
        if (e.target.classList.contains('copy-link-btn')) {
            const url = e.target.dataset.url;
            const fullUrl = window.location.origin + url;
            try {
                await navigator.clipboard.writeText(fullUrl);
                const originalText = e.target.textContent;
                e.target.textContent = 'Copied!';
                setTimeout(() => {
                    e.target.textContent = originalText;
                }, 2000);
            } catch (err) {
                alert('Failed to copy. URL: ' + fullUrl);
            }
        }
    });
    
    // AI action handlers (these would need to be loaded from main.js or defined here)
    // For now, keeping them minimal - they should work with existing modal code
});
</script>
{% endblock %}
