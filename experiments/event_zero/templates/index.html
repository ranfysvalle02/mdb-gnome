<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tix & Lodging Platform</title>
    <!-- Tailwind CSS via CDN (development only) -->
    <!-- For production, use: npm install -D tailwindcss && npx tailwindcss build -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- jsQR for QR code scanning -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        /* Dark mode by default */
        html {
            color-scheme: dark;
        }
        
        body {
            background: #0f172a;
            color: #e2e8f0;
        }
        
        .event-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .event-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Floating animations background */
        .floating-shapes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
            pointer-events: none;
        }
        
        .floating-shape {
            position: absolute;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1));
            animation: float 20s infinite ease-in-out;
            opacity: 0.3;
        }
        
        .floating-shape:nth-child(1) {
            width: 80px;
            height: 80px;
            left: 10%;
            top: 20%;
            animation-duration: 25s;
            animation-delay: 0s;
        }
        
        .floating-shape:nth-child(2) {
            width: 120px;
            height: 120px;
            left: 80%;
            top: 10%;
            animation-duration: 30s;
            animation-delay: 2s;
        }
        
        .floating-shape:nth-child(3) {
            width: 60px;
            height: 60px;
            left: 50%;
            top: 60%;
            animation-duration: 20s;
            animation-delay: 4s;
        }
        
        .floating-shape:nth-child(4) {
            width: 100px;
            height: 100px;
            left: 20%;
            top: 80%;
            animation-duration: 35s;
            animation-delay: 1s;
        }
        
        .floating-shape:nth-child(5) {
            width: 90px;
            height: 90px;
            left: 70%;
            top: 70%;
            animation-duration: 28s;
            animation-delay: 3s;
        }
        
        .floating-shape:nth-child(6) {
            width: 70px;
            height: 70px;
            left: 40%;
            top: 30%;
            animation-duration: 22s;
            animation-delay: 5s;
        }
        
        @keyframes float {
            0%, 100% {
                transform: translate(0, 0) rotate(0deg);
            }
            25% {
                transform: translate(50px, -50px) rotate(90deg);
            }
            50% {
                transform: translate(-30px, 30px) rotate(180deg);
            }
            75% {
                transform: translate(40px, 20px) rotate(270deg);
            }
        }
        
        /* Glow effects */
        .glow-purple {
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
        }
        
        .glow-blue {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        
        /* Content wrapper */
        .content-wrapper {
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body class="min-h-screen relative">
    <!-- Floating Background Animations -->
    <div class="floating-shapes">
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
    </div>
    
    <!-- Content Wrapper -->
    <div class="content-wrapper">
    <!-- Navigation -->
    <nav class="bg-gray-900/80 backdrop-blur-md border-b border-gray-800 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fas fa-ticket-alt text-3xl text-purple-400 glow-purple"></i>
                <h1 class="text-2xl font-bold text-white">Tix & Lodging</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="user-email" class="text-gray-300 hidden"></span>
                <button id="my-bookings-btn" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 hover:glow-purple transition-all hidden">
                    <i class="fas fa-calendar-check mr-2"></i>My Bookings
                </button>
                <button id="admin-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 hover:glow-blue transition-all hidden">
                    <i class="fas fa-cog mr-2"></i>Owner
                </button>
                <button id="login-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 hover:glow-blue transition-all">
                    <i class="fas fa-sign-in-alt mr-2"></i>Login
                </button>
                <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all hidden">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Login Modal -->
        <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
            <div class="bg-gray-800/90 backdrop-blur-md rounded-lg p-8 max-w-md w-full mx-4 border border-gray-700">
                <div class="text-center mb-8">
                    <div class="mb-4">
                        <i class="fas fa-ticket-alt text-5xl text-purple-400 mb-4 glow-purple"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-white mb-2">Demo Experience</h2>
                    <p class="text-gray-300">Choose a role to explore the platform</p>
                </div>
                
                <div class="space-y-4 mb-6">
                    <button id="login-as-owner-btn" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-4 rounded-lg hover:from-purple-700 hover:to-indigo-700 font-semibold text-lg transition-all transform hover:scale-105 shadow-lg">
                        <i class="fas fa-user-shield mr-2"></i>Login as Owner
                        <div class="text-sm font-normal mt-1 opacity-90">Manage events, hotels & check-ins</div>
                    </button>
                    
                    <button id="login-as-buyer-btn" class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 text-white py-4 rounded-lg hover:from-blue-700 hover:to-cyan-700 font-semibold text-lg transition-all transform hover:scale-105 shadow-lg">
                        <i class="fas fa-shopping-cart mr-2"></i>Login as Buyer
                        <div class="text-sm font-normal mt-1 opacity-90">Browse events & book tickets</div>
                    </button>
                </div>
                
                <div id="login-error" class="text-red-400 text-sm text-center mb-4 hidden"></div>
                
                <div class="text-center">
                    <p class="text-xs text-gray-500">
                        <i class="fas fa-info-circle mr-1"></i>Pre-seeded demo accounts â€¢ No registration required
                    </p>
                </div>
            </div>
        </div>

        <!-- Events Section -->
        <div id="events-section" class="fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-white">Upcoming Events</h2>
                <div id="admin-controls" class="hidden">
                    <button id="create-event-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        <i class="fas fa-plus mr-2"></i>Create Event
                    </button>
                </div>
            </div>
            <div id="events-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Events will be loaded here -->
            </div>
        </div>

        <!-- My Bookings Section -->
        <div id="bookings-section" class="hidden fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-white">My Bookings</h2>
                <button id="back-to-events-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Events
                </button>
            </div>
            <div id="bookings-container" class="space-y-4">
                <!-- Bookings will be loaded here -->
            </div>
        </div>

        <!-- Admin Section -->
        <div id="admin-section" class="hidden fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-white">Owner Dashboard</h2>
                <button id="back-to-events-btn-admin" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Events
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Hotels Management -->
                <div class="bg-gray-800/80 backdrop-blur-sm rounded-lg shadow-lg p-6 border border-gray-700">
                    <h3 class="text-xl font-bold mb-4 text-white">Hotels</h3>
                    <button id="manage-hotels-btn" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        Manage Hotels
                    </button>
                </div>
                <!-- Check-in (Owner Only) -->
                <div class="bg-gray-800/80 backdrop-blur-sm rounded-lg shadow-lg p-6 border border-gray-700">
                    <h3 class="text-xl font-bold mb-4 text-white">Scan & Check-in Tickets</h3>
                    <p class="text-sm text-gray-300 mb-4">As an event owner, you can scan QR codes to verify and check in tickets.</p>
                    <div class="space-y-2">
                        <input type="text" id="checkin-ticket-id" placeholder="Enter ticket ID or paste QR code data" 
                               class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg placeholder-gray-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-500">
                        <div class="flex space-x-2">
                            <button id="checkin-btn" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                <i class="fas fa-check mr-2"></i>Check In Ticket
                            </button>
                            <button id="scan-qr-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" title="Scan QR Code">
                                <i class="fas fa-qrcode"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="admin-events-container" class="space-y-4">
                <!-- Admin events will be loaded here -->
            </div>
        </div>
    </div>

    <!-- QR Code Scanner Modal (Owner Only) -->
    <div id="qr-scanner-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-gray-800/95 backdrop-blur-md rounded-lg p-8 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto border border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Scan Ticket QR Code</h2>
                <button id="close-qr-scanner" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <!-- Camera Scanner Section -->
            <div id="qr-camera-section" class="mb-4">
                <div class="mb-3 p-3 bg-blue-900/30 rounded-lg border border-blue-800/50">
                    <p class="text-sm text-blue-300"><i class="fas fa-camera mr-1"></i>Point your camera at the QR code to scan</p>
                </div>
                <div class="relative bg-black rounded-lg overflow-hidden" style="aspect-ratio: 1;">
                    <video id="qr-video" class="w-full h-full object-cover" autoplay playsinline></video>
                    <canvas id="qr-canvas" class="hidden"></canvas>
                    <div id="qr-scanning-overlay" class="absolute inset-0 pointer-events-none">
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="border-4 border-green-500 rounded-lg" style="width: 80%; height: 80%;">
                                <div class="absolute top-0 left-0 w-6 h-6 border-t-4 border-l-4 border-green-500"></div>
                                <div class="absolute top-0 right-0 w-6 h-6 border-t-4 border-r-4 border-green-500"></div>
                                <div class="absolute bottom-0 left-0 w-6 h-6 border-b-4 border-l-4 border-green-500"></div>
                                <div class="absolute bottom-0 right-0 w-6 h-6 border-b-4 border-r-4 border-green-500"></div>
                            </div>
                        </div>
                    </div>
                    <div id="qr-camera-status" class="absolute bottom-4 left-4 right-4 text-center">
                        <div id="qr-status-text" class="bg-black bg-opacity-50 text-white px-3 py-2 rounded text-sm">
                            Starting camera...
                        </div>
                    </div>
                </div>
                <div class="mt-3 flex justify-center space-x-2">
                    <button id="qr-switch-camera-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm">
                        <i class="fas fa-sync-alt mr-2"></i>Switch Camera
                    </button>
                    <button id="qr-stop-camera-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">
                        <i class="fas fa-stop mr-2"></i>Stop Camera
                    </button>
                </div>
            </div>
            
            <!-- Manual Entry Section -->
            <div class="border-t border-gray-700 pt-4 mt-4">
                <p class="text-sm text-gray-300 mb-3 text-center">Or enter manually:</p>
                <div id="qr-manual-entry" class="space-y-2">
                    <input type="text" id="qr-manual-input" placeholder="Paste QR code data here (format: ticket:xxx:booking:yyy)" 
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg placeholder-gray-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-500">
                    <button id="qr-verify-btn" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        <i class="fas fa-check mr-2"></i>Verify & Check In
                    </button>
                </div>
            </div>
            
            <div id="qr-result" class="hidden mt-4 p-4 bg-gray-700/50 rounded-lg border border-gray-600"></div>
        </div>
    </div>

    <!-- Event Detail Modal -->
    <div id="event-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden overflow-y-auto">
        <div class="bg-gray-800/95 backdrop-blur-md rounded-lg p-8 max-w-4xl w-full mx-4 my-8 border border-gray-700">
            <div class="flex justify-between items-start mb-6">
                <h2 id="event-detail-title" class="text-3xl font-bold text-white"></h2>
                <button id="close-event-modal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="event-detail-content" class="space-y-6">
                <!-- Event details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Create Event Modal -->
    <div id="create-event-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-gray-800/95 backdrop-blur-md rounded-lg p-8 max-w-2xl w-full mx-4 overflow-y-auto max-h-screen border border-gray-700">
            <h2 class="text-2xl font-bold mb-6 text-white">Create New Event</h2>
            <form id="create-event-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Event Name</label>
                    <input type="text" id="event-name" required 
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg placeholder-gray-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Venue</label>
                    <input type="text" id="event-venue" required 
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg placeholder-gray-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Description</label>
                    <textarea id="event-description" rows="3" 
                              class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg placeholder-gray-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Start Date & Time</label>
                    <input type="datetime-local" id="event-starts-at" required 
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Image URL</label>
                    <input type="url" id="event-image-url" 
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg placeholder-gray-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-500"
                           placeholder="https://images.unsplash.com/...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Published</label>
                    <input type="checkbox" id="event-published" 
                           class="w-4 h-4 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500">
                </div>
                <div id="ticket-tiers-container" class="space-y-4">
                    <h3 class="text-lg font-semibold text-white">Ticket Tiers</h3>
                    <div id="ticket-tiers-list">
                        <!-- Ticket tiers will be added here -->
                    </div>
                    <button type="button" id="add-tier-btn" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        <i class="fas fa-plus mr-2"></i>Add Tier
                    </button>
                </div>
                <div id="create-event-error" class="text-red-400 text-sm hidden"></div>
                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 font-semibold">
                        Create Event
                    </button>
                    <button type="button" id="cancel-create-event" class="flex-1 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let currentRole = null;
        let events = [];
        let bookings = [];

        // API base URL
        const API_BASE = '/experiments/event_zero';

        // Check authentication on page load
        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/auth/profile`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    currentUser = await response.json();
                    currentRole = currentUser.role;
                    updateUI();
                    loadEvents();
                    // Hide login modal if user is authenticated
                    hideLoginModal();
                } else if (response.status === 401) {
                    // User not authenticated - show login modal immediately
                    showLoginModal();
                } else {
                    // Other error - show login modal as fallback
                    showLoginModal();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                // On network errors or other issues, show login modal
                showLoginModal();
            }
        }

        // Update UI based on auth state
        function updateUI() {
            if (currentUser) {
                document.getElementById('user-email').textContent = currentUser.email;
                document.getElementById('user-email').classList.remove('hidden');
                document.getElementById('login-btn').classList.add('hidden');
                document.getElementById('logout-btn').classList.remove('hidden');
                document.getElementById('my-bookings-btn').classList.remove('hidden');
                
                if (currentRole === 'admin') {
                    document.getElementById('admin-btn').classList.remove('hidden');
                    document.getElementById('admin-controls').classList.remove('hidden');
                }
            } else {
                document.getElementById('user-email').classList.add('hidden');
                document.getElementById('logout-btn').classList.add('hidden');
                document.getElementById('my-bookings-btn').classList.add('hidden');
                document.getElementById('admin-btn').classList.add('hidden');
                document.getElementById('admin-controls').classList.add('hidden');
            }
        }

        // Login helper function
        async function performLogin(email, password, buttonElement) {
            const errorDiv = document.getElementById('login-error');
            errorDiv.classList.add('hidden');
            
            // Disable buttons during login
            const ownerBtn = document.getElementById('login-as-owner-btn');
            const buyerBtn = document.getElementById('login-as-buyer-btn');
            ownerBtn.disabled = true;
            buyerBtn.disabled = true;
            
            // Add loading state to clicked button
            const originalContent = buttonElement.innerHTML;
            buttonElement.innerHTML = '<span class="loading"></span> Logging in...';
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    await checkAuth();
                    hideLoginModal();
                } else {
                    const data = await response.json();
                    errorDiv.textContent = data.msg || 'Login failed';
                    errorDiv.classList.remove('hidden');
                    buttonElement.innerHTML = originalContent;
                }
            } catch (error) {
                errorDiv.textContent = 'Login failed: ' + error.message;
                errorDiv.classList.remove('hidden');
                buttonElement.innerHTML = originalContent;
            } finally {
                ownerBtn.disabled = false;
                buyerBtn.disabled = false;
            }
        }

        // Login as Owner (Admin)
        document.getElementById('login-as-owner-btn').addEventListener('click', async () => {
            await performLogin('admin@example.com', 'password123', document.getElementById('login-as-owner-btn'));
        });

        // Login as Buyer
        document.getElementById('login-as-buyer-btn').addEventListener('click', async () => {
            await performLogin('alice@example.com', 'password123', document.getElementById('login-as-buyer-btn'));
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            // Clear sub-auth session cookie
            document.cookie = 'event_zero_session_event_zero=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            currentUser = null;
            currentRole = null;
            updateUI();
            showLoginModal();
            document.getElementById('events-section').classList.remove('hidden');
            document.getElementById('bookings-section').classList.add('hidden');
            document.getElementById('admin-section').classList.add('hidden');
        });

        // Load events
        async function loadEvents() {
            try {
                const container = document.getElementById('events-container');
                container.innerHTML = '<div class="col-span-full text-center py-8"><div class="loading mx-auto"></div><p class="text-gray-300 mt-2">Loading events...</p></div>';
                
                const response = await fetch(`${API_BASE}/api/v1/events/`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    events = await response.json();
                    console.log('Events loaded:', events);
                    renderEvents();
                } else {
                    const errorText = await response.text();
                    console.error('Failed to load events:', response.status, errorText);
                    container.innerHTML = `<p class="text-red-400 col-span-full text-center py-8">Failed to load events: ${response.status}</p>`;
                }
            } catch (error) {
                console.error('Failed to load events:', error);
                const container = document.getElementById('events-container');
                container.innerHTML = `<p class="text-red-400 col-span-full text-center py-8">Error loading events: ${error.message}</p>`;
            }
        }

        // Render events
        function renderEvents() {
            const container = document.getElementById('events-container');
            if (events.length === 0) {
                container.innerHTML = '<p class="text-gray-300 col-span-full text-center py-8">No events available.</p>';
                return;
            }
            
            container.innerHTML = events.map(event => {
                const eventDate = new Date(event.starts_at * 1000);
                const imageUrl = event.image_url || 'https://placehold.co/600x400/6366f1/white?text=Event';
                
                return `
                    <div class="event-card bg-gray-800/80 backdrop-blur-sm rounded-lg shadow-lg overflow-hidden cursor-pointer border border-gray-700 hover:border-purple-500 transition-all" data-event-id="${event._id}">
                        <img src="${imageUrl}" alt="${event.name}" class="w-full h-48 object-cover">
                        <div class="p-6">
                            <h3 class="text-xl font-bold text-white mb-2">${event.name}</h3>
                            <p class="text-gray-300 mb-2">${event.venue}</p>
                            <p class="text-sm text-gray-400 mb-4">${eventDate.toLocaleDateString()} ${eventDate.toLocaleTimeString()}</p>
                            <button class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 view-event-btn" data-event-id="${event._id}">
                                View Details
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add click handlers
            document.querySelectorAll('.view-event-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const eventId = btn.dataset.eventId;
                    showEventDetail(eventId);
                });
            });
        }

        // Show event detail
        async function showEventDetail(eventId) {
            try {
                const response = await fetch(`${API_BASE}/api/v1/events/${eventId}`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    const event = await response.json();
                    renderEventDetail(event);
                    document.getElementById('event-detail-modal').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Failed to load event details:', error);
            }
        }

        // Render event detail
        function renderEventDetail(event) {
            const eventDate = new Date(event.starts_at * 1000);
            const imageUrl = event.image_url || 'https://placehold.co/600x400/6366f1/white?text=Event';
            
            document.getElementById('event-detail-title').textContent = event.name;
            
            const content = document.getElementById('event-detail-content');
            content.innerHTML = `
                <img src="${imageUrl}" alt="${event.name}" class="w-full h-64 object-cover rounded-lg mb-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <p class="text-sm text-gray-400">Venue</p>
                        <p class="text-lg font-semibold text-white">${event.venue}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Date & Time</p>
                        <p class="text-lg font-semibold text-white">${eventDate.toLocaleString()}</p>
                    </div>
                </div>
                <p class="text-gray-300 mb-6">${event.description || 'No description provided.'}</p>
                <h3 class="text-xl font-bold mb-4 text-white">Ticket Tiers</h3>
                <div id="ticket-tiers-selection" class="space-y-4 mb-6">
                    ${event.ticket_tiers.map(tier => {
                        const available = tier.capacity - tier.sold_count;
                        const hasHotel = tier.includes_hotel && tier.hotel_name;
                        return `
                            <div class="border border-gray-600 rounded-lg p-4 bg-gray-700/30 ${available === 0 ? 'opacity-50' : ''}">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <h4 class="font-semibold text-lg text-white">${tier.name}</h4>
                                        ${hasHotel ? `<p class="text-sm text-blue-300"><i class="fas fa-hotel mr-1"></i>Includes: ${tier.hotel_name} (${tier.nights_included} nights)</p>` : ''}
                                    </div>
                                    <div class="text-right">
                                        <p class="text-2xl font-bold text-purple-400">$${tier.price.toFixed(2)}</p>
                                        <p class="text-sm text-gray-300">${available} available</p>
                                    </div>
                                </div>
                                ${available > 0 ? `
                                    <div class="flex items-center space-x-4 mt-4">
                                        <label class="text-sm font-medium text-gray-300">Quantity:</label>
                                        <input type="number" min="1" max="${available}" value="0" 
                                               class="tier-quantity w-20 px-2 py-1 bg-gray-700 border border-gray-600 text-white rounded" 
                                               data-tier-id="${tier.id}" data-tier-price="${tier.price}">
                                    </div>
                                ` : '<p class="text-red-400 text-sm mt-2">Sold Out</p>'}
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="bg-gray-700/50 rounded-lg p-4 mb-4 border border-gray-600">
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-semibold text-white">Total:</span>
                        <span id="checkout-total" class="text-2xl font-bold text-purple-400">$0.00</span>
                    </div>
                </div>
                <button id="checkout-btn" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-semibold text-lg">
                    <i class="fas fa-shopping-cart mr-2"></i>Checkout
                </button>
            `;
            
            // Add quantity change handlers
            document.querySelectorAll('.tier-quantity').forEach(input => {
                input.addEventListener('change', updateCheckoutTotal);
            });
            
            // Add checkout handler
            document.getElementById('checkout-btn').addEventListener('click', () => {
                processCheckout(event._id);
            });
        }

        // Update checkout total
        function updateCheckoutTotal() {
            let total = 0;
            document.querySelectorAll('.tier-quantity').forEach(input => {
                const quantity = parseInt(input.value) || 0;
                const price = parseFloat(input.dataset.tierPrice);
                total += quantity * price;
            });
            document.getElementById('checkout-total').textContent = `$${total.toFixed(2)}`;
        }

        // Process checkout
        async function processCheckout(eventId) {
            const selections = [];
            document.querySelectorAll('.tier-quantity').forEach(input => {
                const quantity = parseInt(input.value) || 0;
                if (quantity > 0) {
                    selections.push({
                        tier_id: input.dataset.tierId,
                        quantity: quantity
                    });
                }
            });
            
            if (selections.length === 0) {
                alert('Please select at least one ticket.');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/bookings/checkout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        event_id: eventId,
                        selections: { tiers: selections }
                    })
                });
                
                if (response.ok) {
                    const booking = await response.json();
                    alert(`Booking successful! Booking ID: ${booking._id}`);
                    document.getElementById('event-detail-modal').classList.add('hidden');
                    loadEvents();
                } else {
                    const data = await response.json();
                    alert('Checkout failed: ' + (data.msg || data.detail || 'Unknown error'));
                }
            } catch (error) {
                alert('Checkout failed: ' + error.message);
            }
        }

        // Load bookings
        async function loadBookings() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/bookings`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    bookings = await response.json();
                    renderBookings();
                }
            } catch (error) {
                console.error('Failed to load bookings:', error);
            }
        }

        // Render bookings
        async function renderBookings() {
            const container = document.getElementById('bookings-container');
            if (bookings.length === 0) {
                container.innerHTML = '<p class="text-gray-300 text-center py-8">You have no bookings yet.</p>';
                return;
            }
            
            let html = '';
            for (const booking of bookings) {
                const event = events.find(e => e._id === booking.event_id) || { name: 'Unknown Event' };
                const bookingDate = new Date(booking.created_at * 1000);
                
                // Get tickets for this booking
                let tickets = [];
                try {
                    const ticketsResponse = await fetch(`${API_BASE}/api/v1/bookings/${booking._id}/tickets`, {
                        credentials: 'include'
                    });
                    if (ticketsResponse.ok) {
                        tickets = await ticketsResponse.json();
                    }
                } catch (error) {
                    console.error('Failed to load tickets:', error);
                }
                
                html += `
                    <div class="bg-gray-800/80 backdrop-blur-sm rounded-lg shadow-lg p-6 border border-gray-700">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-white">${event.name}</h3>
                                <p class="text-sm text-gray-300">Booking ID: ${booking._id}</p>
                                <p class="text-sm text-gray-300">Booked: ${bookingDate.toLocaleString()}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold text-green-400">$${booking.total_amount.toFixed(2)}</p>
                                <span class="px-3 py-1 bg-green-900/50 text-green-300 border border-green-700 rounded-full text-sm">${booking.status}</span>
                            </div>
                        </div>
                        <div class="mt-4">
                            <h4 class="font-semibold mb-2 text-white">Tickets (${tickets.length}):</h4>
                            <div class="space-y-2">
                                ${tickets.map(ticket => `
                                    <div class="p-3 bg-gray-700/50 rounded-lg border border-gray-600">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-medium text-white">${ticket.tier_name} - ${ticket._id}</span>
                                            <span class="px-2 py-1 ${ticket.status === 'checked_in' ? 'bg-green-900/50 text-green-300 border border-green-700' : 'bg-blue-900/50 text-blue-300 border border-blue-700'} rounded text-xs">
                                                ${ticket.status === 'checked_in' ? 'Checked In' : 'Valid'}
                                            </span>
                                        </div>
                                        <div id="qr-code-${ticket._id}" class="mt-2 flex justify-center">
                                            <div class="text-gray-400 text-sm">Loading QR code...</div>
                                        </div>
                                        ${ticket.lodging_details ? `
                                            <div class="mt-2 p-2 bg-blue-900/30 rounded text-sm text-blue-200 border border-blue-800/50">
                                                <i class="fas fa-hotel mr-1"></i>${ticket.lodging_details.hotel_name}
                                                <br>Check-in: ${ticket.lodging_details.check_in}
                                                <br>Check-out: ${ticket.lodging_details.check_out}
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // Load QR codes for all tickets
            for (const booking of bookings) {
                try {
                    const ticketsResponse = await fetch(`${API_BASE}/api/v1/bookings/${booking._id}/tickets`, {
                        credentials: 'include'
                    });
                    if (ticketsResponse.ok) {
                        const tickets = await ticketsResponse.json();
                        for (const ticket of tickets) {
                            await loadTicketQRCode(ticket._id);
                        }
                    }
                } catch (error) {
                    console.error('Failed to load tickets for QR codes:', error);
                }
            }
        }

        // Load QR code for a ticket
        async function loadTicketQRCode(ticketId) {
            try {
                const response = await fetch(`${API_BASE}/api/v1/tickets/${ticketId}/qrcode`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    const qrContainer = document.getElementById(`qr-code-${ticketId}`);
                    if (qrContainer && data.qr_code) {
                        qrContainer.innerHTML = `
                            <img src="${data.qr_code}" alt="QR Code" class="w-32 h-32 border-2 border-gray-300 rounded-lg">
                        `;
                    }
                } else {
                    const qrContainer = document.getElementById(`qr-code-${ticketId}`);
                    if (qrContainer) {
                        qrContainer.innerHTML = '<div class="text-red-400 text-xs">Failed to load QR code</div>';
                    }
                }
            } catch (error) {
                console.error(`Failed to load QR code for ticket ${ticketId}:`, error);
                const qrContainer = document.getElementById(`qr-code-${ticketId}`);
                if (qrContainer) {
                    qrContainer.innerHTML = '<div class="text-red-400 text-xs">Error loading QR code</div>';
                }
            }
        }

        // Show bookings
        document.getElementById('my-bookings-btn').addEventListener('click', () => {
            document.getElementById('events-section').classList.add('hidden');
            document.getElementById('admin-section').classList.add('hidden');
            document.getElementById('bookings-section').classList.remove('hidden');
            loadBookings();
        });

        // Back to events
        document.getElementById('back-to-events-btn').addEventListener('click', () => {
            document.getElementById('bookings-section').classList.add('hidden');
            document.getElementById('events-section').classList.remove('hidden');
        });

        // Admin section
        document.getElementById('admin-btn').addEventListener('click', async () => {
            document.getElementById('events-section').classList.add('hidden');
            document.getElementById('bookings-section').classList.add('hidden');
            document.getElementById('admin-section').classList.remove('hidden');
            
            // Load admin events
            try {
                const response = await fetch(`${API_BASE}/api/v1/admin/events/`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    const adminEvents = await response.json();
                    renderAdminEvents(adminEvents);
                }
            } catch (error) {
                console.error('Failed to load admin events:', error);
            }
        });

        // Render admin events
        function renderAdminEvents(adminEvents) {
            const container = document.getElementById('admin-events-container');
            if (adminEvents.length === 0) {
                container.innerHTML = '<p class="text-gray-300 text-center py-8">No events.</p>';
                return;
            }
            
            container.innerHTML = adminEvents.map(event => {
                const eventDate = new Date(event.starts_at * 1000);
                return `
                    <div class="bg-gray-800/80 backdrop-blur-sm rounded-lg shadow-lg p-6 border border-gray-700">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-white">${event.name}</h3>
                                <p class="text-gray-300">${event.venue}</p>
                                <p class="text-sm text-gray-400">${eventDate.toLocaleString()}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 edit-event-btn" data-event-id="${event._id}">
                                    Edit
                                </button>
                                <button class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 delete-event-btn" data-event-id="${event._id}">
                                    Delete
                                </button>
                            </div>
                        </div>
                        <p class="text-sm ${event.is_published ? 'text-green-400' : 'text-gray-400'}">
                            ${event.is_published ? 'Published' : 'Draft'}
                        </p>
                    </div>
                `;
            }).join('');
        }

        // Back to events from admin
        document.getElementById('back-to-events-btn-admin').addEventListener('click', () => {
            document.getElementById('admin-section').classList.add('hidden');
            document.getElementById('events-section').classList.remove('hidden');
        });

        // Check-in
        document.getElementById('checkin-btn').addEventListener('click', async () => {
            const ticketId = document.getElementById('checkin-ticket-id').value;
            if (!ticketId) {
                alert('Please enter a ticket ID');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/checkin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ ticket_id: ticketId })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`Check-in successful! ${result.msg}`);
                    document.getElementById('checkin-ticket-id').value = '';
                } else {
                    const data = await response.json();
                    alert('Check-in failed: ' + (data.msg || data.detail || 'Unknown error'));
                }
            } catch (error) {
                alert('Check-in failed: ' + error.message);
            }
        });

        // QR Scanner Modal - Camera setup
        let qrStream = null;
        let qrVideoElement = null;
        let qrCanvasElement = null;
        let qrCanvasContext = null;
        let qrScanningInterval = null;
        let qrUsingFrontCamera = false;

        async function startQRScanner() {
            qrVideoElement = document.getElementById('qr-video');
            qrCanvasElement = document.getElementById('qr-canvas');
            qrCanvasContext = qrCanvasElement.getContext('2d');
            
            try {
                // Request camera access
                const constraints = {
                    video: {
                        facingMode: qrUsingFrontCamera ? 'user' : 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                qrStream = await navigator.mediaDevices.getUserMedia(constraints);
                qrVideoElement.srcObject = qrStream;
                qrVideoElement.setAttribute('playsinline', 'true');
                
                qrVideoElement.addEventListener('loadedmetadata', () => {
                    qrCanvasElement.width = qrVideoElement.videoWidth;
                    qrCanvasElement.height = qrVideoElement.videoHeight;
                    updateQRStatus('Ready to scan');
                    startQRScanning();
                });
            } catch (error) {
                console.error('Error accessing camera:', error);
                updateQRStatus('Camera access denied. Please use manual entry.');
                document.getElementById('qr-camera-section').classList.add('hidden');
            }
        }

        function stopQRScanner() {
            if (qrScanningInterval) {
                clearInterval(qrScanningInterval);
                qrScanningInterval = null;
            }
            if (qrStream) {
                qrStream.getTracks().forEach(track => track.stop());
                qrStream = null;
            }
            if (qrVideoElement) {
                qrVideoElement.srcObject = null;
            }
        }

        function startQRScanning() {
            if (qrScanningInterval) return;
            
            qrScanningInterval = setInterval(() => {
                if (qrVideoElement.readyState === qrVideoElement.HAVE_ENOUGH_DATA) {
                    qrCanvasContext.drawImage(qrVideoElement, 0, 0, qrCanvasElement.width, qrCanvasElement.height);
                    const imageData = qrCanvasContext.getImageData(0, 0, qrCanvasElement.width, qrCanvasElement.height);
                    
                    if (typeof jsQR !== 'undefined') {
                        const code = jsQR(imageData.data, imageData.width, imageData.height);
                        if (code) {
                            updateQRStatus('QR Code detected!');
                            stopQRScanner();
                            verifyQRCode(code.data);
                        }
                    }
                }
            }, 100);
        }

        function updateQRStatus(message) {
            const statusText = document.getElementById('qr-status-text');
            if (statusText) {
                statusText.textContent = message;
            }
        }

        // QR Scanner Modal
        document.getElementById('scan-qr-btn').addEventListener('click', () => {
            document.getElementById('qr-scanner-modal').classList.remove('hidden');
            document.getElementById('qr-manual-input').value = '';
            document.getElementById('qr-result').classList.add('hidden');
            document.getElementById('qr-result').innerHTML = '';
            document.getElementById('qr-camera-section').classList.remove('hidden');
            startQRScanner();
        });

        document.getElementById('close-qr-scanner').addEventListener('click', () => {
            stopQRScanner();
            document.getElementById('qr-scanner-modal').classList.add('hidden');
        });

        // Switch camera
        document.getElementById('qr-switch-camera-btn').addEventListener('click', async () => {
            qrUsingFrontCamera = !qrUsingFrontCamera;
            stopQRScanner();
            await startQRScanner();
        });

        // Stop camera
        document.getElementById('qr-stop-camera-btn').addEventListener('click', () => {
            stopQRScanner();
            document.getElementById('qr-camera-section').classList.add('hidden');
            updateQRStatus('Camera stopped');
        });

        // Verify QR code manually
        document.getElementById('qr-verify-btn').addEventListener('click', async () => {
            const qrData = document.getElementById('qr-manual-input').value.trim();
            if (!qrData) {
                alert('Please enter QR code data');
                return;
            }
            
            await verifyQRCode(qrData);
        });

        // Verify QR code and auto-check-in
        async function verifyQRCode(qrData) {
            try {
                const response = await fetch(`${API_BASE}/api/v1/verify-qrcode`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ qr_data: qrData })
                });
                
                if (response.ok) {
                    const ticketInfo = await response.json();
                    const resultDiv = document.getElementById('qr-result');
                    resultDiv.classList.remove('hidden');
                    
                    if (ticketInfo.valid && ticketInfo.status !== 'checked_in') {
                        resultDiv.innerHTML = `
                            <div class="mb-4 text-white">
                                <h3 class="font-bold text-green-400 mb-2">âœ“ Valid Ticket</h3>
                                <p class="text-gray-300"><strong>Event:</strong> ${ticketInfo.event_name}</p>
                                <p class="text-gray-300"><strong>Tier:</strong> ${ticketInfo.tier_name}</p>
                                <p class="text-gray-300"><strong>Ticket ID:</strong> ${ticketInfo.ticket_id}</p>
                                <p class="text-gray-300"><strong>Status:</strong> ${ticketInfo.status}</p>
                            </div>
                            <button id="checkin-from-qr-btn" data-ticket-id="${ticketInfo.ticket_id}" 
                                    class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                <i class="fas fa-check mr-2"></i>Check In This Ticket
                            </button>
                        `;
                        
                        // Add event listener for check-in button
                        document.getElementById('checkin-from-qr-btn').addEventListener('click', async () => {
                            const ticketId = document.getElementById('checkin-from-qr-btn').dataset.ticketId;
                            try {
                                const checkinResponse = await fetch(`${API_BASE}/api/v1/checkin`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    credentials: 'include',
                                    body: JSON.stringify({ ticket_id: ticketId })
                                });
                                
                                if (checkinResponse.ok) {
                                    alert('Ticket checked in successfully!');
                                    document.getElementById('qr-scanner-modal').classList.add('hidden');
                                    document.getElementById('checkin-ticket-id').value = ticketId;
                                } else {
                                    const error = await checkinResponse.json();
                                    alert(`Error: ${error.detail || 'Failed to check in ticket'}`);
                                }
                            } catch (error) {
                                console.error('Check-in error:', error);
                                alert('Failed to check in ticket');
                            }
                        });
                    } else if (ticketInfo.status === 'checked_in') {
                        resultDiv.innerHTML = `
                            <div class="text-yellow-400">
                                <h3 class="font-bold mb-2">âš  Already Checked In</h3>
                                <p class="text-gray-300"><strong>Event:</strong> ${ticketInfo.event_name}</p>
                                <p class="text-gray-300"><strong>Tier:</strong> ${ticketInfo.tier_name}</p>
                                <p class="text-gray-300"><strong>Ticket ID:</strong> ${ticketInfo.ticket_id}</p>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="text-red-400">
                                <h3 class="font-bold mb-2">âœ— Invalid Ticket</h3>
                                <p class="text-gray-300">This ticket is not valid.</p>
                            </div>
                        `;
                    }
                } else {
                    const error = await response.json();
                    const resultDiv = document.getElementById('qr-result');
                    resultDiv.classList.remove('hidden');
                    resultDiv.innerHTML = `
                        <div class="text-red-400">
                            <h3 class="font-bold mb-2">âœ— Error</h3>
                            <p class="text-gray-300">${error.detail || 'Failed to verify QR code'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('QR verification error:', error);
                const resultDiv = document.getElementById('qr-result');
                resultDiv.classList.remove('hidden');
                resultDiv.innerHTML = `
                    <div class="text-red-600">
                        <h3 class="font-bold mb-2">âœ— Error</h3>
                        <p>Failed to verify QR code</p>
                    </div>
                `;
            }
        }

        // Allow pasting QR code data directly into check-in input
        document.getElementById('checkin-ticket-id').addEventListener('paste', async (e) => {
            setTimeout(async () => {
                const value = e.target.value.trim();
                // Check if it looks like QR code data (contains "ticket:" and "booking:")
                if (value.includes('ticket:') && value.includes('booking:')) {
                    await verifyQRCode(value);
                    // Open QR scanner modal to show result
                    document.getElementById('qr-scanner-modal').classList.remove('hidden');
                    document.getElementById('qr-manual-input').value = value;
                }
            }, 100);
        });

        // Modal handlers
        function showLoginModal() {
            document.getElementById('login-modal').classList.remove('hidden');
        }

        function hideLoginModal() {
            document.getElementById('login-modal').classList.add('hidden');
        }

        document.getElementById('login-btn').addEventListener('click', showLoginModal);
        document.getElementById('close-event-modal').addEventListener('click', () => {
            document.getElementById('event-detail-modal').classList.add('hidden');
        });

        // Initialize - check auth but don't block page rendering
        // If auth fails, the login modal will be shown
        checkAuth().catch(err => {
            console.error('Initial auth check failed:', err);
            // Still show the page, login modal will appear
        });
    </script>
    </div> <!-- End content-wrapper -->
</body>
</html>
