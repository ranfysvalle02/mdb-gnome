services:
  # --------------------------------------------------------------------------
  # FastAPI Web Application (The "Boss" / Ray Client)
  # --------------------------------------------------------------------------
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mlab-api
    platform: linux/arm64
    ports:
      - "5001:10000"
    volumes:
      # Mounts your local code (main.py, experiments/, etc.) into the container
      # This is what makes --reload work.
      - .:/app 
    env_file:
      - .env # Make sure .env contains your B2/AWS credentials
    command: >
      uvicorn main:app --host 0.0.0.0 --port 10000 --reload
    depends_on:
      mongo:
        condition: service_healthy
      

  # --------------------------------------------------------------------------
  # Ray Head Node (The "Factory Manager" / Ray Server)
  # CO-LOCATED WITH API FOR SIMPLICITY
  # --------------------------------------------------------------------------
  
  # --------------------------------------------------------------------------
  # MongoDB Database
  # --------------------------------------------------------------------------
  mongo:
    image: mongodb/mongodb-atlas-local:latest # Or a specific MongoDB version if needed
    container_name: mlab-mongo
    platform: linux/arm64 # Ensure ARM64 platform
    ports:
      - "27017:27017" # Map host port to container port
    volumes:
      - mongo-data:/data/db # Persist data across restarts
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.hello()", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

volumes:
  mongo-data: